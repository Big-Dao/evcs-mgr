<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>支付管理 - EVCS管理系统</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .payment-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
        }

        .payment-card {
            transition: all 0.3s ease;
            border: none;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            height: 100%;
        }

        .payment-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
        }

        .status-badge {
            font-size: 0.8rem;
            padding: 0.4rem 0.8rem;
        }

        .payment-stats {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .stat-item {
            text-align: center;
            padding: 0.5rem;
        }

        .stat-number {
            font-size: 1.5rem;
            font-weight: bold;
            color: #495057;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #6c757d;
        }

        .search-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .payment-method-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            margin-bottom: 0.5rem;
        }

        .alipay-icon {
            background: #1677ff;
            color: white;
        }

        .wechat-icon {
            background: #52c41a;
            color: white;
        }

        .card-icon {
            background: #fa8c16;
            color: white;
        }

        .balance-icon {
            background: #722ed1;
            color: white;
        }

        .revenue-chart {
            height: 300px;
            background: #f8f9fa;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6c757d;
        }

        .transaction-item {
            border-left: 4px solid #007bff;
            background: #f8f9fa;
            padding: 1rem;
            margin-bottom: 0.5rem;
            border-radius: 0 8px 8px 0;
        }

        .transaction-item.success {
            border-left-color: #28a745;
        }

        .transaction-item.failed {
            border-left-color: #dc3545;
        }

        .transaction-item.refund {
            border-left-color: #ffc107;
        }

        .payment-config-item {
            background: #e3f2fd;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            border: 1px solid #bbdefb;
        }

        .config-status {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 0.5rem;
        }

        .config-status.enabled {
            background: #28a745;
        }

        .config-status.disabled {
            background: #dc3545;
        }

        .amount-display {
            font-size: 1.25rem;
            font-weight: bold;
        }

        .amount-display.positive {
            color: #28a745;
        }

        .amount-display.negative {
            color: #dc3545;
        }
    </style>
</head>
<body>
    <!-- 导航栏 -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/admin/dashboard">
                <i class="bi bi-ev-station"></i> EVCS管理后台
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/dashboard">
                            <i class="bi bi-speedometer2"></i> 仪表盘
                        </a>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" data-bs-toggle="dropdown">
                            <i class="bi bi-people"></i> 用户管理
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="/admin/users">用户管理</a></li>
                            <li><a class="dropdown-item" href="/admin/roles">角色管理</a></li>
                            <li><a class="dropdown-item" href="/admin/permissions">权限管理</a></li>
                        </ul>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/tenants">
                            <i class="bi bi-building"></i> 租户管理
                        </a>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle active" href="#" data-bs-toggle="dropdown">
                            <i class="bi bi-ev-station"></i> 业务管理
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="/admin/stations">充电站管理</a></li>
                            <li><a class="dropdown-item" href="/admin/orders">订单管理</a></li>
                            <li><a class="dropdown-item active" href="/admin/payments">支付管理</a></li>
                        </ul>
                    </li>
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" data-bs-toggle="dropdown">
                            <i class="bi bi-person-circle"></i> 管理员
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="/admin/profile">个人资料</a></li>
                            <li><a class="dropdown-item" href="/admin/settings">系统设置</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="/logout">退出登录</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- 页面头部 -->
    <div class="payment-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="display-6 fw-bold mb-3">
                        <i class="bi bi-credit-card"></i> 支付管理
                    </h1>
                    <p class="lead mb-0">管理支付渠道配置，监控交易流水，处理退款申请</p>
                </div>
                <div class="col-md-4 text-md-end">
                    <button class="btn btn-light btn-lg" onclick="showPaymentConfigModal()">
                        <i class="bi bi-gear"></i> 支付配置
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- 统计概览 -->
        <div class="row mb-4">
            <div class="col-md-2">
                <div class="payment-stats">
                    <div class="stat-item">
                        <div class="stat-number text-primary" id="todayRevenue">¥0</div>
                        <div class="stat-label">今日收入</div>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="payment-stats">
                    <div class="stat-item">
                        <div class="stat-number text-success" id="monthRevenue">¥0</div>
                        <div class="stat-label">本月收入</div>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="payment-stats">
                    <div class="stat-item">
                        <div class="stat-number text-info" id="totalTransactions">0</div>
                        <div class="stat-label">总交易数</div>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="payment-stats">
                    <div class="stat-item">
                        <div class="stat-number text-warning" id="pendingRefunds">0</div>
                        <div class="stat-label">待处理退款</div>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="payment-stats">
                    <div class="stat-item">
                        <div class="stat-number text-danger" id="failedPayments">0</div>
                        <div class="stat-label">失败交易</div>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="payment-stats">
                    <div class="stat-item">
                        <div class="stat-number text-secondary" id="refundAmount">¥0</div>
                        <div class="stat-label">退款总额</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 支付渠道状态 -->
        <div class="row mb-4">
            <div class="col-12">
                <h5 class="mb-3">支付渠道状态</h5>
                <div class="row" id="paymentChannels">
                    <!-- 支付渠道将通过JavaScript动态生成 -->
                </div>
            </div>
        </div>

        <!-- 搜索和筛选 -->
        <div class="search-section">
            <div class="row g-3">
                <div class="col-md-3">
                    <label class="form-label">搜索交易</label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="bi bi-search"></i></span>
                        <input type="text" class="form-control" id="searchInput" placeholder="交易号、订单号、用户">
                    </div>
                </div>
                <div class="col-md-2">
                    <label class="form-label">支付方式</label>
                    <select class="form-select" id="paymentMethodFilter">
                        <option value="">全部方式</option>
                        <option value="ALIPAY">支付宝</option>
                        <option value="WECHAT">微信支付</option>
                        <option value="CARD">银行卡</option>
                        <option value="BALANCE">余额支付</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">交易状态</label>
                    <select class="form-select" id="statusFilter">
                        <option value="">全部状态</option>
                        <option value="SUCCESS">成功</option>
                        <option value="FAILED">失败</option>
                        <option value="PENDING">处理中</option>
                        <option value="REFUND">已退款</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">时间范围</label>
                    <select class="form-select" id="timeFilter">
                        <option value="TODAY">今天</option>
                        <option value="WEEK">本周</option>
                        <option value="MONTH">本月</option>
                        <option value="QUARTER">本季度</option>
                        <option value="YEAR">本年</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">&nbsp;</label>
                    <div class="btn-group w-100">
                        <button class="btn btn-primary" onclick="searchTransactions()">
                            <i class="bi bi-search"></i> 搜索
                        </button>
                        <button class="btn btn-outline-secondary" onclick="resetSearch()">
                            <i class="bi bi-arrow-clockwise"></i> 重置
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- 交易记录 -->
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">交易记录</h5>
                        <div class="btn-group btn-group-sm">
                            <button type="button" class="btn btn-outline-primary active" onclick="showTransactionList('all')">
                                全部
                            </button>
                            <button type="button" class="btn btn-outline-primary" onclick="showTransactionList('success')">
                                成功
                            </button>
                            <button type="button" class="btn btn-outline-primary" onclick="showTransactionList('failed')">
                                失败
                            </button>
                            <button type="button" class="btn btn-outline-primary" onclick="showTransactionList('refund')">
                                退款
                            </button>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div id="transactionList">
                            <!-- 交易列表将通过JavaScript动态生成 -->
                        </div>
                    </div>
                    <div class="card-footer">
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted" id="transactionSummary">共 0 条记录</small>
                            <nav>
                                <ul class="pagination pagination-sm mb-0" id="pagination">
                                    <!-- 分页按钮将通过JavaScript动态生成 -->
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 右侧面板 -->
            <div class="col-md-4">
                <!-- 收入趋势 -->
                <div class="card mb-3">
                    <div class="card-header">
                        <h6 class="mb-0">收入趋势</h6>
                    </div>
                    <div class="card-body">
                        <canvas id="revenueChart" width="400" height="200"></canvas>
                    </div>
                </div>

                <!-- 最近退款申请 -->
                <div class="card mb-3">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">退款申请</h6>
                        <button class="btn btn-sm btn-outline-primary" onclick="showAllRefunds()">
                            查看全部
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="refundList">
                            <!-- 退款列表将通过JavaScript动态生成 -->
                        </div>
                    </div>
                </div>

                <!-- 支付配置状态 -->
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">支付配置</h6>
                        <button class="btn btn-sm btn-outline-warning" onclick="showPaymentConfigModal()">
                            <i class="bi bi-gear"></i> 配置
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="paymentConfigStatus">
                            <!-- 支付配置状态将通过JavaScript动态生成 -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 支付配置模态框 -->
    <div class="modal fade" id="paymentConfigModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">支付渠道配置</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="payment-config-item">
                                <div class="d-flex justify-content-between align-items-start mb-3">
                                    <div>
                                        <h6>
                                            <i class="bi bi-alipay text-primary"></i> 支付宝支付
                                        </h6>
                                        <span class="config-status enabled"></span>
                                        <span class="text-muted">已启用</span>
                                    </div>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="alipayEnabled" checked>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">应用ID (APPID)</label>
                                            <input type="text" class="form-control" id="alipayAppId" placeholder="2021000000000000">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">商户号</label>
                                            <input type="text" class="form-control" id="alipayMerchantId" placeholder="2088000000000000">
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">公钥证书</label>
                                    <textarea class="form-control" id="alipayPublicKey" rows="3" placeholder="支付宝公钥内容"></textarea>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">私钥</label>
                                    <textarea class="form-control" id="alipayPrivateKey" rows="3" placeholder="应用私钥内容"></textarea>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">网关地址</label>
                                    <input type="text" class="form-control" id="alipayGateway" value="https://openapi.alipay.com/gateway.do">
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="payment-config-item">
                                <div class="d-flex justify-content-between align-items-start mb-3">
                                    <div>
                                        <h6>
                                            <i class="bi bi-wechat text-success"></i> 微信支付
                                        </h6>
                                        <span class="config-status enabled"></span>
                                        <span class="text-muted">已启用</span>
                                    </div>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="wechatEnabled" checked>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">应用ID</label>
                                            <input type="text" class="form-control" id="wechatAppId" placeholder="wx0000000000000000">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">商户号</label>
                                            <input type="text" class="form-control" id="wechatMerchantId" placeholder="1900000000">
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">API密钥</label>
                                    <input type="password" class="form-control" id="wechatApiKey" placeholder="微信支付API密钥">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">证书路径</label>
                                    <input type="text" class="form-control" id="wechatCertPath" placeholder="/path/to/cert.pem">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">回调地址</label>
                                    <input type="text" class="form-control" id="wechatNotifyUrl" placeholder="https://your-domain.com/api/payment/wechat/notify">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row mt-3">
                        <div class="col-md-6">
                            <div class="payment-config-item">
                                <div class="d-flex justify-content-between align-items-start mb-3">
                                    <div>
                                        <h6>
                                            <i class="bi bi-credit-card text-warning"></i> 银行卡支付
                                        </h6>
                                        <span class="config-status disabled"></span>
                                        <span class="text-muted">未启用</span>
                                    </div>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="cardEnabled">
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">商户号</label>
                                            <input type="text" class="form-control" id="cardMerchantId" placeholder="898000000000000">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">终端号</label>
                                            <input type="text" class="form-control" id="cardTerminalId" placeholder="00000001">
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">机构代码</label>
                                    <input type="text" class="form-control" id="cardOrgCode" placeholder="102100099999">
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="payment-config-item">
                                <div class="d-flex justify-content-between align-items-start mb-3">
                                    <div>
                                        <h6>
                                            <i class="bi bi-wallet text-info"></i> 余额支付
                                        </h6>
                                        <span class="config-status enabled"></span>
                                        <span class="text-muted">已启用</span>
                                    </div>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="balanceEnabled" checked>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">最小充值金额</label>
                                    <input type="number" class="form-control" id="minRecharge" value="10" min="1">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">最大充值金额</label>
                                    <input type="number" class="form-control" id="maxRecharge" value="10000" min="1">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">每日充值限额</label>
                                    <input type="number" class="form-control" id="dailyRechargeLimit" value="50000" min="1">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="testPaymentConfig()">
                        <i class="bi bi-check-circle"></i> 测试连接
                    </button>
                    <button type="button" class="btn btn-success" onclick="savePaymentConfig()">
                        <i class="bi bi-save"></i> 保存配置
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 交易详情模态框 -->
    <div class="modal fade" id="transactionDetailModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">交易详情</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="transactionDetailContent">
                    <!-- 交易详情将通过JavaScript动态生成 -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                    <button type="button" class="btn btn-info" onclick="retryPayment()">
                        <i class="bi bi-arrow-clockwise"></i> 重试支付
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // 模拟交易数据
        const mockTransactions = [
            {
                id: "TXN202411010001",
                orderId: "ORD202411010001",
                userId: 1001,
                userName: "张三",
                amount: 57.50,
                paymentMethod: "ALIPAY",
                status: "SUCCESS",
                transactionId: "2024110122001234567890",
                thirdPartyTransactionId: "2024110122001234567890123456",
                createTime: "2024-11-01 09:15:05",
                completeTime: "2024-11-01 09:15:08",
                description: "充电服务费"
            },
            {
                id: "TXN202411010002",
                orderId: "ORD202411010002",
                userId: 1002,
                userName: "李四",
                amount: 100.00,
                paymentMethod: "WECHAT",
                status: "PENDING",
                transactionId: "TXN202411010002",
                thirdPartyTransactionId: null,
                createTime: "2024-11-01 10:30:02",
                completeTime: null,
                description: "充电预付款"
            },
            {
                id: "TXN202411010003",
                orderId: "ORD202411010003",
                userId: 1003,
                userName: "王五",
                amount: 8.00,
                paymentMethod: "BALANCE",
                status: "REFUND",
                transactionId: "TXN202411010003",
                thirdPartyTransactionId: null,
                createTime: "2024-11-01 08:45:10",
                completeTime: "2024-11-01 09:15:00",
                description: "充电服务费退款"
            },
            {
                id: "TXN202411010004",
                orderId: "ORD202411010004",
                userId: 1004,
                userName: "赵六",
                amount: 120.00,
                paymentMethod: "ALIPAY",
                status: "FAILED",
                transactionId: "TXN202411010004",
                thirdPartyTransactionId: "2024110122001234567890987654",
                createTime: "2024-11-01 11:20:30",
                completeTime: "2024-11-01 11:20:35",
                description: "充电服务费",
                errorMessage: "账户余额不足"
            }
        ];

        // 模拟退款申请数据
        const mockRefunds = [
            {
                id: "REF202411010001",
                transactionId: "TXN202411010001",
                amount: 57.50,
                reason: "充电故障",
                status: "PENDING",
                applicant: "张三",
                applyTime: "2024-11-01 12:00:00"
            }
        ];

        let currentTransactions = [...mockTransactions];
        let currentRefunds = [...mockRefunds];
        let currentTransactionDetail = null;
        let currentPage = 1;
        const itemsPerPage = 10;
        let currentView = 'all';

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            loadTransactions();
            updateStatistics();
            renderPaymentChannels();
            renderRefundList();
            renderPaymentConfigStatus();
            initRevenueChart();
        });

        // 初始化收入图表
        function initRevenueChart() {
            const ctx = document.getElementById('revenueChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['周一', '周二', '周三', '周四', '周五', '周六', '周日'],
                    datasets: [{
                        label: '收入',
                        data: [1200, 1900, 1500, 2500, 2200, 3000, 2800],
                        borderColor: '#007bff',
                        backgroundColor: 'rgba(0, 123, 255, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '¥' + value;
                                }
                            }
                        }
                    }
                }
            });
        }

        // 加载交易记录
        function loadTransactions() {
            renderTransactions();
            renderPagination();
        }

        // 渲染交易记录
        function renderTransactions() {
            const transactionList = document.getElementById('transactionList');
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;

            // 根据当前视图筛选交易
            let filteredTransactions = currentTransactions;
            if (currentView === 'success') {
                filteredTransactions = currentTransactions.filter(t => t.status === 'SUCCESS');
            } else if (currentView === 'failed') {
                filteredTransactions = currentTransactions.filter(t => t.status === 'FAILED');
            } else if (currentView === 'refund') {
                filteredTransactions = currentTransactions.filter(t => t.status === 'REFUND');
            }

            const pageTransactions = filteredTransactions.slice(startIndex, endIndex);

            if (pageTransactions.length === 0) {
                transactionList.innerHTML = `
                    <div class="text-center py-4">
                        <i class="bi bi-inbox fs-1 text-muted"></i>
                        <p class="text-muted mt-2">暂无交易记录</p>
                    </div>
                `;
                return;
            }

            transactionList.innerHTML = pageTransactions.map(transaction => `
                <div class="transaction-item ${transaction.status.toLowerCase()}">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <div class="d-flex align-items-center mb-1">
                                ${getPaymentMethodIcon(transaction.paymentMethod)}
                                <strong class="ms-2">${transaction.id}</strong>
                                ${getTransactionStatusBadge(transaction.status)}
                            </div>
                            <p class="mb-1">
                                <small class="text-muted">订单号：${transaction.orderId}</small>
                            </p>
                            <p class="mb-1">
                                <small class="text-muted">用户：${transaction.userName}</small>
                            </p>
                            <p class="mb-0">
                                <small class="text-muted">${formatDate(transaction.createTime)}</small>
                            </p>
                        </div>
                        <div class="text-end">
                            <div class="amount-display ${transaction.status === 'REFUND' ? 'negative' : 'positive'}">
                                ${transaction.status === 'REFUND' ? '-' : '+'}¥${transaction.amount.toFixed(2)}
                            </div>
                            <button class="btn btn-sm btn-outline-info mt-1" onclick="showTransactionDetail('${transaction.id}')">
                                详情
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');

            // 更新统计信息
            document.getElementById('transactionSummary').textContent = `共 ${filteredTransactions.length} 条记录`;
        }

        // 渲染分页
        function renderPagination() {
            const pagination = document.getElementById('pagination');

            // 根据当前视图计算总页数
            let filteredTransactions = currentTransactions;
            if (currentView === 'success') {
                filteredTransactions = currentTransactions.filter(t => t.status === 'SUCCESS');
            } else if (currentView === 'failed') {
                filteredTransactions = currentTransactions.filter(t => t.status === 'FAILED');
            } else if (currentView === 'refund') {
                filteredTransactions = currentTransactions.filter(t => t.status === 'REFUND');
            }

            const totalPages = Math.ceil(filteredTransactions.length / itemsPerPage);
            if (totalPages <= 1) {
                pagination.innerHTML = '';
                return;
            }

            let paginationHTML = '';

            // 上一页
            paginationHTML += `
                <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="changePage(${currentPage - 1})">上一页</a>
                </li>
            `;

            // 页码
            for (let i = 1; i <= totalPages; i++) {
                paginationHTML += `
                    <li class="page-item ${i === currentPage ? 'active' : ''}">
                        <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
                    </li>
                `;
            }

            // 下一页
            paginationHTML += `
                <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="changePage(${currentPage + 1})">下一页</a>
                </li>
            `;

            pagination.innerHTML = paginationHTML;
        }

        // 切换页面
        function changePage(page) {
            let filteredTransactions = currentTransactions;
            if (currentView === 'success') {
                filteredTransactions = currentTransactions.filter(t => t.status === 'SUCCESS');
            } else if (currentView === 'failed') {
                filteredTransactions = currentTransactions.filter(t => t.status === 'FAILED');
            } else if (currentView === 'refund') {
                filteredTransactions = currentTransactions.filter(t => t.status === 'REFUND');
            }

            const totalPages = Math.ceil(filteredTransactions.length / itemsPerPage);
            if (page < 1 || page > totalPages) return;

            currentPage = page;
            renderTransactions();
            renderPagination();
        }

        // 显示交易列表视图
        function showTransactionList(view) {
            currentView = view;
            currentPage = 1;

            // 更新按钮状态
            document.querySelectorAll('.btn-group .btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            renderTransactions();
            renderPagination();
        }

        // 渲染支付渠道
        function renderPaymentChannels() {
            const channels = document.getElementById('paymentChannels');
            const channelData = [
                { name: '支付宝支付', method: 'ALIPAY', icon: 'bi-alipay', color: 'primary', enabled: true, transactions: 45 },
                { name: '微信支付', method: 'WECHAT', icon: 'bi-wechat', color: 'success', enabled: true, transactions: 32 },
                { name: '银行卡支付', method: 'CARD', icon: 'bi-credit-card', color: 'warning', enabled: false, transactions: 0 },
                { name: '余额支付', method: 'BALANCE', icon: 'bi-wallet', color: 'info', enabled: true, transactions: 18 }
            ];

            channels.innerHTML = channelData.map(channel => `
                <div class="col-md-3">
                    <div class="card payment-card">
                        <div class="card-body text-center">
                            <div class="payment-method-icon ${channel.color}-icon">
                                <i class="bi ${channel.icon}"></i>
                            </div>
                            <h6 class="card-title">${channel.name}</h6>
                            <div class="mb-2">
                                <span class="badge bg-${channel.enabled ? 'success' : 'secondary'}">
                                    ${channel.enabled ? '正常' : '未启用'}
                                </span>
                            </div>
                            <p class="card-text text-muted">
                                今日交易：${channel.transactions} 笔
                            </p>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // 渲染退款列表
        function renderRefundList() {
            const refundList = document.getElementById('refundList');

            if (currentRefunds.length === 0) {
                refundList.innerHTML = `
                    <p class="text-muted text-center">暂无退款申请</p>
                `;
                return;
            }

            refundList.innerHTML = currentRefunds.slice(0, 3).map(refund => `
                <div class="alert alert-warning mb-2">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <strong>${refund.applicant}</strong>
                            <br>
                            <small class="text-muted">退款金额：¥${refund.amount.toFixed(2)}</small>
                            <br>
                            <small class="text-muted">原因：${refund.reason}</small>
                        </div>
                        <button class="btn btn-sm btn-outline-primary" onclick="processRefund('${refund.id}')">
                            处理
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // 渲染支付配置状态
        function renderPaymentConfigStatus() {
            const configStatus = document.getElementById('paymentConfigStatus');
            const configs = [
                { name: '支付宝支付', enabled: true },
                { name: '微信支付', enabled: true },
                { name: '银行卡支付', enabled: false },
                { name: '余额支付', enabled: true }
            ];

            configStatus.innerHTML = configs.map(config => `
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span>${config.name}</span>
                    <span class="badge bg-${config.enabled ? 'success' : 'secondary'}">
                        ${config.enabled ? '已启用' : '未启用'}
                    </span>
                </div>
            `).join('');
        }

        // 获取交易状态徽章
        function getTransactionStatusBadge(status) {
            const statusConfig = {
                SUCCESS: { color: 'success', text: '成功' },
                FAILED: { color: 'danger', text: '失败' },
                PENDING: { color: 'warning', text: '处理中' },
                REFUND: { color: 'info', text: '已退款' }
            };

            const config = statusConfig[status] || statusConfig.PENDING;
            return `<span class="badge bg-${config.color} ms-2">${config.text}</span>`;
        }

        // 获取支付方式图标
        function getPaymentMethodIcon(method) {
            const icons = {
                ALIPAY: '<i class="bi bi-alipay text-primary"></i>',
                WECHAT: '<i class="bi bi-wechat text-success"></i>',
                CARD: '<i class="bi bi-credit-card text-warning"></i>',
                BALANCE: '<i class="bi bi-wallet text-info"></i>'
            };
            return icons[method] || '';
        }

        // 格式化日期
        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
        }

        // 更新统计信息
        function updateStatistics() {
            const today = new Date().toDateString();
            const todayTransactions = currentTransactions.filter(t =>
                new Date(t.createTime).toDateString() === today && t.status === 'SUCCESS'
            );
            const todayRevenue = todayTransactions.reduce((sum, t) => sum + t.amount, 0);

            const currentMonth = new Date().getMonth();
            const monthTransactions = currentTransactions.filter(t =>
                new Date(t.createTime).getMonth() === currentMonth && t.status === 'SUCCESS'
            );
            const monthRevenue = monthTransactions.reduce((sum, t) => sum + t.amount, 0);

            const totalTransactions = currentTransactions.filter(t => t.status === 'SUCCESS').length;
            const pendingRefunds = currentRefunds.filter(r => r.status === 'PENDING').length;
            const failedPayments = currentTransactions.filter(t => t.status === 'FAILED').length;
            const refundAmount = currentTransactions
                .filter(t => t.status === 'REFUND')
                .reduce((sum, t) => sum + t.amount, 0);

            document.getElementById('todayRevenue').textContent = `¥${todayRevenue.toFixed(2)}`;
            document.getElementById('monthRevenue').textContent = `¥${monthRevenue.toFixed(2)}`;
            document.getElementById('totalTransactions').textContent = totalTransactions;
            document.getElementById('pendingRefunds').textContent = pendingRefunds;
            document.getElementById('failedPayments').textContent = failedPayments;
            document.getElementById('refundAmount').textContent = `¥${refundAmount.toFixed(2)}`;
        }

        // 搜索交易
        function searchTransactions() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const paymentMethod = document.getElementById('paymentMethodFilter').value;
            const status = document.getElementById('statusFilter').value;
            const time = document.getElementById('timeFilter').value;

            currentTransactions = mockTransactions.filter(transaction => {
                const matchSearch = !searchTerm ||
                    transaction.id.toLowerCase().includes(searchTerm) ||
                    transaction.orderId.toLowerCase().includes(searchTerm) ||
                    transaction.userName.toLowerCase().includes(searchTerm);

                const matchPaymentMethod = !paymentMethod || transaction.paymentMethod === paymentMethod;
                const matchStatus = !status || transaction.status === status;

                // 时间筛选（简化实现）
                let matchTime = true;
                if (time === 'TODAY') {
                    const today = new Date().toDateString();
                    matchTime = new Date(transaction.createTime).toDateString() === today;
                } else if (time === 'WEEK') {
                    const weekAgo = new Date();
                    weekAgo.setDate(weekAgo.getDate() - 7);
                    matchTime = new Date(transaction.createTime) >= weekAgo;
                }

                return matchSearch && matchPaymentMethod && matchStatus && matchTime;
            });

            currentPage = 1;
            loadTransactions();
        }

        // 重置搜索
        function resetSearch() {
            document.getElementById('searchInput').value = '';
            document.getElementById('paymentMethodFilter').value = '';
            document.getElementById('statusFilter').value = '';
            document.getElementById('timeFilter').value = 'TODAY';

            currentTransactions = [...mockTransactions];
            currentPage = 1;
            loadTransactions();
        }

        // 显示支付配置模态框
        function showPaymentConfigModal() {
            const modal = new bootstrap.Modal(document.getElementById('paymentConfigModal'));
            modal.show();
        }

        // 测试支付配置
        function testPaymentConfig() {
            alert('正在测试支付配置连接...');
            // 模拟测试过程
            setTimeout(() => {
                alert('支付配置测试成功！所有连接正常。');
            }, 2000);
        }

        // 保存支付配置
        function savePaymentConfig() {
            alert('支付配置已保存！');
            const modal = bootstrap.Modal.getInstance(document.getElementById('paymentConfigModal'));
            modal.hide();
            renderPaymentConfigStatus();
        }

        // 显示交易详情
        function showTransactionDetail(transactionId) {
            const transaction = mockTransactions.find(t => t.id === transactionId);
            if (!transaction) return;

            currentTransactionDetail = transaction;

            const detailContent = document.getElementById('transactionDetailContent');
            detailContent.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>基本信息</h6>
                        <table class="table table-borderless">
                            <tr>
                                <td><strong>交易号：</strong></td>
                                <td>${transaction.id}</td>
                            </tr>
                            <tr>
                                <td><strong>订单号：</strong></td>
                                <td>${transaction.orderId}</td>
                            </tr>
                            <tr>
                                <td><strong>用户：</strong></td>
                                <td>${transaction.userName}</td>
                            </tr>
                            <tr>
                                <td><strong>金额：</strong></td>
                                <td class="amount-display ${transaction.status === 'REFUND' ? 'negative' : 'positive'}">
                                    ${transaction.status === 'REFUND' ? '-' : '+'}¥${transaction.amount.toFixed(2)}
                                </td>
                            </tr>
                            <tr>
                                <td><strong>支付方式：</strong></td>
                                <td>${getPaymentMethodIcon(transaction.paymentMethod)} ${getPaymentMethodName(transaction.paymentMethod)}</td>
                            </tr>
                            <tr>
                                <td><strong>状态：</strong></td>
                                <td>${getTransactionStatusBadge(transaction.status)}</td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6>时间信息</h6>
                        <table class="table table-borderless">
                            <tr>
                                <td><strong>创建时间：</strong></td>
                                <td>${formatDate(transaction.createTime)}</td>
                            </tr>
                            <tr>
                                <td><strong>完成时间：</strong></td>
                                <td>${transaction.completeTime ? formatDate(transaction.completeTime) : '未完成'}</td>
                            </tr>
                            <tr>
                                <td><strong>描述：</strong></td>
                                <td>${transaction.description}</td>
                            </tr>
                            ${transaction.errorMessage ? `
                                <tr>
                                    <td><strong>错误信息：</strong></td>
                                    <td class="text-danger">${transaction.errorMessage}</td>
                                </tr>
                            ` : ''}
                            ${transaction.thirdPartyTransactionId ? `
                                <tr>
                                    <td><strong>第三方交易号：</strong></td>
                                    <td>${transaction.thirdPartyTransactionId}</td>
                                </tr>
                            ` : ''}
                        </table>
                    </div>
                </div>
            `;

            const modal = new bootstrap.Modal(document.getElementById('transactionDetailModal'));
            modal.show();
        }

        // 获取支付方式名称
        function getPaymentMethodName(method) {
            const names = {
                ALIPAY: '支付宝',
                WECHAT: '微信支付',
                CARD: '银行卡',
                BALANCE: '余额支付'
            };
            return names[method] || method;
        }

        // 重试支付
        function retryPayment() {
            if (!currentTransactionDetail) return;

            alert(`正在重试交易 ${currentTransactionDetail.id} 的支付...`);

            // 模拟重试过程
            setTimeout(() => {
                alert('支付重试成功！');
                const modal = bootstrap.Modal.getInstance(document.getElementById('transactionDetailModal'));
                modal.hide();
            }, 2000);
        }

        // 处理退款
        function processRefund(refundId) {
            alert(`处理退款申请 ${refundId}`);
        }

        // 显示所有退款
        function showAllRefunds() {
            alert('跳转到退款管理页面');
        }
    </script>
</body>
</html>