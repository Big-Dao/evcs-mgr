<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>租户管理 - EVCS管理系统</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .tenant-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
        }

        .tenant-card {
            transition: all 0.3s ease;
            border: none;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            height: 100%;
        }

        .tenant-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
        }

        .status-badge {
            font-size: 0.8rem;
            padding: 0.4rem 0.8rem;
        }

        .tenant-stats {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .stat-item {
            text-align: center;
            padding: 0.5rem;
        }

        .stat-number {
            font-size: 1.5rem;
            font-weight: bold;
            color: #495057;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #6c757d;
        }

        .tenant-logo {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 10px;
            border: 3px solid #e9ecef;
        }

        .search-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .feature-tag {
            display: inline-block;
            background: #e3f2fd;
            color: #1976d2;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.75rem;
            margin: 0.1rem;
        }
    </style>
</head>
<body>
    <!-- 导航栏 -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/admin/dashboard">
                <i class="bi bi-ev-station"></i> EVCS管理后台
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/dashboard">
                            <i class="bi bi-speedometer2"></i> 仪表盘
                        </a>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" data-bs-toggle="dropdown">
                            <i class="bi bi-people"></i> 用户管理
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="/admin/users">用户管理</a></li>
                            <li><a class="dropdown-item" href="/admin/roles">角色管理</a></li>
                            <li><a class="dropdown-item" href="/admin/permissions">权限管理</a></li>
                        </ul>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/admin/tenants">
                            <i class="bi bi-building"></i> 租户管理
                        </a>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" data-bs-toggle="dropdown">
                            <i class="bi bi-ev-station"></i> 业务管理
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="/admin/stations">充电站管理</a></li>
                            <li><a class="dropdown-item" href="/admin/orders">订单管理</a></li>
                            <li><a class="dropdown-item" href="/admin/payments">支付管理</a></li>
                        </ul>
                    </li>
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" data-bs-toggle="dropdown">
                            <i class="bi bi-person-circle"></i> 管理员
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="/admin/profile">个人资料</a></li>
                            <li><a class="dropdown-item" href="/admin/settings">系统设置</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="/logout">退出登录</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- 页面头部 -->
    <div class="tenant-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="display-6 fw-bold mb-3">
                        <i class="bi bi-building"></i> 租户管理
                    </h1>
                    <p class="lead mb-0">管理多租户系统中的企业租户，配置租户权限和功能模块</p>
                </div>
                <div class="col-md-4 text-md-end">
                    <button class="btn btn-light btn-lg" onclick="showAddTenantModal()">
                        <i class="bi bi-plus-circle"></i> 新增租户
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- 搜索和筛选 -->
        <div class="search-section">
            <div class="row g-3">
                <div class="col-md-4">
                    <label class="form-label">搜索租户</label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="bi bi-search"></i></span>
                        <input type="text" class="form-control" id="searchInput" placeholder="租户名称、编码或联系人">
                    </div>
                </div>
                <div class="col-md-2">
                    <label class="form-label">状态</label>
                    <select class="form-select" id="statusFilter">
                        <option value="">全部状态</option>
                        <option value="1">正常</option>
                        <option value="0">禁用</option>
                        <option value="-1">过期</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">类型</label>
                    <select class="form-select" id="typeFilter">
                        <option value="">全部类型</option>
                        <option value="ENTERPRISE">企业租户</option>
                        <option value="TRIAL">试用租户</option>
                        <option value="DEMO">演示租户</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">排序</label>
                    <select class="form-select" id="sortBy">
                        <option value="createTime">创建时间</option>
                        <option value="name">租户名称</option>
                        <option value="userCount">用户数量</option>
                        <option value="expireTime">到期时间</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">&nbsp;</label>
                    <div class="btn-group w-100">
                        <button class="btn btn-primary" onclick="searchTenants()">
                            <i class="bi bi-search"></i> 搜索
                        </button>
                        <button class="btn btn-outline-secondary" onclick="resetSearch()">
                            <i class="bi bi-arrow-clockwise"></i> 重置
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 统计概览 -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="tenant-stats">
                    <div class="stat-item">
                        <div class="stat-number text-primary" id="totalCount">0</div>
                        <div class="stat-label">总租户数</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="tenant-stats">
                    <div class="stat-item">
                        <div class="stat-number text-success" id="activeCount">0</div>
                        <div class="stat-label">正常租户</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="tenant-stats">
                    <div class="stat-item">
                        <div class="stat-number text-warning" id="trialCount">0</div>
                        <div class="stat-label">试用租户</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="tenant-stats">
                    <div class="stat-item">
                        <div class="stat-number text-danger" id="expiredCount">0</div>
                        <div class="stat-label">过期租户</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 租户列表 -->
        <div class="row" id="tenantList">
            <!-- 租户卡片将通过JavaScript动态生成 -->
        </div>

        <!-- 分页 -->
        <nav aria-label="租户列表分页" class="mt-4">
            <ul class="pagination justify-content-center" id="pagination">
                <!-- 分页按钮将通过JavaScript动态生成 -->
            </ul>
        </nav>
    </div>

    <!-- 新增/编辑租户模态框 -->
    <div class="modal fade" id="tenantModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="tenantModalTitle">新增租户</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="tenantForm">
                        <input type="hidden" id="tenantId">

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">租户名称 <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="tenantName" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">租户编码 <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="tenantCode" required>
                                    <div class="form-text">租户的唯一标识码，创建后不可修改</div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">租户类型 <span class="text-danger">*</span></label>
                                    <select class="form-select" id="tenantType" required>
                                        <option value="">请选择类型</option>
                                        <option value="ENTERPRISE">企业租户</option>
                                        <option value="TRIAL">试用租户</option>
                                        <option value="DEMO">演示租户</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">状态</label>
                                    <select class="form-select" id="tenantStatus">
                                        <option value="1">正常</option>
                                        <option value="0">禁用</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">租户描述</label>
                            <textarea class="form-control" id="tenantDescription" rows="3" placeholder="描述租户的业务背景和主要用途"></textarea>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">联系人 <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="contactName" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">联系电话 <span class="text-danger">*</span></label>
                                    <input type="tel" class="form-control" id="contactPhone" required>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">联系邮箱</label>
                                    <input type="email" class="form-control" id="contactEmail">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">到期时间</label>
                                    <input type="date" class="form-control" id="expireTime">
                                    <div class="form-text">留空表示永不过期</div>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">可用功能模块</label>
                            <div class="row">
                                <div class="col-md-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="moduleUser" checked>
                                        <label class="form-check-label" for="moduleUser">用户管理</label>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="moduleStation" checked>
                                        <label class="form-check-label" for="moduleStation">充电站管理</label>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="moduleOrder" checked>
                                        <label class="form-check-label" for="moduleOrder">订单管理</label>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="modulePayment" checked>
                                        <label class="form-check-label" for="modulePayment">支付管理</label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">最大用户数</label>
                                    <input type="number" class="form-control" id="maxUsers" value="100" min="1">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">最大充电站数</label>
                                    <input type="number" class="form-control" id="maxStations" value="10" min="1">
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="saveTenant()">
                        <i class="bi bi-check-circle"></i> 保存
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 租户详情模态框 -->
    <div class="modal fade" id="tenantDetailModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">租户详情</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="tenantDetailContent">
                    <!-- 租户详情将通过JavaScript动态生成 -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                    <button type="button" class="btn btn-warning" onclick="editCurrentTenant()">
                        <i class="bi bi-pencil"></i> 编辑
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 模拟租户数据
        const mockTenants = [
            {
                id: 1,
                name: "智慧充电科技有限公司",
                code: "smartcharge",
                type: "ENTERPRISE",
                status: 1,
                description: "专注于新能源汽车充电服务的高科技企业",
                contactName: "张经理",
                contactPhone: "13800138001",
                contactEmail: "zhang@smartcharge.com",
                expireTime: "2025-12-31",
                logo: null,
                userCount: 45,
                stationCount: 12,
                maxUsers: 100,
                maxStations: 20,
                createTime: "2024-01-15",
                modules: ["user", "station", "order", "payment"]
            },
            {
                id: 2,
                name: "绿色能源充电站",
                code: "greenenergy",
                type: "TRIAL",
                status: 1,
                description: "试用租户，测试平台功能",
                contactName: "李先生",
                contactPhone: "13900139002",
                contactEmail: "li@greenenergy.com",
                expireTime: "2024-12-31",
                logo: null,
                userCount: 8,
                stationCount: 2,
                maxUsers: 10,
                maxStations: 5,
                createTime: "2024-06-01",
                modules: ["user", "station"]
            },
            {
                id: 3,
                name: "城市充电网络",
                code: "citycharge",
                type: "ENTERPRISE",
                status: 0,
                description: "城市级充电网络运营商",
                contactName: "王总",
                contactPhone: "13700137003",
                contactEmail: "wang@citycharge.com",
                expireTime: "2024-09-30",
                logo: null,
                userCount: 120,
                stationCount: 35,
                maxUsers: 200,
                maxStations: 50,
                createTime: "2023-03-20",
                modules: ["user", "station", "order", "payment"]
            }
        ];

        let currentTenants = [...mockTenants];
        let currentTenantDetail = null;
        let currentPage = 1;
        const itemsPerPage = 6;

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            loadTenants();
            updateStatistics();
        });

        // 加载租户列表
        function loadTenants() {
            renderTenants();
            renderPagination();
        }

        // 渲染租户卡片
        function renderTenants() {
            const tenantList = document.getElementById('tenantList');
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const pageTenants = currentTenants.slice(startIndex, endIndex);

            tenantList.innerHTML = pageTenants.map(tenant => `
                <div class="col-md-6 col-lg-4 mb-4">
                    <div class="card tenant-card">
                        <div class="card-body">
                            <div class="d-flex align-items-center mb-3">
                                <div class="me-3">
                                    ${tenant.logo ?
                                        `<img src="${tenant.logo}" alt="${tenant.name}" class="tenant-logo">` :
                                        `<div class="tenant-logo d-flex align-items-center justify-content-center bg-primary text-white">
                                            <i class="bi bi-building fs-4"></i>
                                        </div>`
                                    }
                                </div>
                                <div class="flex-grow-1">
                                    <h6 class="card-title mb-1">${tenant.name}</h6>
                                    <small class="text-muted">${tenant.code}</small>
                                </div>
                                <div>
                                    ${getStatusBadge(tenant.status, tenant.expireTime)}
                                </div>
                            </div>

                            <p class="card-text small text-muted mb-3">${tenant.description || '暂无描述'}</p>

                            <div class="row text-center mb-3">
                                <div class="col-6">
                                    <div class="stat-number text-primary">${tenant.userCount}</div>
                                    <div class="stat-label small">用户数</div>
                                </div>
                                <div class="col-6">
                                    <div class="stat-number text-success">${tenant.stationCount}</div>
                                    <div class="stat-label small">充电站</div>
                                </div>
                            </div>

                            <div class="mb-3">
                                ${tenant.modules.map(module => `
                                    <span class="feature-tag">${getModuleName(module)}</span>
                                `).join('')}
                            </div>

                            <div class="d-flex justify-content-between align-items-center">
                                <small class="text-muted">
                                    <i class="bi bi-person"></i> ${tenant.contactName}
                                </small>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-primary" onclick="showTenantDetail(${tenant.id})" title="查看详情">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                    <button class="btn btn-outline-warning" onclick="editTenant(${tenant.id})" title="编辑">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button class="btn btn-outline-danger" onclick="deleteTenant(${tenant.id})" title="删除">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // 渲染分页
        function renderPagination() {
            const pagination = document.getElementById('pagination');
            const totalPages = Math.ceil(currentTenants.length / itemsPerPage);

            let paginationHTML = '';

            // 上一页
            paginationHTML += `
                <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="changePage(${currentPage - 1})">上一页</a>
                </li>
            `;

            // 页码
            for (let i = 1; i <= totalPages; i++) {
                paginationHTML += `
                    <li class="page-item ${i === currentPage ? 'active' : ''}">
                        <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
                    </li>
                `;
            }

            // 下一页
            paginationHTML += `
                <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="changePage(${currentPage + 1})">下一页</a>
                </li>
            `;

            pagination.innerHTML = paginationHTML;
        }

        // 切换页面
        function changePage(page) {
            const totalPages = Math.ceil(currentTenants.length / itemsPerPage);
            if (page < 1 || page > totalPages) return;

            currentPage = page;
            renderTenants();
            renderPagination();
        }

        // 获取状态徽章
        function getStatusBadge(status, expireTime) {
            const now = new Date();
            const expire = new Date(expireTime);

            if (status === 0) {
                return '<span class="badge bg-secondary status-badge">禁用</span>';
            } else if (expire && expire < now) {
                return '<span class="badge bg-danger status-badge">已过期</span>';
            } else if (expire && (expire - now) / (1000 * 60 * 60 * 24) <= 30) {
                return '<span class="badge bg-warning status-badge">即将到期</span>';
            } else {
                return '<span class="badge bg-success status-badge">正常</span>';
            }
        }

        // 获取模块名称
        function getModuleName(module) {
            const moduleNames = {
                user: '用户管理',
                station: '充电站管理',
                order: '订单管理',
                payment: '支付管理'
            };
            return moduleNames[module] || module;
        }

        // 获取租户类型名称
        function getTenantTypeName(type) {
            const typeNames = {
                ENTERPRISE: '企业租户',
                TRIAL: '试用租户',
                DEMO: '演示租户'
            };
            return typeNames[type] || type;
        }

        // 更新统计信息
        function updateStatistics() {
            const now = new Date();

            document.getElementById('totalCount').textContent = currentTenants.length;
            document.getElementById('activeCount').textContent = currentTenants.filter(t =>
                t.status === 1 && (!t.expireTime || new Date(t.expireTime) > now)
            ).length;
            document.getElementById('trialCount').textContent = currentTenants.filter(t =>
                t.type === 'TRIAL'
            ).length;
            document.getElementById('expiredCount').textContent = currentTenants.filter(t =>
                t.expireTime && new Date(t.expireTime) < now
            ).length;
        }

        // 搜索租户
        function searchTenants() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const status = document.getElementById('statusFilter').value;
            const type = document.getElementById('typeFilter').value;

            currentTenants = mockTenants.filter(tenant => {
                const matchSearch = !searchTerm ||
                    tenant.name.toLowerCase().includes(searchTerm) ||
                    tenant.code.toLowerCase().includes(searchTerm) ||
                    tenant.contactName.toLowerCase().includes(searchTerm);

                const matchStatus = !status || tenant.status.toString() === status;
                const matchType = !type || tenant.type === type;

                return matchSearch && matchStatus && matchType;
            });

            // 排序
            const sortBy = document.getElementById('sortBy').value;
            currentTenants.sort((a, b) => {
                switch (sortBy) {
                    case 'name':
                        return a.name.localeCompare(b.name);
                    case 'userCount':
                        return b.userCount - a.userCount;
                    case 'expireTime':
                        return new Date(a.expireTime || '9999-12-31') - new Date(b.expireTime || '9999-12-31');
                    default:
                        return new Date(b.createTime) - new Date(a.createTime);
                }
            });

            currentPage = 1;
            loadTenants();
            updateStatistics();
        }

        // 重置搜索
        function resetSearch() {
            document.getElementById('searchInput').value = '';
            document.getElementById('statusFilter').value = '';
            document.getElementById('typeFilter').value = '';
            document.getElementById('sortBy').value = 'createTime';

            currentTenants = [...mockTenants];
            currentPage = 1;
            loadTenants();
            updateStatistics();
        }

        // 显示新增租户模态框
        function showAddTenantModal() {
            document.getElementById('tenantModalTitle').textContent = '新增租户';
            document.getElementById('tenantForm').reset();
            document.getElementById('tenantId').value = '';

            const modal = new bootstrap.Modal(document.getElementById('tenantModal'));
            modal.show();
        }

        // 编辑租户
        function editTenant(id) {
            const tenant = mockTenants.find(t => t.id === id);
            if (!tenant) return;

            document.getElementById('tenantModalTitle').textContent = '编辑租户';
            document.getElementById('tenantId').value = tenant.id;
            document.getElementById('tenantName').value = tenant.name;
            document.getElementById('tenantCode').value = tenant.code;
            document.getElementById('tenantType').value = tenant.type;
            document.getElementById('tenantStatus').value = tenant.status;
            document.getElementById('tenantDescription').value = tenant.description || '';
            document.getElementById('contactName').value = tenant.contactName;
            document.getElementById('contactPhone').value = tenant.contactPhone;
            document.getElementById('contactEmail').value = tenant.contactEmail || '';
            document.getElementById('expireTime').value = tenant.expireTime || '';
            document.getElementById('maxUsers').value = tenant.maxUsers;
            document.getElementById('maxStations').value = tenant.maxStations;

            // 设置功能模块
            document.getElementById('moduleUser').checked = tenant.modules.includes('user');
            document.getElementById('moduleStation').checked = tenant.modules.includes('station');
            document.getElementById('moduleOrder').checked = tenant.modules.includes('order');
            document.getElementById('modulePayment').checked = tenant.modules.includes('payment');

            const modal = new bootstrap.Modal(document.getElementById('tenantModal'));
            modal.show();
        }

        // 保存租户
        function saveTenant() {
            const tenantId = document.getElementById('tenantId').value;
            const tenantData = {
                name: document.getElementById('tenantName').value,
                code: document.getElementById('tenantCode').value,
                type: document.getElementById('tenantType').value,
                status: parseInt(document.getElementById('tenantStatus').value),
                description: document.getElementById('tenantDescription').value,
                contactName: document.getElementById('contactName').value,
                contactPhone: document.getElementById('contactPhone').value,
                contactEmail: document.getElementById('contactEmail').value,
                expireTime: document.getElementById('expireTime').value,
                maxUsers: parseInt(document.getElementById('maxUsers').value),
                maxStations: parseInt(document.getElementById('maxStations').value),
                modules: []
            };

            // 收集功能模块
            if (document.getElementById('moduleUser').checked) tenantData.modules.push('user');
            if (document.getElementById('moduleStation').checked) tenantData.modules.push('station');
            if (document.getElementById('moduleOrder').checked) tenantData.modules.push('order');
            if (document.getElementById('modulePayment').checked) tenantData.modules.push('payment');

            if (!tenantData.name || !tenantData.code || !tenantData.type || !tenantData.contactName || !tenantData.contactPhone) {
                alert('请填写所有必填字段！');
                return;
            }

            if (tenantId) {
                // 编辑现有租户
                const index = mockTenants.findIndex(t => t.id == tenantId);
                if (index !== -1) {
                    mockTenants[index] = { ...mockTenants[index], ...tenantData };
                    alert('租户信息更新成功！');
                }
            } else {
                // 新增租户
                const newTenant = {
                    id: Math.max(...mockTenants.map(t => t.id)) + 1,
                    ...tenantData,
                    userCount: 0,
                    stationCount: 0,
                    createTime: new Date().toISOString().split('T')[0]
                };
                mockTenants.push(newTenant);
                alert('租户创建成功！');
            }

            // 关闭模态框并刷新列表
            const modal = bootstrap.Modal.getInstance(document.getElementById('tenantModal'));
            modal.hide();

            currentTenants = [...mockTenants];
            loadTenants();
            updateStatistics();
        }

        // 显示租户详情
        function showTenantDetail(id) {
            const tenant = mockTenants.find(t => t.id === id);
            if (!tenant) return;

            currentTenantDetail = tenant;

            const detailContent = document.getElementById('tenantDetailContent');
            detailContent.innerHTML = `
                <div class="row">
                    <div class="col-md-8">
                        <div class="card mb-3">
                            <div class="card-header">
                                <h6 class="mb-0">基本信息</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <p><strong>租户名称：</strong>${tenant.name}</p>
                                        <p><strong>租户编码：</strong>${tenant.code}</p>
                                        <p><strong>租户类型：</strong>${getTenantTypeName(tenant.type)}</p>
                                        <p><strong>当前状态：</strong>${getStatusBadge(tenant.status, tenant.expireTime)}</p>
                                    </div>
                                    <div class="col-md-6">
                                        <p><strong>联系人：</strong>${tenant.contactName}</p>
                                        <p><strong>联系电话：</strong>${tenant.contactPhone}</p>
                                        <p><strong>联系邮箱：</strong>${tenant.contactEmail || '未设置'}</p>
                                        <p><strong>到期时间：</strong>${tenant.expireTime || '永不过期'}</p>
                                    </div>
                                </div>
                                <p><strong>描述：</strong>${tenant.description || '暂无描述'}</p>
                            </div>
                        </div>

                        <div class="card mb-3">
                            <div class="card-header">
                                <h6 class="mb-0">使用情况</h6>
                            </div>
                            <div class="card-body">
                                <div class="row text-center">
                                    <div class="col-md-3">
                                        <div class="stat-number text-primary">${tenant.userCount}/${tenant.maxUsers}</div>
                                        <div class="stat-label">用户使用情况</div>
                                        <div class="progress mt-2">
                                            <div class="progress-bar" style="width: ${(tenant.userCount/tenant.maxUsers)*100}%"></div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="stat-number text-success">${tenant.stationCount}/${tenant.maxStations}</div>
                                        <div class="stat-label">充电站使用情况</div>
                                        <div class="progress mt-2">
                                            <div class="progress-bar bg-success" style="width: ${(tenant.stationCount/tenant.maxStations)*100}%"></div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="stat-number text-info">${tenant.modules.length}</div>
                                        <div class="stat-label">启用模块数</div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="stat-number text-warning">${new Date(tenant.createTime).toLocaleDateString()}</div>
                                        <div class="stat-label">创建时间</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">可用功能模块</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    ${tenant.modules.map(module => `
                                        <div class="col-md-3 mb-2">
                                            <div class="alert alert-success py-2 text-center">
                                                <i class="bi bi-check-circle"></i> ${getModuleName(module)}
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">快速操作</h6>
                            </div>
                            <div class="card-body">
                                <div class="d-grid gap-2">
                                    <button class="btn btn-primary" onclick="editCurrentTenant()">
                                        <i class="bi bi-pencil"></i> 编辑租户
                                    </button>
                                    <button class="btn btn-info" onclick="manageTenantUsers(${tenant.id})">
                                        <i class="bi bi-people"></i> 管理用户
                                    </button>
                                    <button class="btn btn-success" onclick="manageTenantStations(${tenant.id})">
                                        <i class="bi bi-ev-station"></i> 管理充电站
                                    </button>
                                    <button class="btn btn-warning" onclick="exportTenantData(${tenant.id})">
                                        <i class="bi bi-download"></i> 导出数据
                                    </button>
                                    <hr>
                                    <button class="btn btn-outline-danger" onclick="deleteTenant(${tenant.id})">
                                        <i class="bi bi-trash"></i> 删除租户
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="card mt-3">
                            <div class="card-header">
                                <h6 class="mb-0">系统信息</h6>
                            </div>
                            <div class="card-body">
                                <p><strong>租户ID：</strong>${tenant.id}</p>
                                <p><strong>创建时间：</strong>${tenant.createTime}</p>
                                <p><strong>最后更新：</strong>${new Date().toLocaleDateString()}</p>
                                <p><strong>数据库名称：</strong>evcs_tenant_${tenant.code}</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            const modal = new bootstrap.Modal(document.getElementById('tenantDetailModal'));
            modal.show();
        }

        // 编辑当前租户（从详情页面）
        function editCurrentTenant() {
            const detailModal = bootstrap.Modal.getInstance(document.getElementById('tenantDetailModal'));
            detailModal.hide();
            editTenant(currentTenantDetail.id);
        }

        // 管理租户用户
        function manageTenantUsers(tenantId) {
            alert(`跳转到租户 ${tenantId} 的用户管理页面`);
        }

        // 管理租户充电站
        function manageTenantStations(tenantId) {
            alert(`跳转到租户 ${tenantId} 的充电站管理页面`);
        }

        // 导出租户数据
        function exportTenantData(tenantId) {
            alert(`导出租户 ${tenantId} 的数据`);
        }

        // 删除租户
        function deleteTenant(id) {
            if (!confirm('确定要删除此租户吗？此操作不可恢复！')) {
                return;
            }

            const index = mockTenants.findIndex(t => t.id === id);
            if (index !== -1) {
                const tenant = mockTenants[index];
                mockTenants.splice(index, 1);
                currentTenants = [...mockTenants];
                loadTenants();
                updateStatistics();
                alert(`租户 "${tenant.name}" 已删除`);
            }
        }
    </script>
</body>
</html>