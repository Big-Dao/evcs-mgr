<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.evcs.tenant.mapper.DashboardMapper">
    
    <!-- 统计租户数量（当前租户及其子租户） -->
    <select id="countTenants" resultType="java.lang.Long">
        SELECT COUNT(*)
        FROM sys_tenant
        WHERE deleted = 0
        AND status = 1
        AND (id = #{tenantId} OR parent_id = #{tenantId})
    </select>
    
    <!-- 统计用户数量 -->
    <select id="countUsers" resultType="java.lang.Long">
        SELECT COUNT(*)
        FROM sys_user
        WHERE deleted = 0
        AND status = 1
        AND tenant_id IN (
            SELECT id FROM sys_tenant 
            WHERE deleted = 0 
            AND (id = #{tenantId} OR parent_id = #{tenantId} OR ancestors LIKE CONCAT(#{tenantId}, ',%') OR ancestors LIKE CONCAT('%,', #{tenantId}, ',%'))
        )
    </select>

    <!-- 统计充电桩状态分布 -->
    <select id="getChargerStatusStats" resultType="java.util.HashMap">
        <![CDATA[
        SELECT 
            COALESCE(SUM(CASE WHEN c.status <> 0 THEN 1 ELSE 0 END), 0) AS online,
            COALESCE(SUM(CASE WHEN c.status = 0 THEN 1 ELSE 0 END), 0) AS offline,
            COALESCE(SUM(CASE WHEN c.status = 2 THEN 1 ELSE 0 END), 0) AS charging,
            COALESCE(SUM(CASE WHEN c.status = 1 THEN 1 ELSE 0 END), 0) AS idle
        FROM charger c
        WHERE c.deleted = 0
        AND c.tenant_id IN (
            SELECT id FROM sys_tenant 
            WHERE deleted = 0 
            AND (id = #{tenantId} OR parent_id = #{tenantId} OR ancestors LIKE CONCAT(#{tenantId}, ',%') OR ancestors LIKE CONCAT('%,', #{tenantId}, ',%'))
        )
        ]]>
    </select>

    <!-- 获取充电量趋势（最近N天，按天聚合） -->
    <select id="getChargingTrend" resultType="java.util.HashMap">
        <![CDATA[
        SELECT to_char(d::date, 'YYYY-MM-DD') AS date,
               COALESCE(SUM(co.energy), 0)    AS value
        FROM generate_series(current_date - (#{days} - 1), current_date, interval '1 day') AS d
        LEFT JOIN charging_order co
          ON co.deleted = 0
         AND co.start_time::date = d::date
         AND co.tenant_id IN (
              SELECT id FROM sys_tenant WHERE deleted = 0
                AND (id = #{tenantId}
                  OR parent_id = #{tenantId}
                  OR ancestors LIKE CONCAT(#{tenantId}, ',%')
                  OR ancestors LIKE CONCAT('%,', #{tenantId}, ',%'))
         )
        GROUP BY d
        ORDER BY d
        ]]>
    </select>

    <!-- 获取收入趋势（最近N天，按天聚合） -->
    <select id="getRevenueTrend" resultType="java.util.HashMap">
        <![CDATA[
        SELECT to_char(d::date, 'YYYY-MM-DD') AS date,
               COALESCE(SUM(co.amount), 0)    AS value
        FROM generate_series(current_date - (#{days} - 1), current_date, interval '1 day') AS d
        LEFT JOIN charging_order co
          ON co.deleted = 0
         AND co.start_time::date = d::date
         AND co.status IN (1, 11)
         AND co.tenant_id IN (
              SELECT id FROM sys_tenant WHERE deleted = 0
                AND (id = #{tenantId}
                  OR parent_id = #{tenantId}
                  OR ancestors LIKE CONCAT(#{tenantId}, ',%')
                  OR ancestors LIKE CONCAT('%,', #{tenantId}, ',%'))
         )
        GROUP BY d
        ORDER BY d
        ]]>
    </select>

    <!-- 获取订单时段分布（当日，3小时粒度） -->
    <select id="getOrderPeriodDistribution" resultType="java.util.HashMap">
        WITH params AS (
          SELECT 
            #{date}::date AS target_date,
            COALESCE(#{granularity}, 3) AS g
        ), slots AS (
          SELECT generate_series(0, 24 - (SELECT g FROM params), (SELECT g FROM params)) AS start_hour
        )
        SELECT 
          CONCAT(start_hour, '-', start_hour + (SELECT g FROM params), '时') AS slot,
          COALESCE(COUNT(co.id), 0) AS cnt
        FROM slots s
        LEFT JOIN charging_order co ON co.deleted = 0
          AND co.start_time >= (SELECT target_date FROM params)
          AND co.start_time &lt; (SELECT target_date FROM params) + interval '1 day'
          AND extract(hour from co.start_time) &gt;= s.start_hour
          AND extract(hour from co.start_time) &lt; s.start_hour + (SELECT g FROM params)
          AND co.tenant_id IN (
                SELECT id FROM sys_tenant WHERE deleted = 0
                  AND (id = #{tenantId} OR parent_id = #{tenantId}
                       OR ancestors LIKE CONCAT(#{tenantId}, ',%')
                       OR ancestors LIKE CONCAT('%,', #{tenantId}, ',%'))
          )
          <if test="stationId != null">
            AND co.station_id = #{stationId}
          </if>
        GROUP BY s.start_hour
        ORDER BY s.start_hour
    </select>
    
    <!-- 统计充电站数量 -->
    <select id="countStations" resultType="java.lang.Long">
        SELECT COUNT(*)
        FROM charging_station
        WHERE deleted = 0
        AND tenant_id IN (
            SELECT id FROM sys_tenant 
            WHERE deleted = 0 
            AND (id = #{tenantId} OR parent_id = #{tenantId} OR ancestors LIKE CONCAT(#{tenantId}, ',%') OR ancestors LIKE CONCAT('%,', #{tenantId}, ',%'))
        )
    </select>
    
    <!-- 统计充电桩数量 -->
    <select id="countChargers" resultType="java.lang.Long">
        SELECT COUNT(*)
        FROM charger
        WHERE deleted = 0
        AND tenant_id IN (
            SELECT id FROM sys_tenant 
            WHERE deleted = 0 
            AND (id = #{tenantId} OR parent_id = #{tenantId} OR ancestors LIKE CONCAT(#{tenantId}, ',%') OR ancestors LIKE CONCAT('%,', #{tenantId}, ',%'))
        )
    </select>
    
    <!-- 统计今日订单数 -->
    <select id="countTodayOrders" resultType="java.lang.Long">
        SELECT COUNT(*)
        FROM charging_order
        WHERE deleted = 0
        AND tenant_id IN (
            SELECT id FROM sys_tenant 
            WHERE deleted = 0 
            AND (id = #{tenantId} OR parent_id = #{tenantId} OR ancestors LIKE CONCAT(#{tenantId}, ',%') OR ancestors LIKE CONCAT('%,', #{tenantId}, ',%'))
        )
        AND start_time BETWEEN #{startTime} AND #{endTime}
    </select>
    
    <!-- 统计今日充电量 -->
    <select id="sumTodayChargingAmount" resultType="java.math.BigDecimal">
        SELECT COALESCE(SUM(energy), 0)
        FROM charging_order
        WHERE deleted = 0
        AND tenant_id IN (
            SELECT id FROM sys_tenant 
            WHERE deleted = 0 
            AND (id = #{tenantId} OR parent_id = #{tenantId} OR ancestors LIKE CONCAT(#{tenantId}, ',%') OR ancestors LIKE CONCAT('%,', #{tenantId}, ',%'))
        )
        AND start_time BETWEEN #{startTime} AND #{endTime}
        AND status IN (1, 11)
    </select>
    
    <!-- 统计今日收入 -->
    <select id="sumTodayRevenue" resultType="java.math.BigDecimal">
        SELECT COALESCE(SUM(amount), 0)
        FROM charging_order
        WHERE deleted = 0
        AND tenant_id IN (
            SELECT id FROM sys_tenant 
            WHERE deleted = 0 
            AND (id = #{tenantId} OR parent_id = #{tenantId} OR ancestors LIKE CONCAT(#{tenantId}, ',%') OR ancestors LIKE CONCAT('%,', #{tenantId}, ',%'))
        )
        AND start_time BETWEEN #{startTime} AND #{endTime}
        AND status IN (1, 11)
    </select>
    
    <!-- 获取最近订单列表 -->
    <select id="getRecentOrders" resultType="java.util.HashMap">
        SELECT 
            co.session_id AS order_no,
            cs.station_name AS station_name,
            c.charger_code AS charger_code,
            su.username AS user_name,
            co.amount AS total_amount,
            co.status,
            co.create_time
        FROM charging_order co
        LEFT JOIN charging_station cs ON co.station_id = cs.station_id
        LEFT JOIN charger c ON co.charger_id = c.charger_id
        LEFT JOIN sys_user su ON co.user_id = su.id
        WHERE co.deleted = 0
        AND co.tenant_id IN (
            SELECT id FROM sys_tenant 
            WHERE deleted = 0 
            AND (id = #{tenantId} OR parent_id = #{tenantId} OR ancestors LIKE CONCAT(#{tenantId}, ',%') OR ancestors LIKE CONCAT('%,', #{tenantId}, ',%'))
        )
        ORDER BY co.create_time DESC
        LIMIT #{limit}
    </select>
    
    <!-- 获取充电站订单排名（Top N） -->
    <select id="getStationRanking" resultType="java.util.HashMap">
        SELECT 
            cs.station_id AS id,
            cs.station_name,
            COUNT(co.id) AS order_count
        FROM charging_station cs
        LEFT JOIN charging_order co ON cs.station_id = co.station_id AND co.deleted = 0
        WHERE cs.deleted = 0
        AND cs.tenant_id IN (
            SELECT id FROM sys_tenant 
            WHERE deleted = 0 
            AND (id = #{tenantId} OR parent_id = #{tenantId} OR ancestors LIKE CONCAT(#{tenantId}, ',%') OR ancestors LIKE CONCAT('%,', #{tenantId}, ',%'))
        )
        GROUP BY cs.station_id, cs.station_name
        ORDER BY order_count DESC
        LIMIT #{limit}
    </select>
    
    <!-- 获取充电桩利用率排名（Top N） -->
    <select id="getChargerUtilization" resultType="java.util.HashMap">
        SELECT 
            c.charger_id AS id,
            c.charger_code,
            COALESCE(
                CAST(
                    (COUNT(DISTINCT DATE(co.create_time)) * 100.0 / 30) AS INTEGER
                ), 0
            ) AS utilization
        FROM charger c
        LEFT JOIN charging_order co ON c.charger_id = co.charger_id 
            AND co.deleted = 0 
            AND co.create_time >= CURRENT_DATE - INTERVAL '30 days'
        WHERE c.deleted = 0
        AND c.tenant_id IN (
            SELECT id FROM sys_tenant 
            WHERE deleted = 0 
            AND (id = #{tenantId} OR parent_id = #{tenantId} OR ancestors LIKE CONCAT(#{tenantId}, ',%') OR ancestors LIKE CONCAT('%,', #{tenantId}, ',%'))
        )
        GROUP BY c.charger_id, c.charger_code
        ORDER BY utilization DESC
        LIMIT #{limit}
    </select>
    
</mapper>
