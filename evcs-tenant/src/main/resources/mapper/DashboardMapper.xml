<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.evcs.tenant.mapper.DashboardMapper">
    
    <!-- 统计租户数量（当前租户及其子租户） -->
    <select id="countTenants" resultType="java.lang.Long">
        SELECT COUNT(*)
        FROM sys_tenant
        WHERE deleted = 0
        AND status = 1
        AND (id = #{tenantId} OR parent_id = #{tenantId})
    </select>
    
    <!-- 统计用户数量 -->
    <select id="countUsers" resultType="java.lang.Long">
        SELECT COUNT(*)
        FROM sys_user
        WHERE deleted = 0
        AND status = 1
        AND tenant_id IN (
            SELECT id FROM sys_tenant 
            WHERE deleted = 0 
            AND (id = #{tenantId} OR parent_id = #{tenantId} OR ancestors LIKE CONCAT(#{tenantId}, ',%') OR ancestors LIKE CONCAT('%,', #{tenantId}, ',%'))
        )
    </select>
    
    <!-- 统计充电站数量 -->
    <select id="countStations" resultType="java.lang.Long">
        SELECT COUNT(*)
        FROM charging_station
        WHERE deleted = 0
        AND tenant_id IN (
            SELECT id FROM sys_tenant 
            WHERE deleted = 0 
            AND (id = #{tenantId} OR parent_id = #{tenantId} OR ancestors LIKE CONCAT(#{tenantId}, ',%') OR ancestors LIKE CONCAT('%,', #{tenantId}, ',%'))
        )
    </select>
    
    <!-- 统计充电桩数量 -->
    <select id="countChargers" resultType="java.lang.Long">
        SELECT COUNT(*)
        FROM charger
        WHERE deleted = 0
        AND tenant_id IN (
            SELECT id FROM sys_tenant 
            WHERE deleted = 0 
            AND (id = #{tenantId} OR parent_id = #{tenantId} OR ancestors LIKE CONCAT(#{tenantId}, ',%') OR ancestors LIKE CONCAT('%,', #{tenantId}, ',%'))
        )
    </select>
    
    <!-- 统计今日订单数 -->
    <select id="countTodayOrders" resultType="java.lang.Long">
        SELECT COUNT(*)
        FROM charging_order
        WHERE deleted = 0
        AND tenant_id IN (
            SELECT id FROM sys_tenant 
            WHERE deleted = 0 
            AND (id = #{tenantId} OR parent_id = #{tenantId} OR ancestors LIKE CONCAT(#{tenantId}, ',%') OR ancestors LIKE CONCAT('%,', #{tenantId}, ',%'))
        )
        AND start_time BETWEEN #{startTime} AND #{endTime}
    </select>
    
    <!-- 统计今日充电量 -->
    <select id="sumTodayChargingAmount" resultType="java.math.BigDecimal">
        SELECT COALESCE(SUM(energy), 0)
        FROM charging_order
        WHERE deleted = 0
        AND tenant_id IN (
            SELECT id FROM sys_tenant 
            WHERE deleted = 0 
            AND (id = #{tenantId} OR parent_id = #{tenantId} OR ancestors LIKE CONCAT(#{tenantId}, ',%') OR ancestors LIKE CONCAT('%,', #{tenantId}, ',%'))
        )
        AND start_time BETWEEN #{startTime} AND #{endTime}
        AND status IN (1, 11)
    </select>
    
    <!-- 统计今日收入 -->
    <select id="sumTodayRevenue" resultType="java.math.BigDecimal">
        SELECT COALESCE(SUM(amount), 0)
        FROM charging_order
        WHERE deleted = 0
        AND tenant_id IN (
            SELECT id FROM sys_tenant 
            WHERE deleted = 0 
            AND (id = #{tenantId} OR parent_id = #{tenantId} OR ancestors LIKE CONCAT(#{tenantId}, ',%') OR ancestors LIKE CONCAT('%,', #{tenantId}, ',%'))
        )
        AND start_time BETWEEN #{startTime} AND #{endTime}
        AND status IN (1, 11)
    </select>
    
    <!-- 获取最近订单列表 -->
    <select id="getRecentOrders" resultType="java.util.HashMap">
        SELECT 
            co.session_id AS order_no,
            cs.station_name AS station_name,
            c.charger_code AS charger_code,
            su.username AS user_name,
            co.amount AS total_amount,
            co.status,
            co.create_time
        FROM charging_order co
        LEFT JOIN charging_station cs ON co.station_id = cs.station_id
        LEFT JOIN charger c ON co.charger_id = c.charger_id
        LEFT JOIN sys_user su ON co.user_id = su.id
        WHERE co.deleted = 0
        AND co.tenant_id IN (
            SELECT id FROM sys_tenant 
            WHERE deleted = 0 
            AND (id = #{tenantId} OR parent_id = #{tenantId} OR ancestors LIKE CONCAT(#{tenantId}, ',%') OR ancestors LIKE CONCAT('%,', #{tenantId}, ',%'))
        )
        ORDER BY co.create_time DESC
        LIMIT #{limit}
    </select>
    
</mapper>
