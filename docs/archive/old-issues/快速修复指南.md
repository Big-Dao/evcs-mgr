# EVCS Manager 快速修复指南

> 针对最关键的问题提供快速修复方案

---

## 🚨 紧急修复（阻止开发）

### 问题1: Java版本不匹配
**症状**: 编译失败，错误信息 `error: invalid source release: 21`

**快速修复**:
```bash
# 方案A: 升级到Java 21（推荐）
# Ubuntu/Debian
sudo apt install openjdk-21-jdk

# macOS
brew install openjdk@21

# 或使用SDKMAN
sdk install java 21.0.1-open
sdk use java 21.0.1-open

# 方案B: 降级项目到Java 17
# 编辑 build.gradle
sourceCompatibility = '17'
targetCompatibility = '17'
```

---

### 问题2: Gradle Wrapper JAR缺失
**症状**: `Could not find or load main class org.gradle.wrapper.GradleWrapperMain`

**快速修复**:
```bash
cd /path/to/evcs-mgr
curl -L -o gradle/wrapper/gradle-wrapper.jar \
  https://github.com/gradle/gradle/raw/v8.5.0/gradle/wrapper/gradle-wrapper.jar
git add gradle/wrapper/gradle-wrapper.jar
git commit -m "Add missing Gradle wrapper JAR"
```

---

## ⚠️ 高优先级修复（影响功能和安全）

### 问题3: 异常处理器顺序冲突
**文件**: `evcs-common/src/main/java/com/evcs/common/exception/GlobalExceptionHandler.java`

**问题**: RuntimeException处理器可能拦截BusinessException

**快速修复**:
```java
// 删除以下方法（line 77-82）
@ExceptionHandler(RuntimeException.class)
@ResponseStatus(HttpStatus.INTERNAL_SERVER_ERROR)
public Result<Void> handleRuntimeException(RuntimeException e) {
    log.error("运行时异常", e);
    return Result.failure(ResultCode.INTERNAL_SERVER_ERROR);
}
```

**原因**: Exception处理器已经可以处理所有运行时异常，保留RuntimeException处理器会导致异常处理不一致。

---

### 问题4: JWT验证白名单漏洞
**文件**: `evcs-gateway/src/main/java/com/evcs/gateway/filter/JwtAuthGlobalFilter.java`

**问题**: 使用startsWith匹配白名单可能被绕过

**快速修复**:
```java
// 在类中添加PathMatcher
private final PathMatcher pathMatcher = new AntPathMatcher();

// 修改filter方法（line 52-55）
boolean whitelisted = WHITELIST.stream()
    .anyMatch(pattern -> pathMatcher.match(pattern, path));
if (whitelisted) {
    return chain.filter(exchange);
}
```

---

### 问题5: 租户ID为null时的安全风险
**文件**: `evcs-common/src/main/java/com/evcs/common/tenant/CustomTenantLineHandler.java`

**问题**: 返回-1可能导致访问到tenant_id=-1的数据

**快速修复**:
```java
// 修改getTenantId方法（line 55-65）
@Override
public Expression getTenantId() {
    Long tenantId = TenantContext.getTenantId();
    if (tenantId == null) {
        log.error("租户上下文中未找到租户ID，拒绝数据访问");
        throw new IllegalStateException(
            "租户上下文未设置，无法执行数据库操作。请确保在业务操作前设置租户上下文。"
        );
    }
    log.debug("SQL租户过滤 - 租户ID: {}", tenantId);
    return new LongValue(tenantId);
}
```

---

## 🔧 中优先级修复（性能和维护）

### 问题6: 多租户过滤重复
**文件**: `evcs-order/src/main/java/com/evcs/order/service/impl/ReconciliationServiceImpl.java`

**问题**: 手动添加tenant_id过滤与自动过滤冲突

**快速修复**:
```java
// 修改runDailyCheck方法（line 27-30）
var qw = new QueryWrapper<ChargingOrder>()
        // .eq("tenant_id", TenantContext.getCurrentTenantId())  // 删除这行
        .ge("create_time", start)
        .lt("create_time", end);
```

**原因**: MyBatis Plus的CustomTenantLineHandler会自动添加租户过滤。

---

### 问题7: 对账服务性能问题
**文件**: `evcs-order/src/main/java/com/evcs/order/service/impl/ReconciliationServiceImpl.java`

**问题**: 一次性加载所有订单到内存

**快速修复**:
```java
@Override
@DataScope
public ReconcileResult runDailyCheck() {
    LocalDate today = LocalDate.now();
    LocalDateTime start = today.minusDays(1).atStartOfDay();
    LocalDateTime end = today.atStartOfDay();
    
    var qw = new QueryWrapper<ChargingOrder>()
            .ge("create_time", start)
            .lt("create_time", end);
    
    ReconcileResult r = new ReconcileResult();
    
    // 使用分页处理
    int pageSize = 1000;
    int pageNum = 1;
    
    while (true) {
        Page<ChargingOrder> page = new Page<>(pageNum, pageSize);
        Page<ChargingOrder> result = orderMapper.selectPage(page, qw);
        
        for (ChargingOrder o : result.getRecords()) {
            boolean bad = false;
            if (o.getStartTime() != null && o.getEndTime() != null 
                && !o.getEndTime().isAfter(o.getStartTime())) {
                r.invalidTimeRange++;
                bad = true;
            }
            if (o.getEndTime() == null && (o.getStatus() != null 
                && o.getStatus() >= ChargingOrder.STATUS_COMPLETED)) {
                r.missingEndTime++;
                bad = true;
            }
            if (o.getAmount() != null && o.getAmount().compareTo(BigDecimal.ZERO) < 0) {
                r.negativeAmount++;
                bad = true;
            }
            if (bad) r.needAttention++;
        }
        
        r.total += result.getRecords().size();
        
        if (!result.hasNext()) {
            break;
        }
        pageNum++;
    }
    
    return r;
}
```

---

### 问题8: Gateway响应头设置错误
**文件**: `evcs-gateway/src/main/java/com/evcs/gateway/filter/JwtAuthGlobalFilter.java`

**问题**: 在filter链执行前设置响应头可能不生效

**快速修复**:
```java
// 删除line 47-49的代码
// if (request.getHeaders().getFirst("X-Request-Id") == null) {
//     exchange.getResponse().getHeaders().add("X-Request-Id", requestId);
// }

// 响应头会在下游服务中通过请求头传递，无需在此设置
```

---

## 📋 代码质量修复（低优先级）

### 问题9: JSON手动拼接缺少转义
**文件**: `evcs-gateway/src/main/java/com/evcs/gateway/filter/JwtAuthGlobalFilter.java`

**快速修复**:
```java
// 方案1: 添加依赖并使用ObjectMapper
import com.fasterxml.jackson.databind.ObjectMapper;

// 在类中添加
private final ObjectMapper objectMapper = new ObjectMapper();

// 修改unauthorized方法
private Mono<Void> unauthorized(ServerWebExchange exchange, String message) {
    var response = exchange.getResponse();
    response.setStatusCode(HttpStatus.UNAUTHORIZED);
    response.getHeaders().setContentType(MediaType.APPLICATION_JSON);
    
    Map<String, Object> body = Map.of("code", 401, "message", message);
    byte[] bytes;
    try {
        bytes = objectMapper.writeValueAsBytes(body);
    } catch (JsonProcessingException e) {
        bytes = "{\"code\":401,\"message\":\"Unauthorized\"}".getBytes(StandardCharsets.UTF_8);
    }
    
    var buffer = response.bufferFactory().wrap(bytes);
    return response.writeWith(Mono.just(buffer));
}

// 方案2: 简单转义（临时方案）
String escapedMessage = message.replace("\"", "\\\"")
                               .replace("\n", "\\n")
                               .replace("\r", "\\r");
String body = "{\"code\":401,\"message\":\"" + escapedMessage + "\"}";
```

---

### 问题10: ReconcileResult封装不完整
**文件**: `evcs-order/src/main/java/com/evcs/order/service/ReconciliationService.java`

**快速修复**:
```java
import lombok.Data;

@Data
public static class ReconcileResult {
    private long total;
    private long invalidTimeRange;
    private long negativeAmount;
    private long missingEndTime;
    private long needAttention;
}
```

---

## 🔍 验证修复

### 验证构建
```bash
./gradlew clean build
```

### 验证异常处理
```bash
# 启动服务后测试
curl -X POST http://localhost:8080/api/test/exception
```

### 验证JWT过滤
```bash
# 测试白名单
curl http://localhost:8080/auth/login
curl http://localhost:8080/auth/login/../admin/users  # 应该返回401
```

### 验证租户隔离
```bash
# 在测试中验证
@Test
public void testTenantIsolation() {
    TenantContext.clear();
    assertThrows(IllegalStateException.class, () -> {
        // 尝试在没有租户上下文的情况下查询
        orderMapper.selectList(null);
    });
}
```

---

## 📊 修复进度跟踪

```
问题  | 严重度 | 状态 | 预计时间
------|--------|------|----------
ENV-01| 🔴     | [ ]  | 0.5h
ENV-02| 🔴     | [ ]  | 0.5h
EXC-01| 🟠     | [ ]  | 1h
GW-01 | 🟠     | [ ]  | 2h
SEC-02| 🟡     | [ ]  | 1h
TNT-01| 🟡     | [ ]  | 0.5h
PERF-01|🟡     | [ ]  | 3h
GW-02 | 🟡     | [ ]  | 1h
QUA-01| 🟢     | [ ]  | 1h
QUA-02| 🟢     | [ ]  | 0.5h
------|--------|------|----------
总计  |        |      | 11h
```

---

## 📚 相关文档

- [详细错误分析](./ERROR-ANALYSIS.md) - 完整的错误分析和说明
- [错误分析总结](./错误分析总结.md) - 中文简明总结
- [错误分类图表](./错误分类图表.md) - 可视化错误分布

---

## 💡 最佳实践建议

1. **修复前先备份**: 创建新分支进行修复
   ```bash
   git checkout -b fix/error-fixes
   ```

2. **逐个修复**: 一次只修复一个问题，便于回滚
   ```bash
   git add -p
   git commit -m "Fix: [问题ID] 描述"
   ```

3. **测试验证**: 每次修复后运行相关测试
   ```bash
   ./gradlew test --tests *相关测试类*
   ```

4. **代码审查**: 修复完成后请团队成员审查
   ```bash
   git push origin fix/error-fixes
   # 创建Pull Request
   ```

---

**更新时间**: 2025-01-08  
**维护者**: GitHub Copilot  
**反馈**: 如有问题请创建Issue

