# EVCS Manager å¿«é€Ÿä¿®å¤æŒ‡å—

> é’ˆå¯¹æœ€å…³é”®çš„é—®é¢˜æä¾›å¿«é€Ÿä¿®å¤æ–¹æ¡ˆ

---

## ğŸš¨ ç´§æ€¥ä¿®å¤ï¼ˆé˜»æ­¢å¼€å‘ï¼‰

### é—®é¢˜1: Javaç‰ˆæœ¬ä¸åŒ¹é…
**ç—‡çŠ¶**: ç¼–è¯‘å¤±è´¥ï¼Œé”™è¯¯ä¿¡æ¯ `error: invalid source release: 21`

**å¿«é€Ÿä¿®å¤**:
```bash
# æ–¹æ¡ˆA: å‡çº§åˆ°Java 21ï¼ˆæ¨èï¼‰
# Ubuntu/Debian
sudo apt install openjdk-21-jdk

# macOS
brew install openjdk@21

# æˆ–ä½¿ç”¨SDKMAN
sdk install java 21.0.1-open
sdk use java 21.0.1-open

# æ–¹æ¡ˆB: é™çº§é¡¹ç›®åˆ°Java 17
# ç¼–è¾‘ build.gradle
sourceCompatibility = '17'
targetCompatibility = '17'
```

---

### é—®é¢˜2: Gradle Wrapper JARç¼ºå¤±
**ç—‡çŠ¶**: `Could not find or load main class org.gradle.wrapper.GradleWrapperMain`

**å¿«é€Ÿä¿®å¤**:
```bash
cd /path/to/evcs-mgr
curl -L -o gradle/wrapper/gradle-wrapper.jar \
  https://github.com/gradle/gradle/raw/v8.5.0/gradle/wrapper/gradle-wrapper.jar
git add gradle/wrapper/gradle-wrapper.jar
git commit -m "Add missing Gradle wrapper JAR"
```

---

## âš ï¸ é«˜ä¼˜å…ˆçº§ä¿®å¤ï¼ˆå½±å“åŠŸèƒ½å’Œå®‰å…¨ï¼‰

### é—®é¢˜3: å¼‚å¸¸å¤„ç†å™¨é¡ºåºå†²çª
**æ–‡ä»¶**: `evcs-common/src/main/java/com/evcs/common/exception/GlobalExceptionHandler.java`

**é—®é¢˜**: RuntimeExceptionå¤„ç†å™¨å¯èƒ½æ‹¦æˆªBusinessException

**å¿«é€Ÿä¿®å¤**:
```java
// åˆ é™¤ä»¥ä¸‹æ–¹æ³•ï¼ˆline 77-82ï¼‰
@ExceptionHandler(RuntimeException.class)
@ResponseStatus(HttpStatus.INTERNAL_SERVER_ERROR)
public Result<Void> handleRuntimeException(RuntimeException e) {
    log.error("è¿è¡Œæ—¶å¼‚å¸¸", e);
    return Result.failure(ResultCode.INTERNAL_SERVER_ERROR);
}
```

**åŸå› **: Exceptionå¤„ç†å™¨å·²ç»å¯ä»¥å¤„ç†æ‰€æœ‰è¿è¡Œæ—¶å¼‚å¸¸ï¼Œä¿ç•™RuntimeExceptionå¤„ç†å™¨ä¼šå¯¼è‡´å¼‚å¸¸å¤„ç†ä¸ä¸€è‡´ã€‚

---

### é—®é¢˜4: JWTéªŒè¯ç™½åå•æ¼æ´
**æ–‡ä»¶**: `evcs-gateway/src/main/java/com/evcs/gateway/filter/JwtAuthGlobalFilter.java`

**é—®é¢˜**: ä½¿ç”¨startsWithåŒ¹é…ç™½åå•å¯èƒ½è¢«ç»•è¿‡

**å¿«é€Ÿä¿®å¤**:
```java
// åœ¨ç±»ä¸­æ·»åŠ PathMatcher
private final PathMatcher pathMatcher = new AntPathMatcher();

// ä¿®æ”¹filteræ–¹æ³•ï¼ˆline 52-55ï¼‰
boolean whitelisted = WHITELIST.stream()
    .anyMatch(pattern -> pathMatcher.match(pattern, path));
if (whitelisted) {
    return chain.filter(exchange);
}
```

---

### é—®é¢˜5: ç§Ÿæˆ·IDä¸ºnullæ—¶çš„å®‰å…¨é£é™©
**æ–‡ä»¶**: `evcs-common/src/main/java/com/evcs/common/tenant/CustomTenantLineHandler.java`

**é—®é¢˜**: è¿”å›-1å¯èƒ½å¯¼è‡´è®¿é—®åˆ°tenant_id=-1çš„æ•°æ®

**å¿«é€Ÿä¿®å¤**:
```java
// ä¿®æ”¹getTenantIdæ–¹æ³•ï¼ˆline 55-65ï¼‰
@Override
public Expression getTenantId() {
    Long tenantId = TenantContext.getTenantId();
    if (tenantId == null) {
        log.error("ç§Ÿæˆ·ä¸Šä¸‹æ–‡ä¸­æœªæ‰¾åˆ°ç§Ÿæˆ·IDï¼Œæ‹’ç»æ•°æ®è®¿é—®");
        throw new IllegalStateException(
            "ç§Ÿæˆ·ä¸Šä¸‹æ–‡æœªè®¾ç½®ï¼Œæ— æ³•æ‰§è¡Œæ•°æ®åº“æ“ä½œã€‚è¯·ç¡®ä¿åœ¨ä¸šåŠ¡æ“ä½œå‰è®¾ç½®ç§Ÿæˆ·ä¸Šä¸‹æ–‡ã€‚"
        );
    }
    log.debug("SQLç§Ÿæˆ·è¿‡æ»¤ - ç§Ÿæˆ·ID: {}", tenantId);
    return new LongValue(tenantId);
}
```

---

## ğŸ”§ ä¸­ä¼˜å…ˆçº§ä¿®å¤ï¼ˆæ€§èƒ½å’Œç»´æŠ¤ï¼‰

### é—®é¢˜6: å¤šç§Ÿæˆ·è¿‡æ»¤é‡å¤
**æ–‡ä»¶**: `evcs-order/src/main/java/com/evcs/order/service/impl/ReconciliationServiceImpl.java`

**é—®é¢˜**: æ‰‹åŠ¨æ·»åŠ tenant_idè¿‡æ»¤ä¸è‡ªåŠ¨è¿‡æ»¤å†²çª

**å¿«é€Ÿä¿®å¤**:
```java
// ä¿®æ”¹runDailyCheckæ–¹æ³•ï¼ˆline 27-30ï¼‰
var qw = new QueryWrapper<ChargingOrder>()
        // .eq("tenant_id", TenantContext.getCurrentTenantId())  // åˆ é™¤è¿™è¡Œ
        .ge("create_time", start)
        .lt("create_time", end);
```

**åŸå› **: MyBatis Plusçš„CustomTenantLineHandlerä¼šè‡ªåŠ¨æ·»åŠ ç§Ÿæˆ·è¿‡æ»¤ã€‚

---

### é—®é¢˜7: å¯¹è´¦æœåŠ¡æ€§èƒ½é—®é¢˜
**æ–‡ä»¶**: `evcs-order/src/main/java/com/evcs/order/service/impl/ReconciliationServiceImpl.java`

**é—®é¢˜**: ä¸€æ¬¡æ€§åŠ è½½æ‰€æœ‰è®¢å•åˆ°å†…å­˜

**å¿«é€Ÿä¿®å¤**:
```java
@Override
@DataScope
public ReconcileResult runDailyCheck() {
    LocalDate today = LocalDate.now();
    LocalDateTime start = today.minusDays(1).atStartOfDay();
    LocalDateTime end = today.atStartOfDay();
    
    var qw = new QueryWrapper<ChargingOrder>()
            .ge("create_time", start)
            .lt("create_time", end);
    
    ReconcileResult r = new ReconcileResult();
    
    // ä½¿ç”¨åˆ†é¡µå¤„ç†
    int pageSize = 1000;
    int pageNum = 1;
    
    while (true) {
        Page<ChargingOrder> page = new Page<>(pageNum, pageSize);
        Page<ChargingOrder> result = orderMapper.selectPage(page, qw);
        
        for (ChargingOrder o : result.getRecords()) {
            boolean bad = false;
            if (o.getStartTime() != null && o.getEndTime() != null 
                && !o.getEndTime().isAfter(o.getStartTime())) {
                r.invalidTimeRange++;
                bad = true;
            }
            if (o.getEndTime() == null && (o.getStatus() != null 
                && o.getStatus() >= ChargingOrder.STATUS_COMPLETED)) {
                r.missingEndTime++;
                bad = true;
            }
            if (o.getAmount() != null && o.getAmount().compareTo(BigDecimal.ZERO) < 0) {
                r.negativeAmount++;
                bad = true;
            }
            if (bad) r.needAttention++;
        }
        
        r.total += result.getRecords().size();
        
        if (!result.hasNext()) {
            break;
        }
        pageNum++;
    }
    
    return r;
}
```

---

### é—®é¢˜8: Gatewayå“åº”å¤´è®¾ç½®é”™è¯¯
**æ–‡ä»¶**: `evcs-gateway/src/main/java/com/evcs/gateway/filter/JwtAuthGlobalFilter.java`

**é—®é¢˜**: åœ¨filteré“¾æ‰§è¡Œå‰è®¾ç½®å“åº”å¤´å¯èƒ½ä¸ç”Ÿæ•ˆ

**å¿«é€Ÿä¿®å¤**:
```java
// åˆ é™¤line 47-49çš„ä»£ç 
// if (request.getHeaders().getFirst("X-Request-Id") == null) {
//     exchange.getResponse().getHeaders().add("X-Request-Id", requestId);
// }

// å“åº”å¤´ä¼šåœ¨ä¸‹æ¸¸æœåŠ¡ä¸­é€šè¿‡è¯·æ±‚å¤´ä¼ é€’ï¼Œæ— éœ€åœ¨æ­¤è®¾ç½®
```

---

## ğŸ“‹ ä»£ç è´¨é‡ä¿®å¤ï¼ˆä½ä¼˜å…ˆçº§ï¼‰

### é—®é¢˜9: JSONæ‰‹åŠ¨æ‹¼æ¥ç¼ºå°‘è½¬ä¹‰
**æ–‡ä»¶**: `evcs-gateway/src/main/java/com/evcs/gateway/filter/JwtAuthGlobalFilter.java`

**å¿«é€Ÿä¿®å¤**:
```java
// æ–¹æ¡ˆ1: æ·»åŠ ä¾èµ–å¹¶ä½¿ç”¨ObjectMapper
import com.fasterxml.jackson.databind.ObjectMapper;

// åœ¨ç±»ä¸­æ·»åŠ 
private final ObjectMapper objectMapper = new ObjectMapper();

// ä¿®æ”¹unauthorizedæ–¹æ³•
private Mono<Void> unauthorized(ServerWebExchange exchange, String message) {
    var response = exchange.getResponse();
    response.setStatusCode(HttpStatus.UNAUTHORIZED);
    response.getHeaders().setContentType(MediaType.APPLICATION_JSON);
    
    Map<String, Object> body = Map.of("code", 401, "message", message);
    byte[] bytes;
    try {
        bytes = objectMapper.writeValueAsBytes(body);
    } catch (JsonProcessingException e) {
        bytes = "{\"code\":401,\"message\":\"Unauthorized\"}".getBytes(StandardCharsets.UTF_8);
    }
    
    var buffer = response.bufferFactory().wrap(bytes);
    return response.writeWith(Mono.just(buffer));
}

// æ–¹æ¡ˆ2: ç®€å•è½¬ä¹‰ï¼ˆä¸´æ—¶æ–¹æ¡ˆï¼‰
String escapedMessage = message.replace("\"", "\\\"")
                               .replace("\n", "\\n")
                               .replace("\r", "\\r");
String body = "{\"code\":401,\"message\":\"" + escapedMessage + "\"}";
```

---

### é—®é¢˜10: ReconcileResultå°è£…ä¸å®Œæ•´
**æ–‡ä»¶**: `evcs-order/src/main/java/com/evcs/order/service/ReconciliationService.java`

**å¿«é€Ÿä¿®å¤**:
```java
import lombok.Data;

@Data
public static class ReconcileResult {
    private long total;
    private long invalidTimeRange;
    private long negativeAmount;
    private long missingEndTime;
    private long needAttention;
}
```

---

## ğŸ” éªŒè¯ä¿®å¤

### éªŒè¯æ„å»º
```bash
./gradlew clean build
```

### éªŒè¯å¼‚å¸¸å¤„ç†
```bash
# å¯åŠ¨æœåŠ¡åæµ‹è¯•
curl -X POST http://localhost:8080/api/test/exception
```

### éªŒè¯JWTè¿‡æ»¤
```bash
# æµ‹è¯•ç™½åå•
curl http://localhost:8080/auth/login
curl http://localhost:8080/auth/login/../admin/users  # åº”è¯¥è¿”å›401
```

### éªŒè¯ç§Ÿæˆ·éš”ç¦»
```bash
# åœ¨æµ‹è¯•ä¸­éªŒè¯
@Test
public void testTenantIsolation() {
    TenantContext.clear();
    assertThrows(IllegalStateException.class, () -> {
        // å°è¯•åœ¨æ²¡æœ‰ç§Ÿæˆ·ä¸Šä¸‹æ–‡çš„æƒ…å†µä¸‹æŸ¥è¯¢
        orderMapper.selectList(null);
    });
}
```

---

## ğŸ“Š ä¿®å¤è¿›åº¦è·Ÿè¸ª

```
é—®é¢˜  | ä¸¥é‡åº¦ | çŠ¶æ€ | é¢„è®¡æ—¶é—´
------|--------|------|----------
ENV-01| ğŸ”´     | [ ]  | 0.5h
ENV-02| ğŸ”´     | [ ]  | 0.5h
EXC-01| ğŸŸ      | [ ]  | 1h
GW-01 | ğŸŸ      | [ ]  | 2h
SEC-02| ğŸŸ¡     | [ ]  | 1h
TNT-01| ğŸŸ¡     | [ ]  | 0.5h
PERF-01|ğŸŸ¡     | [ ]  | 3h
GW-02 | ğŸŸ¡     | [ ]  | 1h
QUA-01| ğŸŸ¢     | [ ]  | 1h
QUA-02| ğŸŸ¢     | [ ]  | 0.5h
------|--------|------|----------
æ€»è®¡  |        |      | 11h
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [è¯¦ç»†é”™è¯¯åˆ†æ](./ERROR-ANALYSIS.md) - å®Œæ•´çš„é”™è¯¯åˆ†æå’Œè¯´æ˜
- [é”™è¯¯åˆ†ææ€»ç»“](./é”™è¯¯åˆ†ææ€»ç»“.md) - ä¸­æ–‡ç®€æ˜æ€»ç»“
- [é”™è¯¯åˆ†ç±»å›¾è¡¨](./é”™è¯¯åˆ†ç±»å›¾è¡¨.md) - å¯è§†åŒ–é”™è¯¯åˆ†å¸ƒ

---

## ğŸ’¡ æœ€ä½³å®è·µå»ºè®®

1. **ä¿®å¤å‰å…ˆå¤‡ä»½**: åˆ›å»ºæ–°åˆ†æ”¯è¿›è¡Œä¿®å¤
   ```bash
   git checkout -b fix/error-fixes
   ```

2. **é€ä¸ªä¿®å¤**: ä¸€æ¬¡åªä¿®å¤ä¸€ä¸ªé—®é¢˜ï¼Œä¾¿äºå›æ»š
   ```bash
   git add -p
   git commit -m "Fix: [é—®é¢˜ID] æè¿°"
   ```

3. **æµ‹è¯•éªŒè¯**: æ¯æ¬¡ä¿®å¤åè¿è¡Œç›¸å…³æµ‹è¯•
   ```bash
   ./gradlew test --tests *ç›¸å…³æµ‹è¯•ç±»*
   ```

4. **ä»£ç å®¡æŸ¥**: ä¿®å¤å®Œæˆåè¯·å›¢é˜Ÿæˆå‘˜å®¡æŸ¥
   ```bash
   git push origin fix/error-fixes
   # åˆ›å»ºPull Request
   ```

---

**æ›´æ–°æ—¶é—´**: 2025-01-08  
**ç»´æŠ¤è€…**: GitHub Copilot  
**åé¦ˆ**: å¦‚æœ‰é—®é¢˜è¯·åˆ›å»ºIssue

