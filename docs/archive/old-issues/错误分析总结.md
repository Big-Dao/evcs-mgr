# EVCS Manager é¡¹ç›®é”™è¯¯åˆ†ææ€»ç»“

## å‘ç°çš„ä¸»è¦é—®é¢˜

### ğŸ”´ ä¸¥é‡é—®é¢˜ï¼ˆå¿…é¡»ç«‹å³ä¿®å¤ï¼‰

#### 1. Javaç‰ˆæœ¬ä¸åŒ¹é…
**é—®é¢˜**: é¡¹ç›®éœ€è¦Java 21ï¼Œä½†æ„å»ºç¯å¢ƒåªæœ‰Java 17
**å½±å“**: æ— æ³•ç¼–è¯‘å’Œè¿è¡Œé¡¹ç›®
**é”™è¯¯ä¿¡æ¯**: `error: invalid source release: 21`
**ä¿®å¤æ–¹æ¡ˆ**:
- å‡çº§Javaç‰ˆæœ¬åˆ°21ï¼Œæˆ–
- ä¿®æ”¹`build.gradle`é™çº§åˆ°Java 17

#### 2. Gradle Wrapper JARæ–‡ä»¶ç¼ºå¤±
**é—®é¢˜**: `gradle/wrapper/gradle-wrapper.jar` æœªæäº¤åˆ°ç‰ˆæœ¬æ§åˆ¶
**å½±å“**: æ–°å…‹éš†çš„ä»“åº“æ— æ³•æ„å»º
**ä¿®å¤æ–¹æ¡ˆ**: ä¸‹è½½å¹¶æäº¤wrapper JARæ–‡ä»¶

---

### ğŸŸ  é«˜ä¼˜å…ˆçº§é—®é¢˜ï¼ˆåº”å°½å¿«ä¿®å¤ï¼‰

#### 3. GlobalExceptionHandlerå¼‚å¸¸å¤„ç†é¡ºåºé—®é¢˜
**ä½ç½®**: `evcs-common/src/main/java/com/evcs/common/exception/GlobalExceptionHandler.java`
**é—®é¢˜ä»£ç **:
```java
@ExceptionHandler(RuntimeException.class)  // è¿™ä¸ªå¯èƒ½æ‹¦æˆªBusinessException
public Result<Void> handleRuntimeException(RuntimeException e) { ... }

@ExceptionHandler(Exception.class)
public Result<Void> handleException(Exception e) { ... }
```

**é—®é¢˜**: 
- `BusinessException` ç»§æ‰¿ `RuntimeException`
- `RuntimeException` å¤„ç†å™¨å¯èƒ½æ‹¦æˆªä¸šåŠ¡å¼‚å¸¸
- å¯¼è‡´ä¸šåŠ¡å¼‚å¸¸è¿”å›500é”™è¯¯ç è€Œä¸æ˜¯400

**ä¿®å¤å»ºè®®**: åˆ é™¤ `handleRuntimeException` æ–¹æ³•ï¼Œå› ä¸º `handleException` å·²ç»è¶³å¤Ÿ

#### 4. JWTéªŒè¯ç™½åå•å¯èƒ½è¢«ç»•è¿‡
**ä½ç½®**: `evcs-gateway/src/main/java/com/evcs/gateway/filter/JwtAuthGlobalFilter.java`
**é—®é¢˜**: ä½¿ç”¨ `path.startsWith()` åŒ¹é…ç™½åå•ï¼Œå¯èƒ½å­˜åœ¨è·¯å¾„éå†æ¼æ´
**ä¿®å¤å»ºè®®**: ä½¿ç”¨Springçš„PathMatcheræˆ–è§„èŒƒåŒ–è·¯å¾„åå†éªŒè¯

---

### ğŸŸ¡ ä¸­ä¼˜å…ˆçº§é—®é¢˜ï¼ˆå»ºè®®ä¿®å¤ï¼‰

#### 5. å¤šç§Ÿæˆ·è¿‡æ»¤é‡å¤
**ä½ç½®**: `evcs-order/src/main/java/com/evcs/order/service/impl/ReconciliationServiceImpl.java`
**é—®é¢˜ä»£ç **:
```java
var qw = new QueryWrapper<ChargingOrder>()
        .eq("tenant_id", TenantContext.getCurrentTenantId())  // æ‰‹åŠ¨æ·»åŠ 
        .ge("create_time", start)
        .lt("create_time", end);
```

**é—®é¢˜**: 
- MyBatis Plusçš„å¤šç§Ÿæˆ·æ’ä»¶ä¼šè‡ªåŠ¨æ·»åŠ  `WHERE tenant_id = ?`
- æ‰‹åŠ¨å†æ·»åŠ ä¼šå¯¼è‡´SQLä¸­å‡ºç°é‡å¤çš„tenant_idæ¡ä»¶
- ç”Ÿæˆçš„SQL: `WHERE tenant_id = ? AND tenant_id = ? ...`

**ä¿®å¤**: ç§»é™¤æ‰‹åŠ¨çš„ `.eq("tenant_id", ...)`, ä¾èµ–è‡ªåŠ¨ç§Ÿæˆ·éš”ç¦»

#### 6. TenantContext ThreadLocalæ¸…ç†ä¸å®Œæ•´
**é—®é¢˜**: åœ¨æŸäº›å¼‚å¸¸åœºæ™¯ä¸‹ï¼ŒThreadLocalå¯èƒ½æœªè¢«æ¸…ç†
**é£é™©**: 
- çº¿ç¨‹å¤ç”¨æ—¶å¯èƒ½è®¿é—®åˆ°é”™è¯¯çš„ç§Ÿæˆ·æ•°æ®
- æ½œåœ¨çš„å†…å­˜æ³„æ¼

**å½“å‰ä¿æŠ¤**: `TenantInterceptor` ä¼šåœ¨Webè¯·æ±‚ç»“æŸåæ¸…ç†
**ç¼ºå¤±ä¿æŠ¤**: ç›´æ¥è°ƒç”¨Serviceæ–¹æ³•ï¼ˆæµ‹è¯•ã€å®šæ—¶ä»»åŠ¡ï¼‰æ—¶å¯èƒ½ç»•è¿‡æ‹¦æˆªå™¨

#### 7. ç§Ÿæˆ·IDä¸ºnullæ—¶è¿”å›-1
**ä½ç½®**: `evcs-common/src/main/java/com/evcs/common/tenant/CustomTenantLineHandler.java`
**é—®é¢˜**: å½“TenantContextä¸­æ²¡æœ‰ç§Ÿæˆ·IDæ—¶ï¼Œè¿”å›-1ä½œä¸ºfallback
**é£é™©**: å¦‚æœæ•°æ®åº“ä¸­çœŸçš„å­˜åœ¨tenant_id=-1çš„æ•°æ®ï¼Œä¼šè¢«è®¿é—®åˆ°
**å»ºè®®**: ç›´æ¥æŠ›å‡ºå¼‚å¸¸ï¼Œå¼ºåˆ¶å¼€å‘è€…å¤„ç†è¿™ç§å¼‚å¸¸æƒ…å†µ

#### 8. å¯¹è´¦æœåŠ¡æ€§èƒ½é—®é¢˜
**ä½ç½®**: `ReconciliationServiceImpl.runDailyCheck()`
**é—®é¢˜**: ä¸€æ¬¡æ€§åŠ è½½æ‰€æœ‰è®¢å•åˆ°å†…å­˜
**å½±å“**: å¦‚æœä¸€å¤©æœ‰10ä¸‡+è®¢å•ï¼Œä¼šå ç”¨å¤§é‡å†…å­˜
**å»ºè®®**: ä½¿ç”¨åˆ†é¡µæˆ–æµå¼å¤„ç†

#### 9. å“åº”å¤´è®¾ç½®æ—¶æœºé”™è¯¯
**ä½ç½®**: `JwtAuthGlobalFilter.java` line 48
**é—®é¢˜**: åœ¨filteré“¾æ‰§è¡Œå‰è®¾ç½®å“åº”å¤´å¯èƒ½ä¸ç”Ÿæ•ˆ
**å½±å“**: `X-Request-Id` å“åº”å¤´å¯èƒ½æ— æ³•è¿”å›ç»™å®¢æˆ·ç«¯

---

### ğŸŸ¢ ä½ä¼˜å…ˆçº§é—®é¢˜ï¼ˆä»£ç è´¨é‡æ”¹è¿›ï¼‰

#### 10. å†—ä½™çš„nullæ£€æŸ¥
**ä½ç½®**: `ReconciliationServiceImpl.java` line 40
```java
if (o.getEndTime() == null && (o.getStatus() != null && o.getStatus() >= ...)) {
```
**é—®é¢˜**: `o.getStatus() != null` æ£€æŸ¥å¯èƒ½æ˜¯å†—ä½™çš„ï¼Œå› ä¸ºæ•°æ®åº“å­—æ®µæœ‰é»˜è®¤å€¼

#### 11. JSONæ‰‹åŠ¨æ‹¼æ¥ç¼ºå°‘è½¬ä¹‰
**ä½ç½®**: `JwtAuthGlobalFilter.unauthorized()` line 84
```java
String body = "{\"code\":401,\"message\":\"" + message + "\"}";
```
**é—®é¢˜**: messageæœªè½¬ä¹‰ï¼Œå¯èƒ½å¯¼è‡´JSONæ ¼å¼é”™è¯¯
**å»ºè®®**: ä½¿ç”¨Jacksonæˆ–è¿›è¡Œè½¬ä¹‰å¤„ç†

#### 12. æ—¶é—´èŒƒå›´éªŒè¯é€»è¾‘ä¸æ˜ç¡®
**ä½ç½®**: `ReconciliationServiceImpl.java` line 36
```java
if (!o.getEndTime().isAfter(o.getStartTime())) {  // endTime <= startTime
```
**é—®é¢˜**: endTime == startTimeï¼ˆæŒç»­0ç§’ï¼‰æ˜¯å¦åº”è¯¥æ ‡è®°ä¸ºé”™è¯¯ï¼Ÿéœ€è¦æ˜ç¡®ä¸šåŠ¡è§„åˆ™

#### 13. ReconcileResultå°è£…ä¸å®Œæ•´
**ä½ç½®**: `ReconciliationService.java`
```java
class ReconcileResult {
    public long total;  // å­—æ®µæ˜¯publicï¼Œè¿åå°è£…
    ...
}
```
**å»ºè®®**: ä½¿ç”¨Lombokçš„ `@Data` æ³¨è§£ï¼Œæ·»åŠ getter/setter

---

### â„¹ï¸ å¾…å®ç°åŠŸèƒ½ï¼ˆTODOæ ‡è®°ï¼‰

é¡¹ç›®ä¸­æœ‰**9ä¸ªTODOæ ‡è®°**éœ€è¦è·Ÿè¿›ï¼š

1. **UserServiceImpl**: Tokenåˆ·æ–°é€»è¾‘æœªå®ç°
2. **AuthController**: è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯é€»è¾‘æœªå®ç°
3. **ChargerServiceImpl**: è®¢å•æœåŠ¡äº‹ä»¶æœºåˆ¶æœªå®ç°ï¼ˆ2å¤„ï¼‰
4. **StationServiceImpl**: æ£€æŸ¥é€»è¾‘æœªå®ç°
5. **SysTenantServiceImpl**: ç§Ÿæˆ·åˆ é™¤å‰çš„æ•°æ®æ£€æŸ¥æœªå®ç°
6. **TenantInterceptor**: ä»æ•°æ®åº“è·å–ç§Ÿæˆ·ç±»å‹å’Œç¥–çº§è·¯å¾„
7. **DataScopeAspect**: åŸºäºè§’è‰²çš„æ•°æ®æƒé™æ£€æŸ¥æœªå®ç°
8. **WebConfig**: éç½‘å…³æœåŠ¡çš„Request-Idç”Ÿæˆ

**å»ºè®®**: åˆ›å»ºGitHub Issuesè·Ÿè¸ªè¿™äº›TODOï¼Œè¯„ä¼°ä¼˜å…ˆçº§å¹¶åˆ¶å®šå®ç°è®¡åˆ’

---

## é—®é¢˜ç»Ÿè®¡

| ä¸¥é‡ç¨‹åº¦ | æ•°é‡ | å æ¯” |
|---------|------|------|
| ğŸ”´ ä¸¥é‡ | 2 | 14% |
| ğŸŸ  é«˜ | 2 | 14% |
| ğŸŸ¡ ä¸­ | 5 | 36% |
| ğŸŸ¢ ä½ | 4 | 29% |
| â„¹ï¸ TODO | 9 | - |
| **æ€»è®¡** | **13** | **100%** |

---

## ä¿®å¤ä¼˜å…ˆçº§å»ºè®®

### ç¬¬ä¸€é˜¶æ®µï¼ˆç«‹å³ï¼‰- ç¯å¢ƒé—®é¢˜
1. âœ… ä¿®å¤Javaç‰ˆæœ¬é—®é¢˜
2. âœ… æäº¤Gradle Wrapper JAR

### ç¬¬äºŒé˜¶æ®µï¼ˆæœ¬å‘¨ï¼‰- å®‰å…¨å’Œæ ¸å¿ƒåŠŸèƒ½
1. ä¿®å¤å¼‚å¸¸å¤„ç†å™¨é¡ºåºå†²çª
2. å¢å¼ºJWTéªŒè¯é€»è¾‘ï¼ˆé˜²æ­¢è·¯å¾„éå†ï¼‰
3. æ”¹è¿›ç§Ÿæˆ·ä¸Šä¸‹æ–‡çš„å¼‚å¸¸å¤„ç†ï¼ˆè¿”å›-1æ”¹ä¸ºæŠ›å¼‚å¸¸ï¼‰

### ç¬¬ä¸‰é˜¶æ®µï¼ˆæœ¬æœˆï¼‰- æ€§èƒ½å’Œç»´æŠ¤æ€§
1. ç§»é™¤å†—ä½™çš„ç§Ÿæˆ·IDè¿‡æ»¤
2. ä¼˜åŒ–å¯¹è´¦æœåŠ¡çš„å†…å­˜ä½¿ç”¨ï¼ˆåˆ†é¡µå¤„ç†ï¼‰
3. å®Œå–„TenantContextæ¸…ç†æœºåˆ¶
4. ä¿®å¤å“åº”å¤´è®¾ç½®é—®é¢˜

### ç¬¬å››é˜¶æ®µï¼ˆä¸‹ä¸ªè¿­ä»£ï¼‰- ä»£ç è´¨é‡
1. ä¿®å¤JSONæ‹¼æ¥é—®é¢˜
2. æ”¹è¿›ReconcileResultå°è£…
3. æ¸…ç†å†—ä½™nullæ£€æŸ¥
4. æ˜ç¡®æ—¶é—´èŒƒå›´éªŒè¯è§„åˆ™

### ç¬¬äº”é˜¶æ®µï¼ˆé•¿æœŸï¼‰- æŠ€æœ¯å€ºåŠ¡
1. é€æ­¥å®ç°9ä¸ªTODOé¡¹
2. æ·»åŠ ç›¸åº”çš„å•å…ƒæµ‹è¯•
3. æ›´æ–°ç›¸å…³æ–‡æ¡£

---

## è¯¦ç»†åˆ†æ

å®Œæ•´çš„é”™è¯¯åˆ†æå’Œä¿®å¤å»ºè®®è¯·æŸ¥çœ‹ï¼š
- [ERROR-ANALYSIS.md](./ERROR-ANALYSIS.md) - è¯¦ç»†çš„é”™è¯¯åˆ†ææŠ¥å‘Šï¼ˆè‹±æ–‡ï¼‰

---

**åˆ†ææ—¥æœŸ**: 2025-01-08  
**åˆ†æå·¥å…·**: GitHub Copilot + ä»£ç å®¡æŸ¥  
**é¡¹ç›®ç‰ˆæœ¬**: commit caa5223

