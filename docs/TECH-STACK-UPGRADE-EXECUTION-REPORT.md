# æŠ€æœ¯æ ˆä¼˜åŒ–æ‰§è¡ŒæŠ¥å‘Š

**æ‰§è¡Œæ—¶é—´**: 2025-10-20 19:26  
**ä»»åŠ¡**: ç´§æ€¥å‡çº§å…³é”®ä¾èµ–ä¿®å¤ H2 å…¼å®¹æ€§é—®é¢˜  
**çŠ¶æ€**: âš ï¸ éƒ¨åˆ†æˆåŠŸï¼Œéœ€è¦è°ƒæ•´ç­–ç•¥

---

## âœ… å·²å®Œæˆçš„å‡çº§

| ç»„ä»¶ | åŸç‰ˆæœ¬ | æ–°ç‰ˆæœ¬ | çŠ¶æ€ | å¤‡æ³¨ |
|------|--------|--------|------|------|
| **PostgreSQL Driver** | 42.7.1 | 42.7.4 | âœ… æˆåŠŸ | ç¼–è¯‘é€šè¿‡ï¼Œæ— å…¼å®¹æ€§é—®é¢˜ |
| **H2 Database** | 2.2.224 | 2.3.232 | âœ… æˆåŠŸ | ç¼–è¯‘é€šè¿‡ï¼Œä½†æµ‹è¯•é—®é¢˜æœªè§£å†³ |
| **MyBatis Plus** | 3.5.6 | 3.5.7 | âœ… æˆåŠŸ | é¿å…äº† 3.5.9 çš„ API ç ´åæ€§å˜æ›´ |

---

## âŒ é‡åˆ°çš„é—®é¢˜

### é—®é¢˜ 1: MyBatis Plus 3.5.9 API å˜æ›´

**ç°è±¡**: å‡çº§åˆ° 3.5.9 åç¼–è¯‘å¤±è´¥
```
CustomTenantLineHandler.java: é”™è¯¯: æ‰¾ä¸åˆ°ç¬¦å·
net.sf.jsqlparser.expression.Expression
```

**åŸå› **: MyBatis Plus 3.5.9 å‡çº§äº†å†…éƒ¨çš„ JSQLParser ä¾èµ–ç‰ˆæœ¬ï¼Œå¯¼è‡´ API ä¸å…¼å®¹

**è§£å†³æ–¹æ¡ˆ**: é™çº§åˆ° 3.5.7 (ä»ç„¶åŒ…å« bug ä¿®å¤ï¼Œä½† API ç¨³å®š)

**å½±å“**: ä½ - 3.5.7 å·²ç»åŒ…å«å¤§éƒ¨åˆ†ä¿®å¤

---

### é—®é¢˜ 2: H2 2.3.232 æœªè§£å†³æµ‹è¯•å¤±è´¥

**ç°è±¡**: å‡çº§ H2 åï¼Œevcs-integration ä»ç„¶æ˜¯ **11/18 å¤±è´¥**

**æµ‹è¯•ç»“æœ**:
```
18 tests completed, 11 failed (61% å¤±è´¥ç‡)
```

**åˆ†æ**: 
- H2 ç‰ˆæœ¬å‡çº§**ä¸æ˜¯**æ ¹æœ¬åŸå› 
- é—®é¢˜åœ¨äºæµ‹è¯•è®¾è®¡å’Œæ•°æ®åº“ schema ä¸åŒ¹é…
- `charging_chargers` åˆ—ç¡®å®å­˜åœ¨äº schema-h2.sqlï¼Œä½†è¿è¡Œæ—¶æŠ¥é”™

**æ·±å±‚åŸå› æ¨æ–­**:
1. **Schema åˆå§‹åŒ–é—®é¢˜**: `spring.sql.init.mode=always` å¯èƒ½æœªæ­£ç¡®æ‰§è¡Œ
2. **è¡¨ç»“æ„ä¸ä¸€è‡´**: H2 åˆ›å»ºçš„è¡¨ç»“æ„ä¸ MyBatis Plus å®ä½“æ˜ å°„ä¸å®Œå…¨åŒ¹é…
3. **æµ‹è¯•éš”ç¦»é—®é¢˜**: å¤šä¸ªæµ‹è¯•ä¹‹é—´å¯èƒ½å­˜åœ¨æ•°æ®æ±¡æŸ“

---

## ğŸ“Š å½“å‰æŠ€æœ¯æ ˆçŠ¶æ€

### âœ… ç¨³å®šå‡çº§å®Œæˆ
```gradle
ext {
    springCloudVersion = '2023.0.0'       // ä¿æŒ
    springBootVersion = '3.2.2'           // ä¿æŒ
    postgresqlVersion = '42.7.4'          // âœ… å‡çº§
    mybatisPlusVersion = '3.5.7'          // âœ… å‡çº§
    h2Version = '2.3.232'                 // âœ… å‡çº§
}
```

### âš ï¸ å¾…ä¼˜åŒ–
- Hutool: 5.8.25 â†’ 5.8.34
- Fastjson2: 2.0.45 â†’ 2.0.54
- Knife4j: 4.4.0 â†’ 4.5.0

### âŒ æš‚ç¼“å‡çº§
- MyBatis Plus 3.5.9: API ç ´åæ€§å˜æ›´ï¼Œéœ€è¦ä»£ç é‡æ„
- Spring Boot 3.3.x: éœ€è¦å…ˆè§£å†³æµ‹è¯•é—®é¢˜

---

## ğŸ” æ ¹æœ¬é—®é¢˜é‡æ–°è¯„ä¼°

åŸºäºæµ‹è¯•ç»“æœï¼Œ**H2 ç‰ˆæœ¬ä¸æ˜¯ä¸»è¦é—®é¢˜**ã€‚çœŸæ­£çš„é—®é¢˜æ˜¯ï¼š

### æ¶æ„è®¾è®¡ç¼ºé™·

1. **æ··åˆèŒè´£çš„è¡¨ç»“æ„**
   ```sql
   CREATE TABLE charging_station (
       total_chargers INTEGER,      -- ç»Ÿè®¡å­—æ®µ
       available_chargers INTEGER,   -- ç»Ÿè®¡å­—æ®µ
       charging_chargers INTEGER,    -- ç»Ÿè®¡å­—æ®µ
       fault_chargers INTEGER        -- ç»Ÿè®¡å­—æ®µ
   );
   ```
   è¿™äº›å­—æ®µåº”è¯¥é€šè¿‡ **åŠ¨æ€æŸ¥è¯¢è®¡ç®—**ï¼Œè€Œä¸æ˜¯å­˜å‚¨åœ¨è¡¨ä¸­ã€‚

2. **æµ‹è¯•ä¸ç”Ÿäº§ç¯å¢ƒä¸ä¸€è‡´**
   - ç”Ÿäº§: PostgreSQL
   - æµ‹è¯•: H2 (æ¨¡æ‹Ÿ PostgreSQL æ¨¡å¼)
   - ç»“æœ: å¾®å¦™çš„å…¼å®¹æ€§å·®å¼‚ç´¯ç§¯æˆå¤§é—®é¢˜

3. **æµ‹è¯•æ•°æ®ç®¡ç†æ··ä¹±**
   - Schema åˆ†æ•£åœ¨å¤šä¸ªæ–‡ä»¶
   - æ²¡æœ‰ç»Ÿä¸€çš„æµ‹è¯•æ•°æ®å·¥å‚
   - æµ‹è¯•é—´å¯èƒ½å­˜åœ¨ç›¸äº’å½±å“

---

## ğŸ’¡ æ¨èçš„è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ 1: ç®€åŒ–è¡¨ç»“æ„ (æ¨è) â­â­â­â­â­

**æ”¹é€  charging_station è¡¨**:
```sql
-- ç§»é™¤ç»Ÿè®¡å­—æ®µ
CREATE TABLE charging_station (
    station_id BIGSERIAL PRIMARY KEY,
    tenant_id BIGINT NOT NULL,
    station_code VARCHAR(64) NOT NULL,
    station_name VARCHAR(100) NOT NULL,
    address VARCHAR(255),
    -- ... å…¶ä»–åŸºç¡€å­—æ®µ
    -- âŒ åˆ é™¤: total_chargers, available_chargers, charging_chargers, fault_chargers
);
```

**é€šè¿‡è§†å›¾æˆ–åŠ¨æ€æŸ¥è¯¢è·å–ç»Ÿè®¡**:
```java
// StationMapper ä¸­å·²æœ‰çš„æŸ¥è¯¢ï¼ˆä¿ç•™ï¼‰
@Select("""
    SELECT s.*, 
           COUNT(c.charger_id) as total_chargers,
           COUNT(CASE WHEN c.status = 1 THEN 1 END) as available_chargers,
           ...
    FROM charging_station s
    LEFT JOIN charger c ON s.station_id = c.station_id
    GROUP BY s.station_id
    """)
IPage<Station> selectStationPageWithStats(...);
```

**ä¼˜åŠ¿**:
- âœ… æ¶ˆé™¤äº† H2 å…¼å®¹æ€§é—®é¢˜çš„æ ¹æº
- âœ… æ•°æ®ä¸€è‡´æ€§ä¿è¯ï¼ˆå®æ—¶è®¡ç®—ï¼Œä¸ä¼šè¿‡æœŸï¼‰
- âœ… ç®€åŒ–äº†è§¦å‘å™¨é€»è¾‘
- âœ… æµ‹è¯•æ›´å®¹æ˜“é€šè¿‡

**å·¥ä½œé‡**: 2-3 å°æ—¶ï¼ˆä¿®æ”¹ schemaï¼Œæ›´æ–°å®ä½“ç±»ï¼Œè°ƒæ•´æœåŠ¡å±‚ï¼‰

---

### æ–¹æ¡ˆ 2: ä½¿ç”¨ Testcontainers (é•¿æœŸ) â­â­â­â­

**æ”¾å¼ƒ H2ï¼Œä½¿ç”¨çœŸå® PostgreSQL**:
```gradle
dependencies {
    testImplementation 'org.testcontainers:postgresql:1.19.3'
}
```

```java
@Testcontainers
class IntegrationTest {
    @Container
    static PostgreSQLContainer<?> postgres = new PostgreSQLContainer<>("postgres:15-alpine")
        .withDatabaseName("testdb")
        .withUsername("test")
        .withPassword("test");
        
    @DynamicPropertySource
    static void properties(DynamicPropertyRegistry registry) {
        registry.add("spring.datasource.url", postgres::getJdbcUrl);
        registry.add("spring.datasource.username", postgres::getUsername);
        registry.add("spring.datasource.password", postgres::getPassword);
    }
}
```

**ä¼˜åŠ¿**:
- âœ… 100% ç”Ÿäº§ç¯å¢ƒä¸€è‡´æ€§
- âœ… æ— å…¼å®¹æ€§é—®é¢˜
- âœ… æ”¯æŒè§¦å‘å™¨ã€å­˜å‚¨è¿‡ç¨‹ç­‰é«˜çº§ç‰¹æ€§

**åŠ£åŠ¿**:
- âš ï¸ éœ€è¦ Docker
- âš ï¸ æµ‹è¯•å¯åŠ¨æ…¢ 5-10 ç§’
- âš ï¸ CI/CD éœ€è¦é¢å¤–é…ç½®

**å·¥ä½œé‡**: 1 å¤©ï¼ˆé…ç½® Testcontainersï¼Œæ›´æ–°æµ‹è¯•åŸºç±»ï¼‰

---

### æ–¹æ¡ˆ 3: æ··åˆç­–ç•¥ (æœ€ä½³) â­â­â­â­â­

**å•å…ƒæµ‹è¯•**: ä½¿ç”¨ H2 + ç®€åŒ– schema (æ–¹æ¡ˆ 1)  
**é›†æˆæµ‹è¯•**: ä½¿ç”¨ Testcontainers (æ–¹æ¡ˆ 2)

```
evcs-station/
â”œâ”€â”€ src/main/java/          # ä¸šåŠ¡ä»£ç 
â”œâ”€â”€ src/test/java/
â”‚   â”œâ”€â”€ unit/               # å•å…ƒæµ‹è¯• (H2, å¿«é€Ÿ)
â”‚   â””â”€â”€ integration/        # é›†æˆæµ‹è¯• (Testcontainers, çœŸå®)
â””â”€â”€ src/test/resources/
    â”œâ”€â”€ application-test.yml      # H2 é…ç½®
    â””â”€â”€ application-integration.yml # Testcontainers é…ç½®
```

**å·¥ä½œé‡**: 3-4 å°æ—¶

---

## ğŸ“‹ ä¿®æ­£åçš„æ‰§è¡Œè®¡åˆ’

### ä»Šå¤©å‰©ä½™æ—¶é—´

1. âœ… **æŠ€æœ¯æ ˆå‡çº§å®Œæˆ**: PostgreSQL 42.7.4, H2 2.3.232, MyBatis Plus 3.5.7
2. ğŸ”„ **é€‰æ‹©è§£å†³æ–¹æ¡ˆ**: æ¨è**æ–¹æ¡ˆ 1ï¼ˆç®€åŒ–è¡¨ç»“æ„ï¼‰**
3. ğŸ”„ **å¼€å§‹å®æ–½**: 
   - ä¿®æ”¹ `schema-h2.sql`: ç§»é™¤ç»Ÿè®¡å­—æ®µ
   - æ›´æ–° `Station` å®ä½“: æ ‡è®°ç»Ÿè®¡å­—æ®µä¸º `@TableField(exist = false)`
   - æµ‹è¯•éªŒè¯

### æ˜å¤©

4. å®Œæˆæ–¹æ¡ˆ 1 çš„å…¨éƒ¨ä¿®æ”¹
5. è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶
6. è¯„ä¼° Testcontainers æ–¹æ¡ˆ
7. æ›´æ–°æ–‡æ¡£

---

## ğŸ¯ é¢„æœŸæˆæœï¼ˆä¿®æ­£ï¼‰

### çŸ­æœŸ (æœ¬å‘¨)
- âœ… PostgreSQL Driver å‡çº§å®Œæˆ
- âœ… H2 å‡çº§å®Œæˆï¼ˆå³ä½¿æœªè§£å†³æµ‹è¯•é—®é¢˜ï¼‰
- ğŸ”„ **é€šè¿‡ç®€åŒ–è¡¨ç»“æ„è§£å†³æµ‹è¯•é—®é¢˜**
- ğŸ”„ evcs-integration æµ‹è¯•é€šè¿‡ç‡ > 95%

### ä¸­æœŸ (ä¸‹å‘¨)
- Testcontainers é›†æˆæµ‹è¯•æ–¹æ¡ˆè½åœ°
- Spring Boot 3.3.5 å‡çº§è¯„ä¼°
- å®Œæ•´æµ‹è¯•è¦†ç›–ç‡ > 80%

---

## ğŸ“ ç»éªŒæ•™è®­

### 1. ç‰ˆæœ¬å‡çº§ä¸æ˜¯ä¸‡èƒ½è¯
- H2 ä» 2.2.224 å‡çº§åˆ° 2.3.232 **æ²¡æœ‰è§£å†³é—®é¢˜**
- é—®é¢˜æ ¹æºåœ¨äº**æ¶æ„è®¾è®¡**ï¼Œä¸åœ¨äºä¾èµ–ç‰ˆæœ¬

### 2. æ¸è¿›å¼å‡çº§ç­–ç•¥æ­£ç¡®
- MyBatis Plus 3.5.9 å¼•å…¥ API ç ´åæ€§å˜æ›´
- 3.5.7 æ˜¯æ›´ç¨³å¦¥çš„é€‰æ‹©
- é¿å…äº†å¤§é‡é‡æ„å·¥ä½œ

### 3. æµ‹è¯•ç¯å¢ƒä¸ç”Ÿäº§ç¯å¢ƒä¸€è‡´æ€§å¾ˆé‡è¦
- H2 "æ¨¡æ‹Ÿ" PostgreSQL æ°¸è¿œä¸æ˜¯çœŸæ­£çš„ PostgreSQL
- Testcontainers æ˜¯æ›´å¥½çš„é•¿æœŸæ–¹æ¡ˆ

### 4. ç»Ÿè®¡å­—æ®µä¸åº”å­˜å‚¨
- `total_chargers`, `available_chargers` ç­‰å­—æ®µåº”è¯¥å®æ—¶è®¡ç®—
- å­˜å‚¨ç»Ÿè®¡æ•°æ®ä¼šå¯¼è‡´:
  - æ•°æ®ä¸€è‡´æ€§é—®é¢˜
  - å¤æ‚çš„è§¦å‘å™¨é€»è¾‘
  - æµ‹è¯•éš¾åº¦å¢åŠ 

---

## ğŸ”„ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

### ç«‹å³æ‰§è¡Œ (ä»Šå¤©)
1. **å®æ–½æ–¹æ¡ˆ 1**: ç®€åŒ– charging_station è¡¨ç»“æ„
   - æ–‡ä»¶: `evcs-integration/src/test/resources/schema-h2.sql`
   - æ–‡ä»¶: `evcs-station/src/main/java/com/evcs/station/entity/Station.java`
   - é¢„è®¡æ—¶é—´: 1-2 å°æ—¶

2. **è¿è¡Œæµ‹è¯•éªŒè¯**:
   ```bash
   ./gradlew :evcs-integration:test --rerun-tasks
   ```

### åç»­è®¡åˆ’
3. è¯„ä¼° Testcontainers æ–¹æ¡ˆå¯è¡Œæ€§
4. åˆ›å»ºæ··åˆæµ‹è¯•ç­–ç•¥æ–‡æ¡£
5. æ›´æ–° CI/CD é…ç½®

---

**æ€»ç»“**: æŠ€æœ¯æ ˆå‡çº§å®Œæˆäº† **PostgreSQL Driver** å’Œ **H2** çš„å‡çº§ï¼Œä½†æµ‹è¯•é—®é¢˜çš„æ ¹æºæ˜¯**è¡¨ç»“æ„è®¾è®¡ä¸åˆç†**ã€‚ä¸‹ä¸€æ­¥åº”è¯¥**ç®€åŒ–è¡¨ç»“æ„**ï¼Œå°†ç»Ÿè®¡å­—æ®µæ”¹ä¸ºåŠ¨æ€è®¡ç®—ï¼Œè€Œä¸æ˜¯ç»§ç»­è¿½æ±‚ä¾èµ–ç‰ˆæœ¬çš„å‡çº§ã€‚

---

**æ‰§è¡Œäºº**: GitHub Copilot  
**å®¡æŸ¥**: å¾…å›¢é˜Ÿç¡®è®¤æ–¹æ¡ˆé€‰æ‹©
