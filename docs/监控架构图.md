# EVCS Manager 监控架构图

## 整体架构

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          EVCS Manager 应用层                              │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                           │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐│
│  │ evcs-station │  │  evcs-order  │  │ evcs-payment │  │  evcs-tenant ││
│  │   Service    │  │   Service    │  │   Service    │  │   Service    ││
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘│
│         │                  │                  │                  │        │
│         └──────────────────┴──────────────────┴──────────────────┘        │
│                                    │                                      │
│                          ┌─────────▼─────────┐                           │
│                          │   evcs-common     │                           │
│                          │  (共享监控框架)     │                           │
│                          └───────────────────┘                           │
└─────────────────────────────────────────────────────────────────────────┘
```

## 监控数据流

```
┌──────────────────────────────────────────────────────────────────────────┐
│                           数据采集层                                       │
└──────────────────────────────────────────────────────────────────────────┘
                                    │
                    ┌───────────────┼───────────────┐
                    │               │               │
                    ▼               ▼               ▼
        ┌──────────────┐  ┌──────────────┐  ┌──────────────┐
        │   日志数据     │  │   指标数据     │  │   追踪数据     │
        │              │  │              │  │  (规划中)      │
        │  Logback     │  │  Micrometer  │  │              │
        │  JSON格式     │  │  Prometheus  │  │  Zipkin      │
        └──────┬───────┘  └──────┬───────┘  └──────┬───────┘
               │                  │                  │
               ▼                  ▼                  ▼
┌──────────────────────────────────────────────────────────────────────────┐
│                           数据传输层                                       │
└──────────────────────────────────────────────────────────────────────────┘
               │                  │                  │
          Filebeat           Actuator          HTTP Client
               │              /actuator            │
               ▼             /prometheus           ▼
┌──────────────────────────────────────────────────────────────────────────┐
│                           数据存储层                                       │
└──────────────────────────────────────────────────────────────────────────┘
               │                  │                  │
               ▼                  ▼                  ▼
        ┌──────────────┐  ┌──────────────┐  ┌──────────────┐
        │              │  │              │  │              │
        │ Logstash     │  │ Prometheus   │  │   Zipkin     │
        │      ↓       │  │   (TSDB)     │  │  (规划中)     │
        │Elasticsearch │  │              │  │              │
        │              │  │              │  │              │
        └──────┬───────┘  └──────┬───────┘  └──────┬───────┘
               │                  │                  │
               ▼                  ▼                  ▼
┌──────────────────────────────────────────────────────────────────────────┐
│                           可视化层                                         │
└──────────────────────────────────────────────────────────────────────────┘
               │                  │                  │
               ▼                  ▼                  ▼
        ┌──────────────┐  ┌──────────────┐  ┌──────────────┐
        │              │  │              │  │              │
        │   Kibana     │  │   Grafana    │  │  Jaeger UI   │
        │              │  │              │  │  (规划中)     │
        │  日志查询     │  │  指标监控     │  │  链路追踪     │
        │  日志分析     │  │  Dashboard   │  │              │
        │              │  │  告警配置     │  │              │
        └──────────────┘  └──────────────┘  └──────────────┘
```

## 日志体系架构

```
┌─────────────────────────────────────────────────────────────────┐
│                        应用程序                                   │
│                                                                   │
│  ┌─────────────────────────────────────────────────────┐        │
│  │  Logback + LogstashEncoder                          │        │
│  │                                                       │        │
│  │  ┌──────────────┐    ┌──────────────────────────┐  │        │
│  │  │  日志输出     │───▶│  SensitiveDataMasker    │  │        │
│  │  │              │    │  (敏感信息脱敏)           │  │        │
│  │  └──────────────┘    └───────────┬──────────────┘  │        │
│  │                                   │                  │        │
│  │                                   ▼                  │        │
│  │                      ┌────────────────────────┐     │        │
│  │                      │  JSON格式日志           │     │        │
│  │                      │  - timestamp            │     │        │
│  │                      │  - level                │     │        │
│  │                      │  - logger               │     │        │
│  │                      │  - message              │     │        │
│  │                      │  - thread               │     │        │
│  │                      │  - traceId              │     │        │
│  │                      │  - tenantId             │     │        │
│  │                      │  - userId               │     │        │
│  │                      └────────────┬────────────┘     │        │
│  └──────────────────────────────────┼──────────────────┘        │
└────────────────────────────────────┼───────────────────────────┘
                                      │
                                      ▼
                           ┌──────────────────┐
                           │  Log Files       │
                           │  /var/log/evcs/  │
                           └─────────┬────────┘
                                     │
                                     ▼
                           ┌──────────────────┐
                           │  Filebeat        │
                           │  (日志采集)       │
                           └─────────┬────────┘
                                     │
                                     ▼
                           ┌──────────────────┐
                           │  Logstash        │
                           │  (日志处理)       │
                           └─────────┬────────┘
                                     │
                                     ▼
                           ┌──────────────────┐
                           │  Elasticsearch   │
                           │  (日志存储)       │
                           └─────────┬────────┘
                                     │
                                     ▼
                           ┌──────────────────┐
                           │  Kibana          │
                           │  (日志查询分析)    │
                           └──────────────────┘
```

## 指标监控架构

```
┌─────────────────────────────────────────────────────────────────┐
│                        应用程序                                   │
│                                                                   │
│  ┌─────────────────────────────────────────────────────┐        │
│  │  Spring Boot Actuator                               │        │
│  │                                                       │        │
│  │  ┌──────────────────────────────────────────┐       │        │
│  │  │  BusinessMetrics (业务指标基类)          │       │        │
│  │  │                                           │       │        │
│  │  │  ┌────────────┐  ┌────────────┐         │       │        │
│  │  │  │  Counter   │  │   Gauge    │         │       │        │
│  │  │  ├────────────┤  ├────────────┤         │       │        │
│  │  │  │ 订单创建数  │  │ 充电桩在线率 │         │       │        │
│  │  │  │ 支付成功数  │  │ 订单成功率   │         │       │        │
│  │  │  └────────────┘  └────────────┘         │       │        │
│  │  │                                           │       │        │
│  │  │  ┌────────────┐  ┌────────────┐         │       │        │
│  │  │  │   Timer    │  │  Summary   │         │       │        │
│  │  │  ├────────────┤  ├────────────┤         │       │        │
│  │  │  │ 响应时间    │  │ 请求大小    │         │       │        │
│  │  │  │ 查询时间    │  │            │         │       │        │
│  │  │  └────────────┘  └────────────┘         │       │        │
│  │  └──────────────────────────────────────────┘       │        │
│  │                          │                           │        │
│  │                          ▼                           │        │
│  │                ┌──────────────────┐                  │        │
│  │                │  MeterRegistry   │                  │        │
│  │                └─────────┬────────┘                  │        │
│  └──────────────────────────┼───────────────────────────┘        │
└────────────────────────────┼────────────────────────────────────┘
                              │
                              ▼
                   ┌──────────────────────┐
                   │  /actuator/prometheus │
                   │  (Prometheus格式指标)  │
                   └──────────┬────────────┘
                              │
                              │ HTTP Pull (每15秒)
                              │
                              ▼
                   ┌──────────────────────┐
                   │    Prometheus        │
                   │   (时序数据库)        │
                   │                      │
                   │  - 指标存储          │
                   │  - 数据聚合          │
                   │  - 告警评估          │
                   └──────────┬────────────┘
                              │
              ┌───────────────┼───────────────┐
              │               │               │
              ▼               ▼               ▼
    ┌──────────────┐  ┌──────────────┐  ┌──────────────┐
    │  Grafana     │  │ AlertManager │  │  Prometheus  │
    │              │  │              │  │    API       │
    │ - Dashboard  │  │ - 告警通知    │  │  - PromQL    │
    │ - 图表展示    │  │ - 告警聚合    │  │  - 数据查询   │
    │ - 告警配置    │  │ - 告警路由    │  │              │
    └──────────────┘  └──────────────┘  └──────────────┘
```

## 健康检查与熔断架构

```
┌─────────────────────────────────────────────────────────────────┐
│                        应用程序                                   │
│                                                                   │
│  ┌──────────────────────────────────────────────────┐           │
│  │  Health Check (健康检查)                         │           │
│  │                                                    │           │
│  │  ┌──────────────┐  ┌──────────────────────────┐ │           │
│  │  │   Database   │  │  CustomDatabase          │ │           │
│  │  │  Connection  │  │  HealthIndicator         │ │           │
│  │  └──────────────┘  └──────────────────────────┘ │           │
│  │                                                    │           │
│  │  ┌──────────────┐  ┌──────────────────────────┐ │           │
│  │  │    Redis     │  │      RabbitMQ            │ │           │
│  │  │  Connection  │  │     Connection           │ │           │
│  │  └──────────────┘  └──────────────────────────┘ │           │
│  │                                                    │           │
│  │  ┌──────────────┐  ┌──────────────────────────┐ │           │
│  │  │  Disk Space  │  │      Memory              │ │           │
│  │  │              │  │      Usage               │ │           │
│  │  └──────────────┘  └──────────────────────────┘ │           │
│  └────────────────────────────┬───────────────────────┘           │
│                               │                                   │
│                               ▼                                   │
│                    ┌────────────────────┐                         │
│                    │  /actuator/health  │                         │
│                    └────────────────────┘                         │
│                                                                   │
│  ┌──────────────────────────────────────────────────┐           │
│  │  Resilience4j (弹性框架)                         │           │
│  │                                                    │           │
│  │  ┌──────────────────┐                            │           │
│  │  │  Circuit Breaker │                            │           │
│  │  │   (熔断器)        │                            │           │
│  │  │                  │                            │           │
│  │  │  ┌────────────┐  │  ┌──────────┐             │           │
│  │  │  │  CLOSED    │──┼─▶│  OPEN    │             │           │
│  │  │  │  (正常)     │  │  │ (熔断)   │             │           │
│  │  │  └─────┬──────┘  │  └────┬─────┘             │           │
│  │  │        │         │       │                    │           │
│  │  │        └─────────┼───────┘                    │           │
│  │  │                  │       │                    │           │
│  │  │                  ▼       ▼                    │           │
│  │  │           ┌──────────────────┐               │           │
│  │  │           │   HALF_OPEN      │               │           │
│  │  │           │   (半开)          │               │           │
│  │  │           └──────────────────┘               │           │
│  │  └──────────────────┘                            │           │
│  │                                                    │           │
│  │  ┌──────────────┐  ┌──────────────┐             │           │
│  │  │ Rate Limiter │  │    Retry     │             │           │
│  │  │  (限流器)     │  │   (重试)      │             │           │
│  │  └──────────────┘  └──────────────┘             │           │
│  │                                                    │           │
│  │  ┌──────────────┐  ┌──────────────┐             │           │
│  │  │   Timeout    │  │   Bulkhead   │             │           │
│  │  │   (超时)      │  │   (舱壁)      │             │           │
│  │  └──────────────┘  └──────────────┘             │           │
│  └────────────────────────────┬───────────────────────┘           │
│                               │                                   │
│                               ▼                                   │
│                   ┌──────────────────────────┐                   │
│                   │ /actuator/circuitbreakers│                   │
│                   │ /actuator/ratelimiters   │                   │
│                   └──────────────────────────┘                   │
└─────────────────────────────────────────────────────────────────┘
```

## 告警流程

```
┌───────────────┐
│  Prometheus   │
│  (指标采集)    │
└───────┬───────┘
        │
        │ 评估告警规则 (每15秒)
        │
        ▼
┌───────────────────────────────────────────┐
│  Alert Rules (告警规则)                    │
│                                            │
│  ┌──────────────────────────────────┐    │
│  │  expr: up == 0                   │    │
│  │  for: 1m                         │    │
│  │  severity: critical              │    │
│  │  summary: "服务宕机"              │    │
│  └──────────────────────────────────┘    │
│                                            │
│  ┌──────────────────────────────────┐    │
│  │  expr: error_rate > 0.05         │    │
│  │  for: 5m                         │    │
│  │  severity: warning               │    │
│  │  summary: "错误率过高"            │    │
│  └──────────────────────────────────┘    │
└───────────────┬───────────────────────────┘
                │
                │ 触发告警
                │
                ▼
     ┌──────────────────┐
     │  AlertManager    │
     │  (告警管理)       │
     └─────────┬────────┘
               │
               │ 告警处理
               │
               ├──────────┬──────────┬──────────┐
               │          │          │          │
               ▼          ▼          ▼          ▼
        ┌──────────┐┌─────────┐┌─────────┐┌─────────┐
        │  钉钉     ││  邮件   ││ 企业微信 ││  短信   │
        │  通知     ││  通知   ││  通知   ││  通知   │
        └──────────┘└─────────┘└─────────┘└─────────┘
```

## 多租户监控隔离

```
┌─────────────────────────────────────────────────────────────┐
│                      指标维度设计                             │
└─────────────────────────────────────────────────────────────┘

指标名称：evcs_order_created_total

维度 (Labels):
  - tenant_id: "1001"        # 租户ID
  - service: "evcs-order"    # 服务名称
  - instance: "10.0.1.2:8080" # 实例地址
  - environment: "prod"      # 环境（dev/test/prod）

查询示例:
  # 查询特定租户的订单创建数
  evcs_order_created_total{tenant_id="1001"}

  # 查询所有租户的订单创建数
  sum(evcs_order_created_total) by (tenant_id)

  # 计算租户的订单创建速率
  rate(evcs_order_created_total{tenant_id="1001"}[5m])
```

## 监控数据保留策略

```
┌──────────────────────────────────────────────────────────────┐
│                       数据保留策略                             │
├──────────────────────────────────────────────────────────────┤
│                                                                │
│  日志数据 (Elasticsearch)                                      │
│    - 热数据（0-7天）：  SSD存储，快速查询                       │
│    - 温数据（7-30天）： HDD存储，归档查询                       │
│    - 冷数据（>30天）：  删除或归档到S3                         │
│                                                                │
│  指标数据 (Prometheus)                                         │
│    - 原始数据（15秒）：  保留15天                              │
│    - 1分钟聚合：        保留60天                               │
│    - 5分钟聚合：        保留180天                              │
│    - 1小时聚合：        保留1年                                │
│                                                                │
│  追踪数据 (Zipkin/Jaeger) - 规划中                            │
│    - 完整追踪：         保留7天                                │
│    - 采样追踪（1%）：    保留30天                              │
│                                                                │
└──────────────────────────────────────────────────────────────┘
```

## 监控告警分级

```
┌──────────────────────────────────────────────────────────────┐
│                       告警级别定义                             │
├──────────────────────────────────────────────────────────────┤
│                                                                │
│  🔴 Critical (紧急)                                            │
│    - 服务完全不可用                                            │
│    - 数据丢失风险                                              │
│    - 立即通知：短信 + 电话 + 钉钉                              │
│    - 响应时间：5分钟内                                         │
│                                                                │
│  🟡 Warning (警告)                                             │
│    - 服务降级                                                  │
│    - 性能下降                                                  │
│    - 通知方式：钉钉 + 邮件                                     │
│    - 响应时间：30分钟内                                        │
│                                                                │
│  🔵 Info (信息)                                                │
│    - 一般性通知                                                │
│    - 系统状态变更                                              │
│    - 通知方式：仅记录                                          │
│    - 响应时间：工作时间处理                                    │
│                                                                │
└──────────────────────────────────────────────────────────────┘
```

---

## 架构说明

### 设计原则

1. **统一性**: 所有服务使用统一的监控框架（evcs-common）
2. **可扩展**: 业务指标框架支持各服务自定义扩展
3. **多租户**: 指标和日志都带租户维度，支持租户隔离查询
4. **高可用**: 监控组件独立部署，不影响业务系统
5. **标准化**: 遵循Prometheus、ELK等业界标准

### 技术选型理由

| 组件 | 选型 | 理由 |
|------|------|------|
| 日志框架 | Logback | Spring Boot默认，成熟稳定 |
| 日志格式 | JSON | 便于机器解析，结构化查询 |
| 日志收集 | ELK Stack | 业界标准，功能强大 |
| 指标框架 | Micrometer | Spring Boot集成，支持多种后端 |
| 指标存储 | Prometheus | CNCF毕业项目，云原生标准 |
| 可视化 | Grafana | 功能强大，社区活跃 |
| 弹性框架 | Resilience4j | 轻量级，专为Java 8+设计 |

---

**文档版本**: 1.0  
**创建日期**: 2025-10-12  
**作者**: GitHub Copilot
