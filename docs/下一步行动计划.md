# EVCS Manager 下一步行动计划

> **更新日期**: 2025-10-11  
> **当前阶段**: P3（生产就绪准备）  
> **规划周期**: 6周（剩余）

---

## 一、项目当前状态

### 已完成里程碑 ✅

#### P0 & P1 阶段（基础架构）
- ✅ 多租户四层隔离架构完整实现
- ✅ 分时计费系统（TOU）：96段/日、16组/站点
- ✅ 订单管理：开始/结束闭环、幂等性保证
- ✅ 充电站与充电桩管理（CRUD + 状态管理）
- ✅ Prometheus指标暴露与健康检查

#### M3 里程碑（支付集成）
- ✅ 支付宝集成（APP支付 + 扫码支付）
- ✅ 微信支付集成（小程序 + Native扫码）
- ✅ 支付对账功能
- ✅ 完整的集成测试套件

#### M6 里程碑（代码质量提升）
- ✅ 集成测试框架建立
- ✅ 多租户隔离测试
- ✅ 代码质量改进

### 待完成任务 ⏳

#### P2 阶段遗留
- ⏳ 协议事件流完整对接（OCPP + 云快充）
- ⏳ RabbitMQ消息队列集成
- ⏳ 分布式计费计划缓存广播
- ⏳ 前端管理界面

#### P3 阶段规划
- 📋 环境修复与安全加固（第1周）
- 📋 性能优化与压测（第4周）
- 📋 监控与运维体系（第7周）
- 📋 测试与发布准备（第8周）

---

## 二、优先级任务清单

### 🔴 第一优先级：环境修复与安全加固（第1周）

**目标**: 消除所有阻塞性和高危问题

#### 任务详情

1. **ENV-01: 统一Java版本到21**
   - 更新本地开发环境配置
   - 更新CI/CD配置（GitHub Actions）
   - 更新Docker镜像基础镜像
   - 验证 `./gradlew build` 在干净环境通过
   - **预计时间**: 1小时

2. **ENV-02: 提交Gradle Wrapper JAR到仓库**
   - 运行 `gradle wrapper --gradle-version 8.5`
   - 提交 `gradle/wrapper/gradle-wrapper.jar`
   - 验证构建通过
   - **预计时间**: 1小时

3. **GW-01/SEC-01: 修复JWT白名单路径遍历漏洞**
   - 实现路径规范化（Path Normalization）
   - 使用精确路径匹配替代前缀匹配
   - 添加路径遍历攻击测试用例
   - 代码审查确认修复有效
   - **预计时间**: 4小时

4. **SEC-02: 租户ID为null时抛出异常**
   - 定义 `TenantContextMissingException` 异常类
   - 修改 `CustomTenantLineHandler.getTenantId()`
   - 在 `GlobalExceptionHandler` 添加异常处理
   - 添加单元测试覆盖异常场景
   - **预计时间**: 2小时

5. **THR-01: 完善TenantContext清理机制**
   - 在 `TenantInterceptor` 的 `finally` 块确保清理
   - 研究使用 `TransmittableThreadLocal` 替代 `ThreadLocal`
   - 实现线程池任务的上下文传递
   - 添加并发测试（100线程 × 100请求）
   - **预计时间**: 4小时

6. **EXC-01: 修复GlobalExceptionHandler顺序冲突**
   - 移除冗余的 `handleRuntimeException` 方法
   - 调整异常处理器的 `@Order` 注解
   - 测试异常处理返回正确的HTTP状态码
   - **预计时间**: 2小时

**验收标准**:
- ✅ `./gradlew build` 在干净环境通过
- ✅ 安全扫描通过，无已知高危漏洞
- ✅ 并发测试通过，无上下文泄漏

---

### 🟠 第二优先级：协议事件流对接（第2周）

**目标**: 打通OCPP和云快充协议的完整事件流

#### 任务详情

1. **协议事件统一模型设计**
   - 创建 `ProtocolEvent` 基类
   - 实现 `HeartbeatEvent`, `StatusEvent`, `StartEvent`, `StopEvent`
   - 定义事件发布者接口 `IProtocolEventPublisher`
   - 定义事件消费者接口 `IProtocolEventConsumer`
   - **预计时间**: 6小时

2. **协议适配器实现**
   - OCPP协议适配器（WebSocket通信）
   - 云快充协议适配器（HTTP REST）
   - 协议报文解析与转换
   - **预计时间**: 6小时

3. **RabbitMQ消息队列集成**
   - 配置Exchange: `evcs.protocol.events` (Topic类型)
   - 配置Queue: `evcs.protocol.heartbeat`, `evcs.protocol.charging`
   - 配置DLQ死信队列
   - 实现消息生产者（持久化 + 确认机制）
   - 实现消息消费者（手动ack + 幂等性）
   - **预计时间**: 8小时

4. **协议调试工具完善**
   - 完善 `ProtocolDebugController` 功能
   - 添加事件模拟接口（/debug/protocol/simulate）
   - 实现协议报文查看功能
   - 实时事件流显示（WebSocket推送）
   - **预计时间**: 6小时

5. **协议联调与测试**
   - OCPP协议模拟器测试
   - 云快充协议模拟器测试
   - 压力测试（目标1000 TPS）
   - 编写协议对接文档
   - **预计时间**: 8小时

**验收标准**:
- ✅ 协议事件端到端流转，无消息丢失
- ✅ 压力测试达到1000 TPS
- ✅ 协议对接文档完整

---

### 🟡 第三优先级：分布式缓存与性能优化（第4周）

**目标**: 实现缓存广播，优化系统性能

#### 任务详情

1. **Redis分布式缓存设计**
   - 缓存键设计：`billing:plan:{stationId}:{planId}`
   - 缓存键设计：`billing:plan:default:{stationId}`
   - 缓存过期策略（TTL=1小时 + LRU淘汰）
   - **预计时间**: 4小时

2. **Redis Topic广播实现**
   - 创建Topic: `billing:plan:update`
   - 计划更新时发布广播消息
   - 各实例订阅Topic并清理本地缓存
   - 实现 `BillingPlanCacheService`
   - **预计时间**: 8小时

3. **对账服务性能优化（PERF-01）**
   - 改造 `ReconciliationService.runDaily()` 方法
   - 批量查询订单（每批1000条）
   - 流式处理避免OOM
   - 添加对账进度跟踪
   - 支持断点续传
   - **预计时间**: 6小时

4. **数据库查询优化**
   - 启用PostgreSQL慢查询日志（log_min_duration_statement=500ms）
   - 收集TOP 10慢查询
   - 使用EXPLAIN ANALYZE分析执行计划
   - 添加必要索引：
     * `idx_tenant_start_time ON charging_order(tenant_id, start_time)`
     * `idx_charger_status ON charging_order(charger_id, status)`
     * `idx_station_status ON charger(station_id, status)`
   - **预计时间**: 6小时

5. **接口性能压测**
   - JMeter压测脚本编写
     * 订单创建接口（目标：500 TPS）
     * 订单查询接口（目标：1000 TPS）
     * 充电桩状态更新（目标：2000 TPS）
   - 执行压测并记录性能数据
   - 性能瓶颈分析与调优（Async Profiler火焰图）
   - 编写性能测试报告
   - **预计时间**: 8小时

**验收标准**:
- ✅ 多实例缓存一致性测试通过
- ✅ 对账处理100万订单无OOM
- ✅ 慢查询数量减少80%以上
- ✅ 性能指标达标

---

### 🟢 第四优先级：前端管理界面开发（第5周）

**目标**: 完成核心管理界面的原型

#### 任务详情

1. **前端技术栈选型**
   - 技术选型决策会议
   - 推荐：Vue 3 + Vite + Element Plus + TypeScript
   - 备选：React + Next.js + Ant Design
   - 前端项目脚手架搭建
   - **预计时间**: 4小时

2. **租户与用户管理界面**
   - 租户列表页（表格 + 分页 + 搜索）
   - 租户详情页（信息展示 + 编辑按钮）
   - 租户新增/编辑表单（表单验证）
   - 租户树形结构展示
   - 用户管理界面
   - 角色与权限配置
   - **预计时间**: 12小时

3. **充电站与充电桩管理界面**
   - 充电站列表页（卡片视图 + 列表视图）
   - 充电站地图展示（集成高德地图/百度地图）
   - 充电站详情页
   - 充电桩状态监控（实时状态展示）
   - **预计时间**: 12小时

4. **订单管理与计费配置界面**
   - 订单列表页（表格 + 高级搜索 + 导出Excel）
   - 订单详情页（订单信息 + 充电时间轴 + 支付信息）
   - 订单统计Dashboard
   - 计费计划配置
   - 计费计划分段可视化编辑器
   - **预计时间**: 8小时

**验收标准**:
- ✅ 前端原型可运行
- ✅ 核心管理功能界面完整
- ✅ 响应式设计良好

---

### 🟢 第五优先级：功能改进与代码质量提升（第6周）

**目标**: 修复中低优先级问题，提升代码质量

#### 任务详情

1. **TNT-01: 移除手动tenant_id过滤**
   - 审查 `evcs-order`, `evcs-station`, `evcs-tenant` 模块
   - 移除冗余的 `WHERE tenant_id = ?` SQL条件
   - 依赖MyBatis Plus自动过滤
   - **预计时间**: 4小时

2. **GW-02: 修复响应头设置时机**
   - 将响应头设置移到正确位置
   - 确保X-Request-Id正确传递
   - 实现非网关服务的X-Request-Id生成
   - **预计时间**: 4小时

3. **代码质量改进**
   - QUA-01: 使用Jackson处理JSON（替代手动拼接）
   - QUA-02: 完善ReconcileResult封装（Builder模式）
   - VAL-01: 清理冗余null检查（使用Optional）
   - VAL-02: 明确时间范围验证规则（统一验证工具）
   - **预计时间**: 12小时

4. **TODO项清理（9项）**
   - 实现 `UserServiceImpl.refreshToken()`
   - 实现 `AuthController.getCurrentUser()`
   - 实现充电桩事件机制（替代循环依赖）
   - 完善DataScope基于角色的权限检查
   - 其他5个TODO项
   - **预计时间**: 8小时

**验收标准**:
- ✅ 代码中无手动tenant_id过滤
- ✅ SonarQube代码质量评级A级
- ✅ 所有TODO项清理完毕

---

### 🟡 第六优先级：监控与运维体系建设（第7周）

**目标**: 完善监控、日志、告警体系

#### 任务详情

1. **日志体系完善**
   - 统一日志格式（JSON格式）
   - 添加 `logstash-logback-encoder` 依赖
   - 配置 `logback-spring.xml`
   - 日志级别规范（ERROR/WARN/INFO/DEBUG）
   - 敏感信息脱敏（手机号、身份证、支付信息）
   - ELK日志收集配置
   - **预计时间**: 12小时

2. **Prometheus监控增强**
   - 业务指标暴露：
     * 订单创建数：`evcs_order_created_total`
     * 订单成功率：`evcs_order_success_rate`
     * 充电桩在线率：`evcs_charger_online_rate`
     * 支付成功率：`evcs_payment_success_rate`
   - 自定义Metrics（@Counted, @Timed）
   - **预计时间**: 6小时

3. **Grafana Dashboard**
   - 系统总览Dashboard（服务健康、QPS、响应时间）
   - 业务监控Dashboard（订单趋势、充电桩状态、营收统计）
   - 告警规则配置
   - **预计时间**: 8小时

4. **健康检查与熔断**
   - 深度健康检查（数据库、Redis、RabbitMQ）
   - Resilience4j熔断器配置
   - 服务降级策略
   - **预计时间**: 8小时

**验收标准**:
- ✅ 日志可在Kibana正常查询
- ✅ Prometheus可抓取所有自定义指标
- ✅ Grafana Dashboard可视化效果良好

---

### 🔴 第七优先级：测试、文档与发布准备（第8周）

**目标**: 全面测试，完善文档，准备发布

#### 任务详情

1. **单元测试补充**
   - Service层单元测试（目标覆盖率80%）
   - Controller层单元测试（MockMvc测试）
   - Util工具类测试（边界条件 + 异常场景）
   - 运行JaCoCo生成覆盖率报告
   - **预计时间**: 16小时

2. **集成测试**
   - 端到端测试场景（完整充电流程、支付流程、对账流程）
   - 多租户隔离测试
   - 异常场景测试（网络异常、服务异常、并发异常）
   - **预计时间**: 8小时

3. **文档完善**
   - API文档完善（补充所有接口的请求/响应示例）
   - 部署文档更新（生产环境部署指南）
   - 开发者文档（新模块开发指南、代码规范）
   - **预计时间**: 8小时

4. **发布准备与回顾**
   - 版本发布清单检查
   - 灰度发布计划（5% → 20% → 50% → 100%）
   - 回滚预案准备
   - 项目复盘会议
   - **预计时间**: 8小时

**验收标准**:
- ✅ 单元测试覆盖率 ≥ 80%
- ✅ 集成测试全部通过
- ✅ 文档齐全，可供新人快速上手

---

## 三、成功标准

### 功能完整性
- ✅ 所有P0级别问题修复（构建、安全）
- ✅ 所有P1级别功能完成（协议、支付、缓存）
- ✅ 80%以上的P2级别功能完成（前端、监控）
- ✅ 所有TODO项清理完毕

### 性能指标

| 指标 | 目标 | 测量方法 |
|------|------|---------|
| 订单创建接口 | 500 TPS | JMeter压测 |
| 订单查询接口 | 1000 TPS | JMeter压测 |
| 充电桩状态更新 | 2000 TPS | JMeter压测 |
| 接口P99延迟 | < 200ms | Prometheus统计 |
| 数据库连接池使用率 | < 80% | 监控面板 |

### 质量指标

| 指标 | 目标 | 测量方法 |
|------|------|---------|
| 单元测试覆盖率 | ≥ 80% | JaCoCo报告 |
| 代码重复率 | < 5% | SonarQube |
| 代码复杂度 | < 15 | SonarQube |
| 严重Bug数 | 0 | Jira统计 |
| 安全漏洞（高/中危） | 0 | 安全扫描 |

### 运维指标

| 指标 | 目标 | 测量方法 |
|------|------|---------|
| 服务可用性 | ≥ 99.9% | Uptime监控 |
| 故障恢复时间 | < 5分钟 | 事件记录 |
| 日志查询响应 | < 3秒 | Kibana性能 |
| 告警准确率 | ≥ 95% | 告警统计 |

---

## 四、风险管理

### 技术风险

| 风险项 | 概率 | 影响 | 缓解措施 |
|-------|------|------|---------|
| 协议设备不可用 | 中 | 高 | 提前准备模拟器，联系厂商沙箱 |
| 支付沙箱不稳定 | 中 | 中 | 同时对接多个支付渠道 |
| 性能目标未达标 | 低 | 高 | 第4周提前压测，预留优化时间 |
| 前端技术栈不熟悉 | 低 | 中 | 提前培训，使用成熟脚手架 |

### 进度风险

| 风险项 | 概率 | 影响 | 缓解措施 |
|-------|------|------|---------|
| 人员请假/离职 | 低 | 高 | 知识文档化，关键模块双人开发 |
| 需求变更 | 中 | 中 | 需求冻结机制，变更评审流程 |
| 测试周期不足 | 中 | 高 | 第8周专门留作测试，可延长1周 |
| 依赖服务延期 | 低 | 中 | 识别依赖，提前协调 |

### 质量风险

| 风险项 | 概率 | 影响 | 缓解措施 |
|-------|------|------|---------|
| 多租户数据泄漏 | 低 | 极高 | 专项测试，代码审查，安全扫描 |
| 支付数据不一致 | 低 | 高 | 强化事务管理，对账机制 |
| 性能回归 | 中 | 中 | 持续压测，性能基准对比 |
| 文档不完善 | 高 | 中 | 文档与代码同步更新 |

---

## 五、时间规划

### 整体时间表

```
第1周  │ 🔴 环境修复与安全加固 (P0)
       │ ✓ Java 21、Gradle Wrapper、JWT漏洞、租户上下文
       └────────────────────────────────────────────

第2周  │ 🟠 协议事件流对接 (P1)
       │ ✓ OCPP + 云快充 + RabbitMQ + 协议调试
       └────────────────────────────────────────────

第3周  │ ✅ 支付集成（已完成 M3）

第4周  │ 🟡 分布式缓存与性能优化 (P1)
       │ ✓ Redis缓存 + 对账优化 + 数据库优化 + 压测
       └────────────────────────────────────────────

第5周  │ 🟢 前端管理界面开发 (P2)
       │ ✓ Vue 3 + 租户管理 + 充电站管理 + 订单管理
       └────────────────────────────────────────────

第6周  │ 🟢 功能改进与代码质量提升 (P2)
       │ ✓ 租户过滤优化 + 代码质量 + TODO清理
       └────────────────────────────────────────────

第7周  │ 🟡 监控与运维体系建设 (P2)
       │ ✓ 日志 + Prometheus + Grafana + 熔断
       └────────────────────────────────────────────

第8周  │ 🔴 测试、文档与发布准备 (P3)
       │ ✓ 单元测试 + 集成测试 + 文档 + 灰度发布
       └────────────────────────────────────────────
```

### 关键路径
- **必须按顺序**: 第1周（安全）→ 第2周（协议）→ 第8周（测试）
- **可并行执行**: 第4-7周的缓存、前端、监控工作可适当并行
- **弹性调整**: 第8周可延长1周作为缓冲

---

## 六、交付物清单

### 代码交付
- [ ] evcs-protocol 协议服务完整实现
- [ ] evcs-order 订单服务增强（缓存、对账优化）
- [ ] evcs-gateway 安全加固
- [ ] evcs-common 多租户上下文增强
- [ ] evcs-admin 前端管理系统（Vue 3项目）

### 文档交付
- [ ] API文档（Swagger导出）
- [ ] 部署运维手册
- [ ] 开发者指南
- [ ] 测试报告
- [ ] 性能测试报告
- [ ] 安全测试报告
- [ ] 版本发布说明

### 配置交付
- [ ] Docker镜像（所有服务）
- [ ] Kubernetes部署YAML
- [ ] Prometheus监控配置
- [ ] Grafana Dashboard JSON
- [ ] Nginx配置文件
- [ ] 数据库迁移脚本

---

## 七、后续规划（P4阶段展望）

### 功能扩展
- 🔮 用户移动端APP（iOS + Android）
- 🔮 微信小程序 + 支付宝小程序
- 🔮 BI报表与数据大屏
- 🔮 开放平台（第三方ISV接入）

### 技术演进
- 🔮 Kubernetes编排（容器化部署、自动扩缩容）
- 🔮 服务网格（Istio流量管理、灰度发布）
- 🔮 数据中台（统一数据仓库、OLAP分析）
- 🔮 AI能力（充电桩故障预测、负载预测）

### 业务拓展
- 🔮 B端SaaS（多租户SaaS服务）
- 🔮 C端服务（用户会员体系、积分系统）
- 🔮 增值服务（车辆维保、保险、金融）
- 🔮 国际化（多语言、多币种、海外部署）

---

## 八、立即行动建议

### 本周行动（第1周）
1. ✅ **今天**：统一Java版本到21，提交Gradle Wrapper
2. ✅ **明天**：修复JWT白名单路径遍历漏洞
3. ✅ **后天**：完善租户上下文清理机制
4. ✅ **本周末**：代码审查与安全测试

### 下周行动（第2周）
1. ✅ 设计协议事件统一模型
2. ✅ 实现OCPP和云快充协议适配器
3. ✅ 集成RabbitMQ消息队列
4. ✅ 协议联调与压测

### 本月目标
- 完成第1-4周的所有P0和P1任务
- 协议对接、缓存优化、性能压测全部完成
- 为前端开发和监控体系建设打下基础

---

## 九、参考文档

- [详细开发计划](./DEVELOPMENT-PLAN.md)
- [P3每周行动清单](./P3每周行动清单.md)
- [进度与里程碑](./PROGRESS.md)
- [项目路线图](./ROADMAP.md)
- [M3完成总结](./M3-COMPLETION-SUMMARY.md)
- [测试指南](./TESTING-GUIDE.md)

---

**文档维护**: 项目经理  
**最后更新**: 2025-10-11  
**下次评审**: 2025-10-18（第1周结束）

---

## 附录：每日站会模板

**时间**: 每天 9:30（15分钟）  
**参与人**: 全体开发团队

**议程**:
1. 昨天完成的工作（每人1-2分钟）
2. 今天计划的工作（每人1-2分钟）
3. 遇到的阻塞问题（需要帮助的举手）

**站会记录示例**:
```
日期: 2025-10-12（第1周Day1）
参与人: 张三、李四、王五...

张三:
- 昨天: 研究了Java 21的新特性
- 今天: 更新CI/CD配置到Java 21
- 阻塞: 无

李四:
- 昨天: 完成了M3里程碑验收
- 今天: 开始修复JWT白名单漏洞
- 阻塞: 需要确认路径规范化的具体实现方式

王五:
- 昨天: 准备了Gradle Wrapper更新方案
- 今天: 提交Gradle Wrapper JAR到仓库
- 阻塞: 无
```
