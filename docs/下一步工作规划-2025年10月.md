# EVCS Manager 下一步工作规划（2025年10月）

> **规划日期**: 2025-10-12（更新）  
> **当前状态**: M1、M2、M7完成  
> **规划周期**: 剩余4周（第4、5、6、8周）  
> **最新进展**: ✅ 第1周安全加固完成 | ✅ 第2周协议对接完成 | ✅ M7监控体系完成

---

## 🔄 更新说明（2025-10-12）

### 重大进展
本次更新反映了项目的显著进展，三个关键里程碑已完成：

1. **M1（第1周）- 安全加固完成** ✅
   - Java 21环境统一，CI/CD就绪
   - JWT路径遍历漏洞修复（新增12个测试）
   - 租户上下文完善（10,000次并发零泄漏）
   - 31个安全测试全部通过
   - 完成率：94.6%

2. **M2（第2周）- 协议对接完成** ✅
   - 完整的协议事件模型（心跳、状态、充电）
   - RabbitMQ消息队列集成（Topic交换机、DLQ）
   - 事件消费者实现（订单、充电桩）
   - 6个调试REST接口
   - 3份技术文档（33.6KB）
   - 完成率：100%

3. **M7 - 监控体系完成** ✅
   - JSON日志 + 敏感信息脱敏
   - Prometheus指标 + Grafana Dashboard
   - Resilience4j熔断限流
   - ELK日志收集配置
   - 完整监控指南

### 调整内容
- **已完成任务标记**: 第1周、第2周任务全部标记为已完成
- **优先级重排**: 第4周（性能优化）成为当前重点
- **工作量更新**: 剩余约110小时（14个工作日）
- **里程碑更新**: 新增M1、M2详细完成情况
- **行动建议更新**: 立即开始第4周任务

### 下一步重点
🎯 **第4周：分布式缓存与性能优化**（当前重点）
- Redis缓存实现
- 缓存一致性保障
- 对账服务优化
- 数据库性能优化
- 接口性能压测

---

## 一、当前进度概览 📊

### ✅ 已完成里程碑

#### M0-M2: 基础架构（P0/P1）
- ✅ 多租户四层隔离架构
- ✅ 分时计费系统（TOU）
- ✅ 订单管理完整闭环
- ✅ 充电站与充电桩管理
- ✅ Prometheus指标暴露

#### M1: 环境修复与安全加固（✅ 2025-10-11完成）
- ✅ Java 21环境统一
- ✅ JWT路径遍历漏洞修复
- ✅ 租户上下文异常处理增强
- ✅ 租户上下文清理机制完善
- ✅ 全局异常处理器优化
- ✅ 并发安全测试通过（10,000次操作零泄漏）
- ✅ 新增31个安全测试用例

#### M2: 协议事件流对接（✅ 2025-10-12完成）
- ✅ 完整的协议事件模型（心跳、状态、充电开始/停止）
- ✅ RabbitMQ消息队列集成（Topic交换机、死信队列）
- ✅ 协议适配器实现（OCPP、云快充）
- ✅ 订单和充电桩事件消费者
- ✅ 完善的调试工具（6个REST接口）
- ✅ 幂等性保证（sessionId去重）
- ✅ 多租户隔离机制
- ✅ 3份技术文档（33.6KB）

#### M3: 支付集成
- ✅ 支付宝集成（APP + 扫码）
- ✅ 微信支付集成（小程序 + Native）
- ✅ 支付对账功能
- ✅ 集成测试套件

#### M6: 质量提升
- ✅ 集成测试框架
- ✅ 多租户隔离测试
- ✅ 代码质量改进

#### M7: 监控体系（✅ 2025-10-11完成）
- ✅ JSON格式日志 + 敏感信息脱敏
- ✅ Prometheus业务指标框架
- ✅ Grafana Dashboard（系统 + 业务）
- ✅ Resilience4j熔断限流
- ✅ ELK日志收集配置
- ✅ 完整监控指南文档

### ⏳ 待完成任务（P3阶段剩余工作）

#### 第4周：性能优化 🟡（下一个重点）
- Redis缓存: ⏳ 待实现
- 对账优化: ⏳ 待实现分页
- 数据库索引: ⏳ 待优化
- 性能压测: ⏳ 待执行

#### 第5周：前端开发 🟢
- 前端框架: ✅ evcs-admin目录存在（Vue 3）
- 管理界面: ✅ 基础结构完成
- 功能完善: ⏳ 待补充

#### 第6周：代码质量 🟢
- 租户过滤优化: ⏳ 待清理手动过滤
- JSON处理优化: ⏳ 待用Jackson替代手动拼接
- TODO清理: ⏳ 9个TODO待实现

#### 第8周：测试发布 🔴
- 单元测试覆盖率: ~40% → 目标80%
- 集成测试: ⏳ 待补充
- 文档完善: ⏳ 待更新
- 发布准备: ⏳ 待规划

---

## 二、紧急优先级任务（按时间顺序）

### ✅ 第1周：环境修复与安全加固（已完成）

**完成日期**: 2025-10-11  
**完成率**: 94.6%（35/37任务完成）

**已完成任务**:
- ✅ Java 21环境统一
- ✅ CI/CD自动化配置（GitHub Actions）
- ✅ JWT路径遍历漏洞修复（新增12个测试）
- ✅ 租户上下文异常处理增强（新增11个测试）
- ✅ 租户上下文清理机制完善
- ✅ 并发安全验证（10,000次操作零泄漏）
- ✅ 全局异常处理器优化
- ✅ 完整的安全加固文档

**关键成果**:
- 构建环境统一，CI/CD就绪
- 所有P0安全漏洞已修复
- 新增31个安全测试用例全部通过
- 租户隔离机制经过严格并发测试

**详细报告**: 见 [WEEK1-COMPLETION-CHECKLIST.md](./WEEK1-COMPLETION-CHECKLIST.md)

---

### ✅ 第2周：协议事件流对接（已完成）

**完成日期**: 2025-10-12  
**完成率**: 100%（21/21任务完成）

**已完成任务**:
- ✅ 完整的协议事件模型（4种事件类型）
- ✅ RabbitMQ消息队列集成（Topic交换机、死信队列）
- ✅ 协议适配器接口定义
- ✅ 订单服务事件消费者（ChargingEventConsumer）
- ✅ 充电桩服务事件消费者（ChargerEventConsumer）
- ✅ 协议调试工具（6个REST接口）
- ✅ 幂等性保证机制（sessionId去重）
- ✅ 多租户隔离实现
- ✅ 3份完整技术文档（33.6KB）

**关键成果**:
- 事件驱动架构完全解耦
- 消息可靠性多层保障
- 协议扩展性强，易于对接新协议
- 完善的调试和监控工具
- 齐全的开发和运维文档

**技术文档**:
- [协议事件模型说明.md](./协议事件模型说明.md)
- [协议对接指南.md](./协议对接指南.md)
- [协议故障排查手册.md](./协议故障排查手册.md)

**详细报告**: 见 [WEEK2-COMPLETION-SUMMARY.md](./WEEK2-COMPLETION-SUMMARY.md)

---

### 🟡 第4周：分布式缓存与性能优化（当前重点）


**为什么重要**:
- 计费计划频繁查询，需要缓存
- 多实例部署需要缓存一致性
- 对账服务处理大量数据，需要优化

**核心任务清单**:

#### 任务1: Redis分布式缓存 🚀 优先级P1
**缓存键设计**:
```java
// 计费计划缓存
billing:plan:{stationId}:{planId}  // 特定计费计划
billing:plan:default:{stationId}   // 默认计费计划
```

**缓存服务实现**:
```java
@Service
public class BillingPlanCacheService {
    
    private final RedisTemplate<String, BillingPlan> redisTemplate;
    private final BillingPlanService billingPlanService;
    
    public BillingPlan getByStationAndId(Long stationId, Long planId) {
        String key = String.format("billing:plan:%d:%d", stationId, planId);
        
        // 尝试从缓存获取
        BillingPlan plan = redisTemplate.opsForValue().get(key);
        if (plan != null) {
            return plan;
        }
        
        // 缓存未命中，从数据库加载
        plan = billingPlanService.getById(planId);
        if (plan != null && plan.getStationId().equals(stationId)) {
            // 写入缓存，TTL=1小时
            redisTemplate.opsForValue().set(key, plan, 1, TimeUnit.HOURS);
        }
        
        return plan;
    }
}
```

**预计时间**: 6小时  
**验收标准**: 缓存命中率≥80%

---

#### 任务2: Redis Pub/Sub广播 📡 优先级P1
**场景**: 管理员修改计费计划，需要通知所有实例清理缓存

**广播实现**:
```java
// 发布者（计费计划更新时）
@Service
public class BillingPlanService {
    
    private final RedisTemplate<String, String> redisTemplate;
    
    public void updatePlan(BillingPlan plan) {
        // 更新数据库
        billingPlanMapper.updateById(plan);
        
        // 发布广播消息
        String message = String.format("billing:plan:update:%d:%d", 
            plan.getStationId(), plan.getId());
        redisTemplate.convertAndSend("billing:plan:update", message);
    }
}

// 订阅者（各实例监听）
@Component
public class BillingPlanCacheInvalidator implements MessageListener {
    
    private final RedisTemplate<String, BillingPlan> redisTemplate;
    
    @Override
    public void onMessage(Message message, byte[] pattern) {
        String msg = new String(message.getBody());
        // 解析消息: billing:plan:update:stationId:planId
        String[] parts = msg.split(":");
        Long stationId = Long.parseLong(parts[3]);
        Long planId = Long.parseLong(parts[4]);
        
        // 清理本地缓存
        String key = String.format("billing:plan:%d:%d", stationId, planId);
        redisTemplate.delete(key);
    }
}
```

**预计时间**: 6小时  
**验收标准**: 多实例缓存一致性测试通过

---

#### 任务3: 对账服务优化 🔧 优先级P1
**现状**: `ReconciliationService.runDaily()` 一次性加载所有订单，可能OOM

**分页优化**:
```java
@Service
public class ReconciliationServiceImpl {
    
    public ReconcileResult runDaily(LocalDate date) {
        int pageSize = 1000;
        int pageNum = 1;
        int totalProcessed = 0;
        
        while (true) {
            // 分页查询订单
            Page<ChargingOrder> page = orderMapper.selectPage(
                new Page<>(pageNum, pageSize),
                new QueryWrapper<ChargingOrder>()
                    .between("start_time", date.atStartOfDay(), date.atTime(23, 59, 59))
                    .eq("status", OrderStatus.COMPLETED.getValue())
            );
            
            if (page.getRecords().isEmpty()) {
                break;
            }
            
            // 批量处理
            page.getRecords().forEach(order -> {
                reconcileOrder(order);
            });
            
            totalProcessed += page.getRecords().size();
            pageNum++;
            
            log.info("对账进度: {}/{}", totalProcessed, page.getTotal());
        }
        
        return ReconcileResult.builder()
            .date(date)
            .totalCount(totalProcessed)
            .build();
    }
}
```

**预计时间**: 4小时  
**验收标准**: 处理100万订单无OOM

---

#### 任务4: 数据库优化 🗄️ 优先级P1
**慢查询分析**:
```sql
-- 启用慢查询日志
ALTER SYSTEM SET log_min_duration_statement = 500;

-- 查看TOP 10慢查询
SELECT query, calls, total_time, mean_time
FROM pg_stat_statements
ORDER BY mean_time DESC
LIMIT 10;
```

**添加索引**:
```sql
-- 订单表索引
CREATE INDEX idx_tenant_start_time 
ON charging_order(tenant_id, start_time);

CREATE INDEX idx_charger_status 
ON charging_order(charger_id, status);

-- 充电桩表索引
CREATE INDEX idx_station_status 
ON charger(station_id, status);

-- 计费计划表索引
CREATE INDEX idx_station_valid 
ON billing_plan(station_id, valid_from, valid_to);
```

**预计时间**: 6小时  
**验收标准**: 慢查询减少80%

---

#### 任务5: 性能压测 🎯 优先级P1
**压测目标**:
- 订单创建: 500 TPS
- 订单查询: 1000 TPS
- 充电桩状态更新: 2000 TPS

**JMeter场景**:
```xml
<ThreadGroup name="订单创建">
    <numThreads>50</numThreads>
    <rampUp>10</rampUp>
    <HTTPSampler path="/api/order/start"/>
</ThreadGroup>

<ThreadGroup name="订单查询">
    <numThreads>100</numThreads>
    <rampUp>10</rampUp>
    <HTTPSampler path="/api/order/list"/>
</ThreadGroup>
```

**监控指标**:
- P50/P95/P99响应时间
- 错误率
- CPU/内存使用率
- 数据库连接池使用率

**预计时间**: 8小时  
**验收标准**: 所有指标达标

---

**第4周总结**:
- 总工作量: 约30小时
- 验收标准:
  - ✅ 缓存一致性测试通过
  - ✅ 对账处理百万级数据无OOM
  - ✅ 慢查询减少80%
  - ✅ 性能指标达标

---

### 🟢 第5周：前端管理界面开发

**为什么重要**:
- 提供可视化管理界面
- 提升运营效率
- 完善用户体验

**核心任务清单**:

#### 任务1: 前端功能完善 🎨 优先级P2
**现状**: evcs-admin基础结构已完成（Vue 3 + Vite + Element Plus）

**需要完善的功能**:
1. **租户管理界面**
   - 租户列表（分页、搜索）
   - 租户树形结构展示
   - 租户新增/编辑表单
   - 租户详情页

2. **充电站管理界面**
   - 充电站列表（卡片/列表视图切换）
   - 地图展示（高德地图集成）
   - 充电站详情页
   - 充电桩实时状态监控

3. **订单管理界面**
   - 订单列表（高级搜索）
   - 订单详情页（充电时间轴）
   - 订单统计Dashboard
   - 导出Excel功能

4. **计费配置界面**
   - 计费计划列表
   - 分段可视化编辑器
   - 24小时时间轴预览

**预计时间**: 20小时  
**验收标准**: 所有核心功能可用，响应式设计良好

---

### 🟢 第6周：代码质量提升

**为什么重要**:
- 提升代码可维护性
- 减少技术债务
- 统一代码风格

**核心任务清单**:

#### 任务1: 移除手动租户过滤 🧹 优先级P2
**问题**: 部分代码手动添加 `WHERE tenant_id = ?`，与MyBatis Plus自动过滤冲突

**清理范围**:
```java
// 查找所有手动过滤的代码
// evcs-order/src/**/*.java
// evcs-station/src/**/*.java
// evcs-tenant/src/**/*.java

// 删除类似代码:
wrapper.eq("tenant_id", TenantContext.getCurrentTenantId())
```

**预计时间**: 4小时

---

#### 任务2: JSON处理优化 📝 优先级P2
**问题**: 手动拼接JSON字符串，可能导致格式错误

**修复方案**:
```java
// 替换前:
String body = "{\"code\":401,\"message\":\"" + message + "\"}";

// 替换后:
Result<?> result = Result.error(401, message);
String body = objectMapper.writeValueAsString(result);
```

**预计时间**: 4小时

---

#### 任务3: TODO清理 ✅ 优先级P2
**9个TODO项**:
1. `UserServiceImpl.refreshToken()` - Token刷新
2. `AuthController.getCurrentUser()` - 获取当前用户
3. 充电桩事件机制 - 使用Spring Event
4. DataScope权限检查 - 基于角色
5. 租户类型和祖级路径查询
6. 租户业务数据检查
7. 站点检查逻辑
8. RequestId Filter
9. 其他零散TODO

**预计时间**: 12小时  
**验收标准**: 所有TODO清理完成

---

**第6周总结**:
- 总工作量: 约20小时
- 验收标准:
  - ✅ 无手动tenant_id过滤
  - ✅ SonarQube代码质量A级
  - ✅ 所有TODO清理完成

---

### 🔴 第8周：测试与发布准备

**为什么最重要**:
- 确保质量
- 准备生产发布
- 项目交付

**核心任务清单**:

#### 任务1: 单元测试补充 🧪 优先级P1
**目标**: 覆盖率从~40%提升到≥80%

**重点测试**:
- Service层业务逻辑
- Controller层参数验证
- Util工具类边界条件
- 多租户隔离测试

**预计时间**: 16小时

---

#### 任务2: 集成测试 🔗 优先级P1
**端到端场景**:
1. 完整充电流程（开始→充电→结束→支付→对账）
2. 支付流程（下单→支付→回调→完成）
3. 多租户隔离（租户A数据对租户B不可见）

**预计时间**: 8小时

---

#### 任务3: 文档完善 📚 优先级P1
**需要更新的文档**:
1. API文档（Swagger导出）
2. 部署运维手册（Docker + K8s）
3. 开发者指南（新模块开发、代码规范）
4. 故障排查手册（常见问题FAQ）

**预计时间**: 8小时

---

#### 任务4: 发布准备 🚀 优先级P1
**清单检查**:
- ✅ 代码审查完成
- ✅ 测试用例通过
- ✅ 文档更新完成
- ✅ 性能测试达标
- ✅ 安全扫描通过

**灰度发布计划**:
- Day 1: 5%流量
- Day 2: 20%流量
- Day 3: 50%流量
- Day 4: 100%全量

**预计时间**: 8小时

---

**第8周总结**:
- 总工作量: 约40小时
- 验收标准:
  - ✅ 单元测试覆盖率≥80%
  - ✅ 集成测试全部通过
  - ✅ 文档齐全
  - ✅ 发布清单完成

---

## 三、关键风险与应对策略 ⚠️

### 风险1: 时间不足
**概率**: 中  
**影响**: 高  
**应对**: 
- 优先完成P0/P1任务
- P2任务可延期到下一阶段
- 第8周可延长1周作为缓冲

### 风险2: 协议设备不可用
**概率**: 中  
**影响**: 高  
**应对**: 
- 提前准备OCPP模拟器
- 联系云快充厂商获取沙箱
- 使用协议调试工具模拟

### 风险3: 性能目标未达标
**概率**: 低  
**影响**: 高  
**应对**: 
- 第4周提前压测
- 预留优化时间
- 必要时降低部分指标

### 风险4: 多租户数据泄漏
**概率**: 低  
**影响**: 极高  
**应对**: 
- 专项安全测试
- 代码审查重点关注
- 增加并发测试场景

---

## 四、成功标准 🎯

### 功能完整性
- ✅ P0级别问题100%修复
- ✅ P1级别功能100%完成
- ✅ P2级别功能80%+完成

### 性能指标
| 指标 | 目标 | 测量方法 |
|------|------|---------|
| 订单创建接口 | 500 TPS | JMeter压测 |
| 订单查询接口 | 1000 TPS | JMeter压测 |
| 充电桩状态更新 | 2000 TPS | JMeter压测 |
| 接口P99延迟 | < 200ms | Prometheus |

### 质量指标
| 指标 | 目标 | 测量方法 |
|------|------|---------|
| 单元测试覆盖率 | ≥ 80% | JaCoCo |
| 代码重复率 | < 5% | SonarQube |
| 严重Bug数 | 0 | Jira |
| 安全漏洞 | 0高/中危 | 安全扫描 |

### 运维指标
| 指标 | 目标 | 测量方法 |
|------|------|---------|
| 服务可用性 | ≥ 99.9% | Uptime监控 |
| 故障恢复时间 | < 5分钟 | 事件记录 |

---

## 五、每周交付物清单 📦

### 第1周
- [ ] Java 21环境配置文档
- [ ] JWT安全修复代码
- [ ] 租户上下文增强代码
- [ ] 安全测试报告

### 第2周
- [ ] 协议事件模型代码
- [ ] RabbitMQ配置文件
- [ ] 协议适配器实现
- [ ] 协议对接文档

### 第4周
- [ ] Redis缓存服务代码
- [ ] 对账优化代码
- [ ] 数据库索引DDL脚本
- [ ] 性能测试报告

### 第5周
- [ ] 前端管理界面代码
- [ ] 前端部署文档

### 第6周
- [ ] 代码质量改进提交
- [ ] SonarQube扫描报告
- [ ] TODO清理清单

### 第8周
- [ ] 单元测试代码（覆盖率≥80%）
- [ ] 集成测试代码
- [ ] 完整API文档
- [ ] 部署运维手册
- [ ] 发布Checklist

---

## 六、建议的工作流程 🔄

### 每日工作流程
1. **09:00 - 09:15** 站会（昨天完成、今天计划、阻塞问题）
2. **09:15 - 12:00** 编码时间（2-3小时专注编码）
3. **12:00 - 13:30** 午休
4. **13:30 - 15:00** 继续编码
5. **15:00 - 16:00** 代码审查/测试
6. **16:00 - 17:00** 文档更新/学习时间
7. **17:00 - 17:30** 日报提交

### 每周工作流程
- **周一**: 周计划制定，任务分配
- **周二-周四**: 专注开发，代码审查
- **周五**: 集成测试，周报总结
- **周末**: 可选加班（紧急情况）

---

## 七、立即行动建议 🚀

### 本周（2025-10-14 - 2025-10-18）
- [ ] 开始第4周：分布式缓存与性能优化
- [ ] 实现Redis缓存服务（计费计划）
- [ ] 实现Redis Pub/Sub缓存广播
- [ ] 优化对账服务（分页处理）

### 下周（2025-10-21 - 2025-10-25）
- [ ] 完成数据库查询优化（慢查询分析、索引添加）
- [ ] 执行接口性能压测（500-2000 TPS）
- [ ] 开始第5周：前端管理界面开发

### 本月剩余时间（2025-10-26 - 2025-10-31）
- [ ] 完成前端管理界面核心功能
- [ ] 开始第6周：代码质量提升
- [ ] 移除手动tenant_id过滤
- [ ] JSON处理优化
- [ ] TODO清理

---

## 八、参考文档 📚

### 项目规划文档
- [下一步行动计划](./下一步行动计划.md) - 详细8周计划
- [P3每周行动清单](./P3每周行动清单.md) - 每周任务清单
- [PROGRESS.md](./PROGRESS.md) - 进度跟踪
- [ROADMAP.md](./ROADMAP.md) - 项目路线图

### 技术文档
- [DEVELOPMENT-PLAN.md](./DEVELOPMENT-PLAN.md) - 开发计划
- [TECHNICAL-DESIGN.md](./TECHNICAL-DESIGN.md) - 技术设计
- [MONITORING-GUIDE.md](./MONITORING-GUIDE.md) - 监控指南
- [TESTING-GUIDE.md](./TESTING-GUIDE.md) - 测试指南

### 完成总结
- [M3-COMPLETION-SUMMARY.md](./M3-COMPLETION-SUMMARY.md) - 支付集成完成
- [M7-COMPLETION-SUMMARY.md](./M7-COMPLETION-SUMMARY.md) - 监控体系完成

---

## 九、联系方式 📞

**项目经理**: [待填写]  
**技术负责人**: [待填写]  
**下次评审**: 2025-10-18（第1周结束）

---

## 十、总结 📝

### 核心要点
1. ✅ **第1周（安全加固）已完成**，构建环境统一，安全漏洞全部修复
2. ✅ **第2周（协议对接）已完成**，事件驱动架构就绪，协议扩展性强
3. ✅ **M7（监控体系）已完成**，日志、监控、告警体系完整
4. 🎯 **第4周（性能优化）是当前重点**，缓存、优化、压测是关键
5. **第5-6周（前端与代码质量）**，提升用户体验和代码可维护性
6. **第8周（测试发布）是最终保障**，确保质量和稳定性

### 工作量预估（剩余）
- ✅ 第1周: 14小时（已完成）
- ✅ 第2周: 34小时（已完成）
- 第4周: 30小时（待完成）
- 第5周: 20小时（待完成）
- 第6周: 20小时（待完成）
- 第8周: 40小时（待完成）
- **已完成**: 48小时
- **剩余**: 约110小时（约14个工作日）

### 关键成功因素
1. ✅ **安全第一**: P0问题已全部解决，安全基础牢固
2. ✅ **小步快跑**: 前两周按计划完成，交付物齐全
3. **质量保证**: 代码审查 + 测试 + 文档同步更新（持续进行）
4. **性能优先**: 第4周性能优化是生产就绪的关键
5. **风险管理**: 提前识别风险，准备应对方案
6. **团队协作**: 及时沟通，遇到问题立即寻求帮助

### 最新进展总结
- ✅ **M1完成**: 环境统一、安全加固、并发测试通过
- ✅ **M2完成**: 协议事件流就绪、消息队列集成、文档齐全
- ✅ **M7完成**: 监控体系完整、日志脱敏、Dashboard上线
- 🎯 **下一个里程碑**: M4（性能优化完成）

---

**文档维护人**: GitHub Copilot  
**创建日期**: 2025-10-11  
**最后更新**: 2025-10-12  
**版本**: v2.0（根据M1、M2、M7完成情况更新）

---

**祝项目顺利！🎉**
