# 产品需求文档（PRD）

## 1. 目标
面向多租户的电动汽车充电站管理平台，提供充电站/充电桩管理、分时电价计费、订单与支付闭环、协议接入、监控告警等能力，满足中大型运营商的规模化部署与运营。

## 2. 用户与角色
- 平台方（超级管理员）：管理全局配置、租户、字典等
- 运营商（租户管理员）：管理本租户及子租户资源
- 场站管理员：管理充电站/充电桩、计费方案
- 客服/风控：查看订单、异常、对账

## 3. 核心业务需求
### 3.1 多租户与权限
- 租户层级：父子层级管理
- 四层隔离：数据库行级、SQL拦截、服务 @DataScope、API 鉴权

### 3.2 充电站与充电桩
- 站点层级与地理位置管理，支持附近检索
- 充电桩绑定站点、状态管理、心跳与离线判定

### 3.3 分时电价（TOU）计费
- 用户可自行设置每日分时计费时段
- 每天最多 96 个时段；每个时段有独立的 起始时间/截止时间、电费单价、服务费单价
- 时段数量由用户自定义；支持跨午夜
- 每个电站最多可设置 16 组分时电价/服务费方案（计费计划）
- 可将不同充电桩绑定到指定的分时计费组进行计费
- 计费时段应无重叠且时间连续性可校验（可配置是否覆盖满全天）

### 3.4 订单闭环
- 协议事件驱动：开始充电（创建/幂等）、结束充电（完成/幂等，触发计费）
- 订单状态流转：待支付/已支付/取消/退款中/已退款
- 订单分页查询、会话维度查询

### 3.5 支付与对账
- 支付渠道预留（支付宝/微信/网联），回调幂等
- 每日离线一致性校验（对账巡检）：
  - 无效时间段（end <= start）
  - 负金额
  - 缺失结束时间

### 3.6 监控与指标
- 暴露基础健康检查/指标（Prometheus），覆盖核心路径

## 4. 非功能需求
- 可用性：核心接口 99.9%
- 性能：按站点 5000 枪规模设计
- 可观测性：日志、指标、告警完整
- 安全：多租户隔离、权限精细化

## 5. 验收标准（P0/P1）
- P0：
  - 多租户隔离端到端生效
  - 分时计费计划（96 段上限、16 组/站点、桩与计划绑定）可配置并计费生效
  - 订单开始/结束闭环雏形与幂等
- P1：
  - 订单分页查询
  - 每日对账巡检接口
  - 指标暴露与构建通过

