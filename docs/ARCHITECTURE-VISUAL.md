# EVCS Manager 架构可视化

> 快速了解充电站管理平台的核心架构

---

## 1. 总体架构视图

```
┌────────────────────────────────────────────────────────────────┐
│                         客户端层                                  │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐       │
│  │ Web后台  │  │ 移动App  │  │ 第三方   │  │ 充电桩   │       │
│  │ 管理端   │  │ 用户端   │  │ 系统     │  │ 设备     │       │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘       │
└────────────────────────────────────────────────────────────────┘
                            ↓
┌────────────────────────────────────────────────────────────────┐
│                      API 网关层                                  │
│  ┌──────────────────────────────────────────────────────────┐ │
│  │  evcs-gateway (Spring Cloud Gateway)                    │ │
│  │  • 路由转发  • 认证鉴权  • 限流熔断  • 负载均衡           │ │
│  └──────────────────────────────────────────────────────────┘ │
└────────────────────────────────────────────────────────────────┘
                            ↓
┌────────────────────────────────────────────────────────────────┐
│                       微服务层                                   │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐       │
│  │  Auth    │  │  Tenant  │  │ Station  │  │  Order   │       │
│  │ 认证授权 │  │  租户    │  │ 充电站   │  │  订单    │       │
│  │          │  │  管理    │  │ 管理     │  │  管理    │       │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘       │
│                                                                 │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐       │
│  │ Payment  │  │ Protocol │  │Monitoring│  │Integration│      │
│  │  支付    │  │  协议    │  │  监控    │  │  集成    │       │
│  │  集成    │  │  处理    │  │  告警    │  │  服务    │       │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘       │
└────────────────────────────────────────────────────────────────┘
                            ↓
┌────────────────────────────────────────────────────────────────┐
│                    公共组件层 (Common)                           │
│  ┌────────────────────────────────────────────────────────┐   │
│  │ • 多租户框架 (TenantContext, TenantInterceptor)        │   │
│  │ • 数据权限 (@DataScope, DataScopeAspect)               │   │
│  │ • 统一响应 (Result, PageResult)                        │   │
│  │ • 统一异常 (BusinessException, GlobalExceptionHandler) │   │
│  │ • 基础实体 (BaseEntity) • 工具类 (JwtUtil)             │   │
│  └────────────────────────────────────────────────────────┘   │
└────────────────────────────────────────────────────────────────┘
                            ↓
┌────────────────────────────────────────────────────────────────┐
│                      基础设施层                                  │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐       │
│  │PostgreSQL│  │  Redis   │  │ RabbitMQ │  │ Config   │       │
│  │  数据库  │  │  缓存    │  │ 消息队列 │  │ 配置中心 │       │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘       │
└────────────────────────────────────────────────────────────────┘
```

---

## 2. 四层多租户隔离架构 ⭐

这是系统最核心的架构设计！

```
┌─────────────────────────────────────────────────────────┐
│  第 4 层：API 层隔离                                      │
│  ┌───────────────────────────────────────────────────┐  │
│  │  Spring Security + JWT 认证                       │  │
│  │  TenantInterceptor → 提取租户信息 → TenantContext │  │
│  └───────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────┐
│  第 3 层：服务层隔离                                      │
│  ┌───────────────────────────────────────────────────┐  │
│  │  @DataScope 注解 (TENANT / TENANT_HIERARCHY)      │  │
│  │  DataScopeAspect AOP 切面 → 权限检查              │  │
│  └───────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────┐
│  第 2 层：SQL 层隔离                                      │
│  ┌───────────────────────────────────────────────────┐  │
│  │  CustomTenantLineHandler (MyBatis Plus)           │  │
│  │  自动添加: WHERE tenant_id = ?                    │  │
│  │  自动注入: INSERT ... VALUES (..., tenant_id)     │  │
│  └───────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────┐
│  第 1 层：数据库层隔离                                    │
│  ┌───────────────────────────────────────────────────┐  │
│  │  PostgreSQL 行级数据隔离                          │  │
│  │  所有业务表包含 tenant_id 字段                     │  │
│  │  外键约束、索引优化、触发器                        │  │
│  └───────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────┘
```

**工作流程示例**：

```
HTTP 请求 (Authorization: Bearer <JWT>)
    ↓
1. TenantInterceptor 提取租户信息
   → TenantContext.setTenantId(10)
    ↓
2. Controller 方法
   @DataScope(value = TENANT_HIERARCHY)
   public Result<List<Station>> list() {...}
    ↓
3. DataScopeAspect 检查权限
   → 验证当前租户是否有权限
    ↓
4. Service 方法执行
   stationMapper.selectList(null)
    ↓
5. CustomTenantLineHandler 自动改写 SQL
   SELECT * FROM charging_station
   WHERE deleted = 0 AND tenant_id = 10  ← 自动添加
    ↓
6. PostgreSQL 执行查询
   → 返回租户 10 的数据
    ↓
7. TenantContext.clear() 清理上下文
```

---

## 3. 核心业务流程

### 3.1 充电订单完整流程

```
用户发起充电
    ↓
App/扫码 → API网关 → 订单服务
    ├─ 校验用户和充电桩
    ├─ 创建订单 (幂等: session_id)
    └─ 返回订单ID
    ↓
订单服务 → 协议服务 → 充电桩设备
    ├─ OCPP WebSocket
    └─ 云快充 HTTP
    ↓
充电桩开始充电
    ├─ 实时上报状态和数据
    └─ 定时心跳
    ↓
用户停止充电
    ↓
充电桩 → 协议服务 → 订单服务
    └─ 上报充电结束事件
        ├─ 电量: 40 kWh
        ├─ 时长: 120 分钟
        └─ 结束时间
    ↓
订单服务完成订单 (幂等处理)
    ├─ 查询计费方案
    ├─ 调用分时电价引擎 ⭐
    ├─ 计算总金额: 50 元
    └─ 状态: 待支付
    ↓
订单服务 → 支付服务
    └─ 创建支付单
    ↓
用户支付 (支付宝/微信/网联)
    └─ 支付回调 (幂等: trade_id)
    ↓
订单状态: 已支付 ✅
```

### 3.2 分时电价计费流程 ⭐

```
输入
├─ 开始: 2024-01-01 22:00
├─ 结束: 2024-01-02 02:00
└─ 电量: 40 kWh
    ↓
查询计费方案
├─ 优先: 充电桩绑定方案
├─ 其次: 站点默认方案
└─ 回落: 系统基础费率
    ↓
获取 96 个时段
├─ 00:00-08:00 谷: 电0.4元 服0.6元
├─ 08:00-22:00 平: 电0.8元 服0.7元
└─ 22:00-24:00 峰: 电1.2元 服0.8元
    ↓
按自然日切分充电时段
├─ 2024-01-01 22:00~23:59 (2小时)
└─ 2024-01-02 00:00~02:00 (2小时)
    ↓
计算每段电量和费用
├─ 峰时段 (2小时): 20kWh × 2.0 = 40元
└─ 谷时段 (2小时): 20kWh × 1.0 = 20元
    ↓
总费用: 60元 ✅
```

---

## 4. 数据模型核心关系

```
sys_tenant (租户)
  ├── 1:N → sys_user (用户)
  ├── 1:N → charging_station (充电站)
  └── 1:N → billing_plan (计费方案)

charging_station (充电站)
  ├── 1:N → charger (充电桩)
  └── 1:N → billing_plan (站点计费方案)

charger (充电桩)
  ├── N:1 → charging_station (所属充电站)
  ├── N:1 → billing_plan (绑定的计费方案) ⭐
  └── 1:N → charging_order (充电订单)

billing_plan (计费方案)
  └── 1:N → billing_plan_segment (时段，最多96段) ⭐

charging_order (充电订单)
  ├── N:1 → charger (充电桩)
  ├── N:1 → billing_plan (使用的计费方案)
  └── N:1 → sys_user (充电用户)
```

---

## 5. 技术栈总览

```
┌─────────────────────────────────────────────────────┐
│  开发语言                                            │
│  • Java 21 (LTS)                                    │
└─────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────┐
│  后端框架                                            │
│  • Spring Boot 3.2.2                                │
│  • Spring Cloud 2023.0.0                            │
│  • Spring Security 6.x                              │
│  • MyBatis Plus 3.5.6 (多租户插件) ⭐              │
└─────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────┐
│  数据库与中间件                                       │
│  • PostgreSQL 15 (JSONB、数组、触发器)               │
│  • Redis 7 (缓存、分布式锁)                          │
│  • RabbitMQ (消息队列)                               │
└─────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────┐
│  工具与库                                            │
│  • JWT 4.4.0 (Token 认证)                           │
│  • Knife4j 4.4.0 (API 文档)                         │
│  • Hutool 5.8.25 (工具类)                           │
│  • Lombok (简化代码)                                 │
└─────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────┐
│  构建与部署                                          │
│  • Gradle 8.5 (构建工具)                            │
│  • Docker & Docker Compose (容器化)                │
└─────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────┐
│  监控与可观测                                        │
│  • Spring Boot Actuator                             │
│  • Micrometer + Prometheus                          │
│  • Grafana (规划中)                                  │
└─────────────────────────────────────────────────────┘
```

---

## 6. 核心特性亮点

### ⭐ 四层多租户隔离
- 数据库层 → SQL层 → 服务层 → API层
- 自动化程度高，开发友好
- 支持层级租户管理

### ⭐ 分时电价计费 (TOU)
- 最多 96 段/天（15分钟粒度）
- 每站最多 16 组方案
- 充电桩级别绑定
- 自动按时间段分摊电量

### ⭐ 声明式数据权限
```java
@DataScope(value = DataScopeType.TENANT_HIERARCHY)
public List<Station> getStations() { ... }
```

### ⭐ 多协议支持
- OCPP 1.6 (WebSocket)
- 云快充 (HTTP)
- 事件驱动架构

### ⭐ 幂等性设计
- 订单创建幂等 (session_id)
- 订单完成幂等 (session_id + end_time)
- 支付回调幂等 (trade_id)

---

## 7. 快速开始

### 本地开发环境

```bash
# 1. 启动基础服务
docker-compose up -d postgres redis rabbitmq

# 2. 构建项目
chmod +x gradlew
./gradlew build

# 3. 运行服务
./gradlew :evcs-gateway:bootRun
./gradlew :evcs-station:bootRun
./gradlew :evcs-order:bootRun
```

### 访问地址

- API 网关: http://localhost:8080
- API 文档: http://localhost:8080/doc.html
- PostgreSQL: localhost:5432 (evcs_db / evcs_user / evcs_password)
- Redis: localhost:6379
- RabbitMQ 管理界面: http://localhost:15672 (guest/guest)

---

## 8. 更多文档

- **完整架构分析**: [ARCHITECTURE-ANALYSIS.md](./ARCHITECTURE-ANALYSIS.md) - 1500+ 行详细文档
- **产品需求**: [PRODUCT-REQUIREMENTS.md](./PRODUCT-REQUIREMENTS.md)
- **技术方案**: [TECHNICAL-DESIGN.md](./TECHNICAL-DESIGN.md)
- **多租户详解**: [../README-TENANT-ISOLATION.md](../README-TENANT-ISOLATION.md)

---

**架构特点总结**：
- ✅ 技术先进：Java 21、Spring Boot 3.2、PostgreSQL 15
- ✅ 架构清晰：微服务架构、分层设计
- ✅ 安全可靠：四层租户隔离、多重防护
- ✅ 灵活强大：分时电价、多协议支持
- ✅ 易于扩展：微服务架构、水平扩展

---

> 本文档提供EVCS Manager架构的可视化概览，更详细的信息请参阅 [ARCHITECTURE-ANALYSIS.md](./ARCHITECTURE-ANALYSIS.md)
