<?xml version="1.0"?>
<ruleset name="EVCS PMD Ruleset"
         xmlns="http://pmd.sourceforge.net/ruleset/2.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://pmd.sourceforge.net/ruleset/2.0.0 https://pmd.sourceforge.io/ruleset_2_0_0.xsd">

    <description>
        PMD ruleset for EVCS project focusing on code quality, security, and performance.
    </description>

    <!-- Best Practices -->
    <rule ref="category/java/bestpractices.xml">
        <exclude name="UnusedLocalVariable"/>
        <exclude name="UnusedPrivateField"/>
        <exclude name="UnusedPrivateMethod"/>
    </rule>

    <!-- Code Style -->
    <rule ref="category/java/codestyle.xml">
        <exclude name="ShortVariable"/>
        <exclude name="LongVariable"/>
        <exclude name="ShortMethodName"/>
        <exclude name="AtLeastOneConstructor"/>
        <exclude name="CommentDefaultAccessModifier"/>
    </rule>

    <!-- Design -->
    <rule ref="category/java/design.xml">
        <exclude name="LawOfDemeter"/>
        <exclude name="LoosePackageCoupling"/>
        <exclude name="TooManyMethods"/>
    </rule>

    <!-- Error Prone -->
    <rule ref="category/java/errorprone.xml">
        <exclude name="MissingSerialVersionUID"/>
        <exclude name="AvoidLiteralsInIfCondition"/>
    </rule>

    <!-- Multithreading -->
    <rule ref="category/java/multithreading.xml">
        <exclude name="UseConcurrentHashMap"/>
    </rule>

    <!-- Performance -->
    <rule ref="category/java/performance.xml">
        <exclude name="AvoidInstantiatingObjectsInLoops"/>
    </rule>

    <!-- Security -->
    <rule ref="category/java/security.xml"/>

    <!-- Size Violations -->
    <rule ref="category/java/sizelimitations.xml">
        <exclude name="TooManyFields"/>
        <exclude name="TooManyMethods"/>
        <exclude name="ExcessiveClassLength"/>
        <exclude name="ExcessiveMethodLength"/>
        <exclude name="ExcessiveParameterList"/>
    </rule>

    <!-- Unused Code -->
    <rule ref="category/java/unusedcode.xml">
        <exclude name="UnusedPrivateField"/>
        <exclude name="UnusedLocalVariable"/>
        <exclude name="UnusedPrivateMethod"/>
    </rule>

    <!-- Custom Rules for EVCS Project -->
    <rule name="AvoidSystemOutPrintln"
          language="java"
          message="Avoid using System.out.println, use logging framework instead"
          class="net.sourceforge.pmd.lang.rule.XPathRule">
        <description>
            Avoid using System.out.println for logging, use proper logging framework like SLF4J.
        </description>
        <properties>
            <property name="xpath">
                <value>
                    //Expression/PrimaryExpression/PrimaryPrefix/Literal[@Image='System']/
                    following-sibling::*[1]/Literal[@Image='out']/
                    following-sibling::*[1]/Literal[@Image='println']
                </value>
            </property>
        </properties>
        <priority>3</priority>
        <example>
            <![CDATA[
// Bad
System.out.println("Debug message");

// Good
log.info("Debug message: {}", param);
            ]]>
        </example>
    </rule>

    <rule name="ProperServiceAnnotation"
          language="java"
          message="Service classes should be annotated with @Service, @Transactional, and @Slf4j"
          class="net.sourceforge.pmd.lang.rule.XPathRule">
        <description>
            Service classes should follow the standard EVCS annotation pattern.
        </description>
        <properties>
            <property name="xpath">
                <value>
                    //ClassOrInterfaceDeclaration[
                        .//Annotation[(@Image='Service' or @Image='Component')] and
                        not(.//Annotation[@Image='Transactional']) and
                        not(.//Annotation[@Image='Slf4j'])
                    ]
                </value>
            </property>
        </properties>
        <priority>2</priority>
        <example>
            <![CDATA[
// Bad
@Service
public class OrderService {
    // Missing @Transactional and @Slf4j
}

// Good
@Service
@Transactional
@Slf4j
public class OrderService {
    // Proper annotations
}
            ]]>
        </example>
    </rule>

    <rule name="ControllerProperAnnotations"
          language="java"
          message="Controller classes should be annotated with @RestController, @RequestMapping, @Validated, and @Slf4j"
          class="net.sourceforge.pmd.lang.rule.XPathRule">
        <description>
            Controller classes should follow the standard EVCS annotation pattern.
        </description>
        <properties>
            <property name="xpath">
                <value>
                    //ClassOrInterfaceDeclaration[
                        .//Annotation[@Image='RestController'] and
                        (not(.//Annotation[@Image='RequestMapping']) or
                         not(.//Annotation[@Image='Validated']) or
                         not(.//Annotation[@Image='Slf4j']))
                    ]
                </value>
            </property>
        </properties>
        <priority>2</priority>
        <example>
            <![CDATA[
// Bad
@RestController
public class OrderController {
    // Missing @RequestMapping, @Validated, or @Slf4j
}

// Good
@RestController
@RequestMapping("/api/v1/orders")
@Validated
@Slf4j
public class OrderController {
    // Proper annotations
}
            ]]>
        </example>
    </rule>

    <rule name="AvoidHardcodedSensitiveData"
          language="java"
          message="Avoid hardcoding sensitive data like passwords, API keys, or JWT secrets"
          class="net.sourceforge.pmd.lang.rule.XPathRule">
        <description>
            Avoid hardcoding sensitive data in the code.
        </description>
        <properties>
            <property name="xpath">
                <value>
                    //VariableInitializer//Literal[
                        contains(@Image, 'password') or
                        contains(@Image, 'secret') or
                        contains(@Image, 'key') or
                        contains(@Image, 'token')
                    ]
                </value>
            </property>
        </properties>
        <priority>1</priority>
        <example>
            <![CDATA[
// Bad
String password = "admin123";
String jwtSecret = "my-secret-key";

// Good
String password = environment.getProperty("app.password");
String jwtSecret = environment.getProperty("app.jwt.secret");
            ]]>
        </example>
    </rule>

    <rule name="ProperExceptionHandling"
          language="java"
          message="Catch blocks should not be empty and should log exceptions"
          class="net.sourceforge.pmd.lang.rule.XPathRule">
        <description>
            Catch blocks should contain proper exception handling and logging.
        </description>
        <properties>
            <property name="xpath">
                <value>
                    //CatchStatement[not(BlockStatement//Statement)]
                </value>
            </property>
        </properties>
        <priority>3</priority>
        <example>
            <![CDATA[
// Bad
try {
    riskyOperation();
} catch (Exception e) {
    // Empty catch block
}

// Good
try {
    riskyOperation();
} catch (Exception e) {
    log.error("Operation failed", e);
    throw new BusinessException("Operation failed", e);
}
            ]]>
        </example>
    </rule>

    <rule name="TenantContextManagement"
          language="java"
          message="Tenant context should be properly set and cleared in service methods"
          class="net.sourceforge.pmd.lang.rule.XPathRule">
        <description>
            Methods that work with tenant-specific data should properly manage TenantContext.
        </description>
        <properties>
            <property name="xpath">
                <value>
                    //MethodDeclaration[
                        .//Annotation[@Image='Transactional'] and
                        not(.//MethodCall[(@Image='setCurrentTenantId' or @Image='clear')])
                    ]
                </value>
            </property>
        </properties>
        <priority>2</priority>
        <example>
            <![CDATA[
// Bad
@Transactional
public void processOrder() {
    // Missing TenantContext management
}

// Good
@Transactional
public void processOrder() {
    try {
        TenantContext.setCurrentTenantId(getTenantIdFromToken());
        // Process order
    } finally {
        TenantContext.clear();
    }
}
            ]]>
        </example>
    </rule>

</ruleset>