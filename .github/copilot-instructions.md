# EVCS Manager AI Guide
- **Platform**: Spring Boot 3.2.2 + Java 21 multi-tenant EV charging suite; microservices live under `evcs-*` modules with shared foundations in `evcs-common`.
- **Isolation Stack**: Database `tenant_id` column → MyBatis Plus `TenantLineInnerInterceptor` using `CustomTenantLineHandler` (watch `IGNORE_TABLES`) → service-layer `@DataScope` + `DataScopeAspect` → API layer `TenantContext` populated from JWT headers in `evcs-auth`.
- **Tenant Context**: Set `TenantContext.setCurrentTenantId/UserId` before writes, clear in `finally`; `MybatisPlusConfig.CustomMetaObjectHandler` backfills tenant, audit, and soft-delete fields on `BaseEntity` descendants.
- **Service Pattern**: Service implementations extend MyBatis Plus base classes, annotate queries with `@DataScope(TENANT or TENANT_HIERARCHY)` and wrap mutations in `@Transactional`; prefer lambda wrappers over manual SQL so tenant filters apply.
- **Controller Pattern**: Controllers return `Result<T>` from `com.evcs.common.result`, apply `@PreAuthorize` plus `@DataScope`, and use `@Validated`/`@Valid` on request DTOs; map 404/business errors to `Result.fail` with localized messages.
- **Module Roles**: `evcs-station` manages stations/chargers, `evcs-order` orchestrates charging sessions, `evcs-payment` owns channel adapters (Alipay/WeChat), `evcs-protocol` normalizes OCPP & CloudCharge traffic, `evcs-gateway` fronts APIs, `evcs-tenant` handles hierarchy/auth seeds.
- **Protocol Flow**: `evcs-protocol` publishes heartbeat/status/charging events to the topic exchange `evcs.protocol.events`; `evcs-station` consumes heartbeat/status queues for device state and `evcs-order` consumes `evcs.protocol.charging` to open/close orders.
- **Persistence**: Entity mappers live beside entities; configuration in `evcs-common/config/MybatisPlusConfig.java` also enables pagination and optimistic locking. Add new tables with `tenant_id` and update `sql/init.sql` plus module-specific DDL under `sql/`.
- **Security & JWT**: JWT utilities (`evcs-common/util/JwtUtil.java`) derive tenant/user IDs; align new permission strings with the `hasPermission` checks used in controllers and seed them in SQL fixtures.
- **Build**: Use `./gradlew build` for full verification, `./gradlew :module:bootRun` to run a service, and `./gradlew build -x test` for faster compile cycles when tests are unchanged.
- **Infra Startup**: Run `docker-compose -f docker-compose.local.yml up -d postgres redis rabbitmq` (or the scripts in `scripts/`) before launching services so RabbitMQ/Redis/PostgreSQL endpoints resolve.
- **Testing Workflow**: `./gradlew test --continue` runs all suites; for focus, target modules (`./gradlew :evcs-station:test`). Reuse test fixtures in `evcs-common/src/testFixtures` (`BaseServiceTest`, `BaseControllerTest`, `TestDataFactory`) to auto-manage tenant context and rollback.
- **Coverage & Reports**: Generate coverage via `./gradlew test jacocoTestReport` and inspect module-specific reports under `build/reports/jacoco/test/html/index.html`; functional reports live in `build/reports/tests/test/index.html`.
- **Messaging Reliability**: Consumers (e.g., `evcs-order/mq/ChargingEventConsumer`) enforce manual acks and TenantContext wrapping—mirror that pattern for new listeners and guard against duplicate events.
- **Configuration**: Each module keeps YAML under `src/main/resources`; keep shared constants in `evcs-common` and externalize secrets via environment overrides when editing configs.
- **Logging & Tracing**: Classes rely on Lombok `@Slf4j`; request correlation comes from `evcs-common/filter/RequestIdFilter`, so include request/tenant IDs in logs and never use `System.out`.
- **Gradle Conventions**: Root `build.gradle` centralizes dependency versions; register new modules in `settings.gradle` and prefer BOMs already declared.
- **Docs & References**: Architecture deep dives live in `docs/TECHNICAL-DESIGN.md` and tenant specifics in `README-TENANT-ISOLATION.md`; update relevant docs when altering flows.
- **Path Instructions**: Before touching module code, check `.github/instructions/*.instructions.md` for extra guardrails (e.g., station module constraints).
- **Collaboration**: Follow Conventional Commit messages, keep changes scoped per module, and avoid rewriting user-managed files without direction.
- **Clarify Early**: If tenant scope, protocol routing, or payment channel behavior is ambiguous, pause and ask—downstream services depend on those contracts.