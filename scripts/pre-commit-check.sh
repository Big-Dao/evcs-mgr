#!/bin/bash

# EVCSé¡¹ç›®Gité¢„æäº¤æ£€æŸ¥è„šæœ¬
# ç¡®ä¿ä»£ç è´¨é‡ç¬¦åˆé¡¹ç›®è§„èŒƒï¼Œæ”¯æŒAIç¼–ç¨‹åŠ©æ‰‹ç”Ÿæˆçš„ä»£ç 

echo "ğŸ” å¼€å§‹æ‰§è¡Œé¢„æäº¤æ£€æŸ¥..."

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# å‡½æ•°ï¼šæ‰“å°å¸¦é¢œè‰²çš„æ¶ˆæ¯
print_message() {
    local color=$1
    local message=$2
    echo -e "${color}${message}${NC}"
}

# å‡½æ•°ï¼šæ£€æŸ¥å‘½ä»¤æ˜¯å¦å­˜åœ¨
check_command() {
    if ! command -v $1 &> /dev/null; then
        print_message $RED "âŒ é”™è¯¯: $1 å‘½ä»¤æœªå®‰è£…"
        return 1
    fi
    return 0
}

# å‡½æ•°ï¼šæ£€æŸ¥æ˜¯å¦ä¸ºAIç”Ÿæˆä»£ç 
check_ai_generated_code() {
    local file=$1
    if [ -f "$file" ]; then
        # æ£€æŸ¥æ˜¯å¦åŒ…å«AIä»£ç ç”Ÿæˆçš„ç‰¹å¾
        if grep -q -E "(Generated by (Claude|Copilot|AI)|AI-(generated|assisted)|# (Generated|Created) by" "$file"; then
            return 0
        fi
    fi
    return 1
}

# 1. æ£€æŸ¥å¿…è¦çš„å·¥å…·
print_message $YELLOW "ğŸ”§ æ£€æŸ¥å¿…è¦çš„å·¥å…·..."
check_command gradle || exit 1
check_command git || exit 1

# 2. ç»Ÿè®¡AIç”Ÿæˆä»£ç æ–‡ä»¶
print_message $BLUE "ğŸ¤– ç»Ÿè®¡AIç”Ÿæˆçš„ä»£ç æ–‡ä»¶..."
ai_files_count=0
total_files_count=0

# æ£€æŸ¥Javaæ–‡ä»¶
java_files=$(find . -name "*.java" -not -path "./build/*" -not -path "./.gradle/*" -not -path "./.git/*")
for file in $java_files; do
    total_files_count=$((total_files_count + 1))
    if check_ai_generated_code "$file"; then
        ai_files_count=$((ai_files_count + 1))
    fi
done

if [ $total_files_count -gt 0 ]; then
    ai_percentage=$((ai_files_count * 100 / total_files_count))
    print_message $BLUE "ğŸ“Š AIç”Ÿæˆä»£ç : $ai_files_count/$total_files_count ($ai_percentage%)"
else
    print_message $BLUE "ğŸ“Š æœªå‘ç°Javaæ–‡ä»¶"
fi

# 3. è¿è¡Œä»£ç è´¨é‡æ£€æŸ¥
print_message $YELLOW "ğŸ” è¿è¡Œä»£ç è´¨é‡æ£€æŸ¥..."

# æ£€æŸ¥æ˜¯å¦æœ‰ä»£ç è´¨é‡æ£€æŸ¥æ’ä»¶
if ./gradlew tasks --all | grep -q "checkstyleMain"; then
    print_message $YELLOW "ğŸ“ æ£€æŸ¥ä»£ç æ ¼å¼ (Checkstyle)..."
    if ! ./gradlew checkstyleMain > /dev/null 2>&1; then
        print_message $RED "âŒ ä»£ç æ ¼å¼æ£€æŸ¥å¤±è´¥"
        echo "è¯·è¿è¡Œ ./gradlew checkstyleMain æŸ¥çœ‹è¯¦ç»†é”™è¯¯"
        echo "å‚è€ƒè§„èŒƒ: docs/02-development/CODE-QUALITY-CHECKLIST.md"
        exit 1
    else
        print_message $GREEN "âœ… ä»£ç æ ¼å¼æ£€æŸ¥é€šè¿‡"
    fi
else
    print_message $YELLOW "âš ï¸  Checkstyleæ’ä»¶æœªé…ç½®ï¼Œè·³è¿‡ä»£ç æ ¼å¼æ£€æŸ¥"
fi

if ./gradlew tasks --all | grep -q "pmdMain"; then
    print_message $YELLOW "ğŸ“ æ£€æŸ¥ä»£ç è´¨é‡ (PMD)..."
    if ! ./gradlew pmdMain > /dev/null 2>&1; then
        print_message $RED "âŒ PMDä»£ç è´¨é‡æ£€æŸ¥å¤±è´¥"
        echo "è¯·è¿è¡Œ ./gradlew pmdMain æŸ¥çœ‹è¯¦ç»†é”™è¯¯"
        exit 1
    else
        print_message $GREEN "âœ… PMDä»£ç è´¨é‡æ£€æŸ¥é€šè¿‡"
    fi
else
    print_message $YELLOW "âš ï¸  PMDæ’ä»¶æœªé…ç½®ï¼Œè·³è¿‡ä»£ç è´¨é‡æ£€æŸ¥"
fi

if ./gradlew tasks --all | grep -q "spotbugsMain"; then
    print_message $YELLOW "ğŸ› æ£€æŸ¥é™æ€ä»£ç åˆ†æ (SpotBugs)..."
    if ! ./gradlew spotbugsMain > /dev/null 2>&1; then
        print_message $RED "âŒ SpotBugsæ£€æŸ¥å¤±è´¥"
        echo "è¯·è¿è¡Œ ./gradlew spotbugsMain æŸ¥çœ‹è¯¦ç»†é”™è¯¯"
        exit 1
    else
        print_message $GREEN "âœ… SpotBugsæ£€æŸ¥é€šè¿‡"
    fi
else
    print_message $YELLOW "âš ï¸  SpotBugsæ’ä»¶æœªé…ç½®ï¼Œè·³è¿‡é™æ€ä»£ç åˆ†æ"
fi

# 4. è¿è¡Œå•å…ƒæµ‹è¯•
print_message $YELLOW "ğŸ§ª è¿è¡Œå•å…ƒæµ‹è¯•..."
if ! ./gradlew test > /dev/null 2>&1; then
    print_message $RED "âŒ å•å…ƒæµ‹è¯•å¤±è´¥"
    echo "è¯·è¿è¡Œ ./gradlew test æŸ¥çœ‹è¯¦ç»†é”™è¯¯"
    exit 1
else
    print_message $GREEN "âœ… å•å…ƒæµ‹è¯•é€šè¿‡"
fi

# 5. æ£€æŸ¥ä»£ç è¦†ç›–ç‡
print_message $YELLOW "ğŸ“Š æ£€æŸ¥ä»£ç è¦†ç›–ç‡..."
if ./gradlew tasks --all | grep -q "jacocoTestReport"; then
    ./gradlew jacocoTestReport > /dev/null 2>&1

    # æ£€æŸ¥è¦†ç›–ç‡æ˜¯å¦è¾¾æ ‡
    COVERAGE_THRESHOLD=80
    if [ -f "build/reports/jacoco/test/html/index.html" ]; then
        COVERAGE=$(grep -o "Total.*[0-9]*%" build/reports/jacoco/test/html/index.html | grep -o '[0-9]*' | head -1)

        if [ -n "$COVERAGE" ] && [ "$COVERAGE" -ge "$COVERAGE_THRESHOLD" ]; then
            print_message $GREEN "âœ… ä»£ç è¦†ç›–ç‡: ${COVERAGE}% (é˜ˆå€¼: ${COVERAGE_THRESHOLD}%)"
        else
            print_message $YELLOW "âš ï¸  ä»£ç è¦†ç›–ç‡: ${COVERAGE}% (é˜ˆå€¼: ${COVERAGE_THRESHOLD}%)"
            print_message $YELLOW "   å»ºè®®æé«˜æµ‹è¯•è¦†ç›–ç‡åˆ°${COVERAGE_THRESHOLD}%ä»¥ä¸Š"
        fi
    else
        print_message $YELLOW "âš ï¸  æ— æ³•è·å–è¦†ç›–ç‡æ•°æ®"
    fi
else
    print_message $YELLOW "âš ï¸  JaCoCoæ’ä»¶æœªé…ç½®ï¼Œè·³è¿‡è¦†ç›–ç‡æ£€æŸ¥"
fi

# 6. æ£€æŸ¥å¾®æœåŠ¡æ¶æ„è§„èŒƒ
print_message $YELLOW "ğŸ—ï¸ æ£€æŸ¥å¾®æœåŠ¡æ¶æ„è§„èŒƒ..."
architecture_violations=0

# æ£€æŸ¥è·¨æœåŠ¡æ•°æ®åº“è®¿é—®
cross_db_patterns=(
    "Autowired.*Repository.*"
    "@Autowired.*[A-Za-z]*Repository"
    "private.*[A-Za-z]*Repository.*"
)

for pattern in "${cross_db_patterns[@]}"; do
    if grep -r -E "$pattern" --include="*.java" evcs-*/src/main/java/ 2>/dev/null | grep -v evcs-common; then
        architecture_violations=$((architecture_violations + 1))
        print_message $RED "   âŒ å‘ç°å¯èƒ½çš„è·¨æœåŠ¡æ•°æ®åº“è®¿é—®"
    fi
done

# æ£€æŸ¥ç¡¬ç¼–ç æ•æ„Ÿä¿¡æ¯
sensitive_patterns=(
    "password\s*=\s*['\"][^'\"]+['\"]"
    "secret\s*=\s*['\"][^'\"]+['\"]"
    "jwt.*secret"
    "alipay.*appId"
    "wechat.*mchId"
)

found_secrets=false
for pattern in "${sensitive_patterns[@]}"; do
    if grep -r -i -E "$pattern" --include="*.java" --include="*.yml" --include="*.yaml" --include="*.properties" evcs-*/src/main/ 2>/dev/null; then
        print_message $RED "   âŒ å‘ç°å¯èƒ½çš„ç¡¬ç¼–ç æ•æ„Ÿä¿¡æ¯: $pattern"
        found_secrets=true
        architecture_violations=$((architecture_violations + 1))
    fi
done

if [ $architecture_violations -eq 0 ]; then
    print_message $GREEN "âœ… å¾®æœåŠ¡æ¶æ„è§„èŒƒæ£€æŸ¥é€šè¿‡"
else
    print_message $RED "âŒ å‘ç° $architecture_violations ä¸ªæ¶æ„è¿è§„"
    echo "è¯·å‚è€ƒ: docs/02-development/AI-ASSISTANT-GUIDELINES.md"
    exit 1
fi

# 7. æ£€æŸ¥Dockeré…ç½®
print_message $YELLOW "ğŸ³ æ£€æŸ¥Dockeré…ç½®..."
docker_issues=0

# æ£€æŸ¥æ˜¯å¦æœ‰Dockerfile.simpleæ–‡ä»¶ï¼ˆå·²åˆ é™¤ï¼Œä½†åŒé‡ç¡®è®¤ï¼‰
if find . -name "Dockerfile.simple" -type f 2>/dev/null; then
    print_message $RED "   âŒ å‘ç°å·²åˆ é™¤çš„Dockerfile.simpleæ–‡ä»¶"
    docker_issues=$((docker_issues + 1))
fi

# æ£€æŸ¥Dockerfileé…ç½®
for service_dir in evcs-*/; do
    if [ -f "$service_dir/Dockerfile" ]; then
        service_name=$(basename "$service_dir")

        # æ£€æŸ¥æ˜¯å¦ä½¿ç”¨æ­£ç¡®çš„åŸºç¡€é•œåƒ
        if grep -q "eclipse-temurin:21-jre-alpine" "$service_dir/Dockerfile"; then
            print_message $GREEN "   âœ… $service_name ä½¿ç”¨æ­£ç¡®çš„è¿è¡Œæ—¶é•œåƒ"
        else
            print_message $YELLOW "   âš ï¸  $service_name å¯èƒ½æœªä½¿ç”¨æ ‡å‡†è¿è¡Œæ—¶é•œåƒ"
        fi

        # æ£€æŸ¥æ˜¯å¦ä½¿ç”¨ç»Ÿä¸€çš„Gradleç‰ˆæœ¬
        if grep -q "gradle:8.11-jdk21-alpine" "$service_dir/Dockerfile"; then
            print_message $GREEN "   âœ… $service_name ä½¿ç”¨æ­£ç¡®çš„æ„å»ºé•œåƒ"
        else
            print_message $YELLOW "   âš ï¸  $service_name å¯èƒ½æœªä½¿ç”¨æ ‡å‡†æ„å»ºé•œåƒ"
        fi
    fi
done

if [ $docker_issues -eq 0 ]; then
    print_message $GREEN "âœ… Dockeré…ç½®æ£€æŸ¥é€šè¿‡"
else
    print_message $RED "âŒ å‘ç° $docker_issues ä¸ªDockeré…ç½®é—®é¢˜"
    exit 1
fi

# 8. æ£€æŸ¥æ–‡ä»¶å¤§å°é™åˆ¶
print_message $YELLOW "ğŸ“ æ£€æŸ¥æ–‡ä»¶å¤§å°é™åˆ¶..."
MAX_FILE_SIZE=10485760  # 10MB

large_files=$(find . -type f -not -path "./.git/*" -not -path "./build/*" -not -path "./.gradle/*" -not -path "./docs/archive/*" -size +${MAX_FILE_SIZE}c)

if [ -n "$large_files" ]; then
    print_message $RED "âŒ å‘ç°å¤§æ–‡ä»¶ (>10MB):"
    echo "$large_files" | while read file; do
        size=$(du -h "$file" | cut -f1)
        print_message $RED "   $file ($size)"
    done
    exit 1
else
    print_message $GREEN "âœ… æ²¡æœ‰å‘ç°è¶…å¤§æ–‡ä»¶"
fi

# 9. æ£€æŸ¥æäº¤ä¿¡æ¯æ ¼å¼ï¼ˆå¦‚æœæœ‰æäº¤ï¼‰
if git rev-parse --verify HEAD >/dev/null 2>&1; then
    print_message $YELLOW "ğŸ“ æ£€æŸ¥æäº¤ä¿¡æ¯æ ¼å¼..."

    commit_msg=$(git log -1 --pretty=%B)

    # æ£€æŸ¥æäº¤ä¿¡æ¯æ˜¯å¦åŒ…å«å¿…è¦ä¿¡æ¯
    if [[ ! "$commit_msg" =~ ^(feat|fix|docs|style|refactor|test|chore)(\([^)]*\))?: .+ ]]; then
        print_message $RED "âŒ æäº¤ä¿¡æ¯æ ¼å¼ä¸ç¬¦åˆè§„èŒƒ"
        echo "æ ¼å¼è¦æ±‚: type(scope): description"
        echo "ç±»å‹: feat, fix, docs, style, refactor, test, chore"
        exit 1
    else
        print_message $GREEN "âœ… æäº¤ä¿¡æ¯æ ¼å¼æ­£ç¡®"
    fi
fi

# 10. ç”Ÿæˆè´¨é‡æŠ¥å‘Šæ‘˜è¦
print_message $BLUE "ğŸ“‹ è´¨é‡æ£€æŸ¥æ‘˜è¦"
print_message $BLUE "   - Javaæ–‡ä»¶æ€»æ•°: $total_files_count"
print_message $BLUE "   - AIç”Ÿæˆä»£ç : $ai_files_count ($ai_percentage%)"
if [ $architecture_violations -eq 0 ]; then
    print_message $BLUE "   - æ¶æ„è§„èŒƒ: âœ… é€šè¿‡"
else
    print_message $BLUE "   - æ¶æ„è§„èŒƒ: âŒ $architecture_violations ä¸ªé—®é¢˜"
fi
if [ $docker_issues -eq 0 ]; then
    print_message $BLUE "   - Dockeré…ç½®: âœ… é€šè¿‡"
else
    print_message $BLUE "   - Dockeré…ç½®: âŒ $docker_issues ä¸ªé—®é¢˜"
fi

print_message $GREEN "ğŸ‰ æ‰€æœ‰é¢„æäº¤æ£€æŸ¥é€šè¿‡ï¼"
echo "ä»£ç ç¬¦åˆEVCSé¡¹ç›®è§„èŒƒï¼Œå¯ä»¥æäº¤åˆ°Gitä»“åº“ã€‚"
echo ""
echo "ğŸ“š ç›¸å…³æ–‡æ¡£:"
echo "   - AIåŠ©æ‰‹è§„èŒƒ: docs/02-development/AI-ASSISTANT-GUIDELINES.md"
echo "   - ä»£ç è´¨é‡æ¸…å•: docs/02-development/CODE-QUALITY-CHECKLIST.md"
echo "   - é¡¹ç›®ç»“æ„: docs/operations/PROJECT-STRUCTURE.md"